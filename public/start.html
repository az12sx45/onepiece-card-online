<!doctype html>
<html lang="zh-Hant">
<head>
  <!-- å›ºå®šæŒ‡å‘ Render å¾Œç«¯ -->
  <script>
    window.DEFAULT_SERVER = 'https://onepiece-card-online.onrender.com';
  </script>

  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>onepiece å‰å¤§èˆªé“çˆ­éœ¸æˆ° â€” å•Ÿå‹•æµç¨‹ï¼ˆå½±ç‰‡ç‰ˆ + ç­‰å¾…å®¤ + éŸ³æ•ˆï¼‰</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- ===== PWA & Icon é–‹å§‹ ===== -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#121315">
  <link rel="icon" type="image/png" sizes="192x192" href="images/icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="images/icon-512.png">
  <!-- iOS / iPadOS ä¸»ç•«é¢åœ–ç¤ºï¼ˆè‹¥æš«æ™‚æ²’æœ‰ 180x180ï¼Œå¯å…ˆæŒ‡å‘ 512ï¼‰ -->
  <link rel="apple-touch-icon" sizes="180x180" href="images/icon-180.png">
  <link rel="apple-touch-icon" href="images/icon-512.png">
  <!-- ===== PWA & Icon çµæŸ ===== -->

  <style>
    :root{ --bg:#121315; --ink:#eaecee; --brand:#ffb84d; --cover:url("images/cover.jpg"); }
    html,body{height:100%;}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:"Noto Sans TC",system-ui,-apple-system,Segoe UI,Roboto,"PingFang TC","Noto Sans CJK TC",sans-serif;}
    .bg-anim{ position:fixed; inset:0; overflow:hidden; z-index:-1; background: radial-gradient(1200px 800px at 10% 20%, rgba(255,184,77,.08), transparent 60%), radial-gradient(1200px 800px at 90% 80%, rgba(0,158,255,.07), transparent 60%), linear-gradient(180deg,#0f1113 0%,#14171a 100%); }
    .bg-video{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; object-position:center; opacity:.35; filter:contrast(108%) saturate(108%) brightness(95%); pointer-events:none; }
    body.no-video .bg-anim::after{ content:""; position:absolute; inset:-5%; background-image:var(--cover); background-size:cover; background-position:center; opacity:.28; filter:contrast(110%) saturate(110%) blur(.4px); animation:kenburns 18s ease-in-out infinite alternate; mix-blend-mode:screen; }
    @keyframes kenburns{ 0%{transform:scale(1)} 100%{transform:scale(1.08) translate3d(0,-1.2%,0)} }
    .blink{ animation:blink 1.2s ease-in-out infinite; } @keyframes blink{ 0%,100%{opacity:.35} 50%{opacity:1} }
    .card{ background:#0f1113cc; border:1px solid #2a2e33; border-radius:16px; }
    .btn{ padding:.65rem .9rem; border-radius:.8rem; border:1px solid #2a2e33; background:#171a1e; } .btn:hover{ background:#1e2227; }
    .btn-primary{ background:var(--brand); color:#111; border-color:var(--brand); } .btn-primary:hover{ filter:brightness(1.05); }
    .avatar{ width:72px; height:72px; border-radius:999px; overflow:hidden; border:2px solid rgba(255,255,255,.08); background:#0c0e10; flex:none; }
    .avatar, .avatar img{ aspect-ratio:1/1; } .avatar img{ width:100%; height:100%; object-fit:cover; display:block; }
    .avatar.is-active{ border-color:#ffd36a; box-shadow:0 0 0 3px rgba(255,184,77,.25); }
    .avatar:hover{ border-color:#6b7280; }
    .mono{ display:flex; align-items:center; justify-content:center; font-weight:700; font-size:28px; color:#111; background:#ffd36a; }
    .title-wrap{ display:inline-block; perspective:1000px; }
    .title-main, .title-sub{ will-change: transform, opacity, filter; text-shadow: 0 2px 12px rgba(0,0,0,.45), 0 0 1px rgba(0,0,0,.35); }
    @keyframes tiltDrop{ 0%{opacity:0; transform:rotateX(18deg) translateY(-12px) scale(.98)} 100%{opacity:1; transform:rotateX(0) translateY(0) scale(1)} }
    .fx-tiltDrop{ transform-origin:50% 80%; animation:tiltDrop .8s cubic-bezier(.2,.9,.2,1) .1s both; }
    .fx-shine{ position:relative; overflow:hidden; }
    .fx-shine::after{ content:""; position:absolute; inset:0; background:linear-gradient(120deg, transparent 0%, rgba(255,255,255,.0) 35%, rgba(255,211,106,.65) 50%, rgba(255,255,255,.0) 65%, transparent 100%); transform:translateX(-120%); animation:shineSweep 1.6s ease-out .5s both; mix-blend-mode:screen; pointer-events:none; }
    @keyframes shineSweep{ to{ transform:translateX(120%);} }
    @keyframes fadeUp{ 0%{opacity:0; transform:translateY(12px)} 100%{opacity:1; transform:translateY(0)} } .fx-fadeUp{ animation:fadeUp .7s ease-out .15s both; }
    .wave{ --stagger:.06s; --dur:1.4s; --amp:8px; --delayStart:1.2s; }
    .wave .char{ display:inline-block; transform:translateY(0); animation: waveBounce var(--dur) ease-in-out infinite; animation-delay: calc(var(--i) * var(--stagger) + var(--delayStart)); }
    @keyframes waveBounce{ 0%,100%{transform:translateY(0)} 35%{transform:translateY(calc(-1 * var(--amp)))} 70%{transform:translateY(0)} }
    .wave-sm{ --amp:5px; --dur:1.6s; --stagger:.055s; }
    .lock-overlay{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.72); color:#fff; z-index:50; text-align:center; padding:24px; backdrop-filter: blur(6px); }
    .lock-overlay .panel{ background:rgba(17,17,17,.85); border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:18px 20px; max-width:420px; }
    .lock-overlay .icon{ font-size:40px; line-height:1; margin-bottom:10px; }
    @media (orientation: portrait){ .lock-overlay{ display:flex; } body.lock-scroll{ overflow:hidden; } }
    @media (orientation: landscape){ .card{ max-height:86vh; overflow:auto; } .avatar{ width:64px; height:64px; } }
    @media (max-height: 420px) and (orientation: landscape){ .title-main{ font-size: clamp(28px, 6vw, 48px); } .title-sub{ font-size: clamp(18px, 3.6vw, 28px); } .avatar{ width:56px; height:56px; } }
    @media (min-width: 768px) and (max-width: 1024px){ .title-main{ font-size: clamp(48px, 6.4vw, 92px); letter-spacing:.01em; } .title-sub{ font-size: clamp(28px, 3.8vw, 52px); } .wave{ --amp: 8px; } .wave-sm{ --amp: 5px; } }
    @media (min-width: 768px) and (max-width: 1024px) and (orientation: landscape){ .title-main{ font-size: clamp(44px, 5.8vw, 86px); } .title-sub{ font-size: clamp(26px, 3.4vw, 48px); } }
    @media (min-width: 1024px){ .wave{ --amp: 9px; } .wave-sm{ --amp: 6px; } } @media (min-width: 1536px){ .wave{ --amp: 10px; } .wave-sm{ --amp: 7px; } }
    .audio-toggle{ position: fixed; right: 12px; bottom: 12px; z-index: 30; display: flex; align-items: center; gap: 8px; background: rgba(0,0,0,.45); border: 1px solid rgba(255,255,255,.12); border-radius: 999px; padding: 6px 10px; backdrop-filter: blur(6px); }
    .audio-toggle button{ display:flex; align-items:center; justify-content:center; width:28px; height:28px; border-radius:999px; background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.16); }
    .audio-toggle button:hover{ background: rgba(255,255,255,.1); }
    .audio-toggle .vol{ appearance:none; width:120px; height:4px; border-radius:999px; background:#444; }
    .audio-toggle .vol::-webkit-slider-thumb{ appearance:none; width:14px; height:14px; border-radius:999px; background:#ffd36a; border:1px solid #b3831b; }
    @media (max-width: 640px){ .audio-toggle{ gap:6px; padding:6px 8px; } .audio-toggle .vol{ width:86px; } }
  </style>
</head>
<body class="no-video">
  <div class="lock-overlay" id="lockOverlay">
    <div class="panel">
      <div class="icon">ğŸ”„</div>
      <div class="text-lg font-semibold mb-1">è«‹å°‡æ‰‹æ©Ÿæ—‹è½‰è‡³æ©«å‘ä»¥ç²å¾—æœ€ä½³é«”é©—</div>
      <div class="text-sm opacity-80">è‹¥ä»ç„¡æ³•æ—‹è½‰ï¼Œè«‹è§£é–ç•«é¢æ—‹è½‰æˆ–å¾ç€è¦½å™¨é¸å–®é–‹å•Ÿã€Œå…è¨±æ—‹è½‰ã€ã€‚</div>
    </div>
  </div>

  <div class="bg-anim">
    <video id="bgVideo" class="bg-video" autoplay muted loop playsinline preload="auto" poster="images/cover.jpg">
      <source src="videos/start.webm" type="video/webm">
      <source src="videos/start.mp4" type="video/mp4">
    </video>
  </div>

  <div id="root" class="min-h-dvh flex items-center justify-center p-6"></div>

  <script>
    (function initBGVideo(){
      const v = document.getElementById('bgVideo'); if(!v) return;
      const enableVideo = ()=> document.body.classList.remove('no-video');
      const fallback = ()=> document.body.classList.add('no-video');
      v.addEventListener('loadeddata', enableVideo, {once:true});
      v.addEventListener('canplay', enableVideo, {once:true});
      v.addEventListener('error', fallback, {once:true});
      const tryPlay = ()=> v.play().then(enableVideo).catch(fallback);
      window.addEventListener('pointerdown', tryPlay, {once:true});
      window.addEventListener('keydown', tryPlay, {once:true});
      tryPlay();
    })();
    (function orientationGate(){
      const overlay = document.getElementById('lockOverlay');
      function apply(){
        const isPortrait = window.matchMedia("(orientation: portrait)").matches;
        document.body.classList.toggle('lock-scroll', isPortrait);
        if(overlay){ overlay.style.display = isPortrait ? 'flex' : 'none'; }
      }
      window.addEventListener('resize', apply);
      window.addEventListener('orientationchange', apply);
      apply();
    })();
    async function tryLockLandscape(){
      try{ if(screen.orientation && screen.orientation.lock){ await screen.orientation.lock('landscape'); } }catch(e){}
    }
  </script>

  <script type="text/babel" data-presets="env,react">
    const {useState, useEffect, useMemo} = React;
    const ME_KEY = "op_me_id";
    function uid(){ return Math.random().toString(36).slice(2,10); }
    function genRoomId(){
      const letters = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
      let s=""; for(let i=0;i<6;i++) s += letters[Math.floor(Math.random()*letters.length)];
      return s;
    }
    function getMeId(){
      let me = sessionStorage.getItem(ME_KEY);
      if(!me){ me = "me_" + uid(); sessionStorage.setItem(ME_KEY, me); }
      return me;
    }

    function WaveText({ text, className="", small=false }){
      const chars = Array.from(text);
      const waveClass = small ? "wave wave-sm" : "wave";
      return (
        <span className={`${waveClass} ${className}`}>
          {chars.map((ch, idx) => (
            <span className="char" style={{["--i"]: idx}} key={idx}>
              {ch === " " ? "\u00A0" : ch}
            </span>
          ))}
        </span>
      );
    }

    function PressAnyKey({onProceed}){
      useEffect(()=>{
        const h=(e)=>{ e.preventDefault(); onProceed(); tryLockLandscape(); window.__OPAudio?.startAudio(); };
        window.addEventListener('keydown', h, {once:true});
        window.addEventListener('pointerdown', h, {once:true});
        return ()=>{ window.removeEventListener('keydown', h); window.removeEventListener('pointerdown', h); };
      }, [onProceed]);
      return (
        <div className="relative w-full min-h-[92vh] select-none">
          <div className="absolute left-1/2 -translate-x-1/2 top-[60vh] md:top-[58vh] text-center space-y-2">
            <div className="title-wrap">
              <div className="title-main font-black tracking-tight whitespace-nowrap fx-tiltDrop fx-shine text-[clamp(28px,8.2vw,48px)] [@media(orientation:landscape)]:text-[clamp(24px,6.6vw,44px)] md:text-[clamp(52px,5.2vw,96px)] lg:text-[clamp(60px,4.6vw,110px)] xl:text-[clamp(68px,4vw,128px)]"><WaveText text="ONE PIECE" /></div>
              <div className="title-sub font-extrabold text-amber-300 mt-2 fx-fadeUp whitespace-nowrap text-[clamp(16px,5.2vw,28px)] [@media(orientation:landscape)]:text-[clamp(16px,3.6vw,24px)] md:text-[clamp(30px,3.2vw,56px)] lg:text-[clamp(34px,2.8vw,64px)] xl:text-[clamp(38px,2.4vw,72px)]"><WaveText text="å‰å¤§èˆªé“çˆ­éœ¸æˆ°" small /></div>
            </div>
          </div>
          <div className="absolute left-1/2 -translate-x-1/2 text-sm md:text-base text-neutral-200 blink md:bottom-8" style={{bottom:"calc(env(safe-area-inset-bottom, 0px) - 10px)", paddingBottom:0}}>æŒ‰ä»»æ„éµé–‹å§‹ / Press any key</div>
        </div>
      );
    }

    function NameAvatar({defaultName, onDone}){
      const [name,setName]=useState(defaultName||"");
      const [pick,setPick]=useState(1);
      const avatars=useMemo(()=> Array.from({length:30},(_,i)=>`images/avatars/${i+1}.png`), []);
      function handleSubmit(e){
        e.preventDefault();
        const safe=(name||"").trim()||"ç„¡åèˆªæµ·å£«";
        const data={ playerName:safe, playerAvatar:pick, avatarUrl:avatars[pick-1] };
        localStorage.setItem("op_player_profile", JSON.stringify(data));
        onDone(data);
      }
      return (
        <form onSubmit={handleSubmit} className="card w-[min(980px,96vw)] p-5 md:p-6">
          <div className="flex items-center justify-between gap-3 flex-wrap">
            <h2 className="text-xl font-bold">å‰µå»ºè§’è‰²</h2>
            <div className="text-xs text-neutral-400">è³‡æ–™æœƒæš«å­˜æ–¼æœ¬æ©Ÿï¼ˆlocalStorageï¼‰</div>
          </div>
          <div className="grid [@media(orientation:landscape)]:grid-cols-2 md:grid-cols-3 gap-5 mt-4">
            <div className="md:col-span-1">
              <div className="flex items-center gap-3">
                <div className={"avatar "+(pick?"is-active":"")}>
                  <img src={avatars[pick-1]} alt=""
                    onError={(e)=>{
                      e.currentTarget.replaceWith(Object.assign(document.createElement('div'),{
                        className:'mono avatar',
                        innerText:(name||'').slice(0,1)||'ä½ '
                      }));
                    }} />
                </div>
                <div>
                  <div className="text-sm text-neutral-400">ç©å®¶åç¨±</div>
                  <input className="mt-1 w-56 rounded-lg bg-neutral-900 border border-neutral-700 px-3 py-2 outline-none focus:border-amber-400" maxLength={16} placeholder="è¼¸å…¥ä½ çš„åå­—" value={name} onChange={(e)=>setName(e.target.value)} />
                </div>
              </div>
              <div className="text-xs text-neutral-400 mt-2">* åç¨±æœ€å¤š 16 å­—ï¼›å¯ç¨å¾Œåœ¨è¨­å®šä¸­ä¿®æ”¹ã€‚</div>
            </div>
            <div className="md:col-span-2">
              <div className="flex items-center justify-between">
                <div className="font-semibold">é¸æ“‡é ­åƒï¼ˆ30ï¼‰</div>
                <div className="text-xs text-neutral-400">è·¯å¾‘ï¼š<code>images/avatars/1.png ~ 30.png</code></div>
              </div>
              <div className="mt-2 grid grid-cols-5 sm:grid-cols-6 md:grid-cols-7 lg:grid-cols-8 gap-3">
                {avatars.map((src,idx)=>(
                  <button key={idx} type="button" onClick={()=>setPick(idx+1)} className={"avatar "+(pick===idx+1?"is-active":"")}>
                    <img src={src} alt={"avatar-"+(idx+1)} />
                  </button>
                ))}
              </div>
            </div>
          </div>
          <div className="mt-5 flex flex-col sm:flex-row gap-3">
            <button className="btn-primary btn grow" type="submit">å‰µå»ºæˆ¿é–“</button>
            <button className="btn grow" type="button" onClick={()=>{
              const safe=(name||"").trim()||"ç„¡åèˆªæµ·å£«";
              const data={ playerName:safe, playerAvatar:pick, avatarUrl:avatars[pick-1] };
              localStorage.setItem("op_player_profile", JSON.stringify(data));
              onDone(data,{join:true});
            }}>åŠ å…¥æˆ¿é–“</button>
          </div>
        </form>
      );
    }

    function RoomChoice({profile, intent}){
      const [joinCode,setJoinCode]=useState("");
      // ç›´æ¥å°åˆ° game.htmlï¼ˆè·¨è£ç½®é å¾Œç«¯ï¼Œä¸å†ç”¨æœ¬æ©Ÿ localStorage å‡æˆ¿é–“ï¼‰
      function goGame(roomId){
        const url = new URL('game.html', location.origin);
        url.searchParams.set('room', roomId);
        url.searchParams.set('server', window.DEFAULT_SERVER);
        if (profile?.playerName)  url.searchParams.set('name', profile.playerName);
        if (profile?.playerAvatar)url.searchParams.set('avatar', String(profile.playerAvatar));
        url.searchParams.set('n', '4');
        window.location.href = url.toString();
      }
      function createRoom(){
        const id = genRoomId();
        goGame(id);
      }
      function tryJoin(){
        const code=(joinCode||"").toUpperCase().replace(/\s+/g,"");
        if(!code){ alert("è«‹å…ˆè¼¸å…¥æˆ¿è™Ÿ"); return; }
        goGame(code);
      }

      return (
        <div className="card w-[min(820px,96vw)] p-6 space-y-5">
          <div className="flex items-center gap-3">
            <div className="avatar is-active"><img src={profile.avatarUrl} alt=""/></div>
            <div>
              <div className="text-sm text-neutral-400">ç©å®¶</div>
              <div className="text-lg font-bold">{profile.playerName}</div>
            </div>
          </div>

          {!intent?.join ? (
            <div className="grid sm:grid-cols-2 gap-3">
              <button className="btn-primary btn" onClick={createRoom}>å»ºç«‹æˆ¿é–“</button>
              <button className="btn" onClick={()=>window.location.reload()}>è¿”å›é‡é¸</button>
            </div>
          ) : (
            <>
              <div>
                <div className="text-sm text-neutral-300 mb-1">è¼¸å…¥æˆ¿è™ŸåŠ å…¥</div>
                <div className="flex gap-2">
                  <input className="rounded-lg bg-neutral-900 border border-neutral-700 px-3 py-2 outline-none focus:border-amber-400 uppercase tracking-widest" placeholder="ä¾‹å¦‚ ABC123" maxLength={8} value={joinCode} onChange={e=>setJoinCode(e.target.value)} />
                  <button className="btn-primary btn" onClick={tryJoin}>åŠ å…¥æˆ¿é–“</button>
                </div>
              </div>
              <div className="flex gap-3">
                <button className="btn" onClick={()=>window.location.reload()}>è¿”å›é‡é¸</button>
              </div>
            </>
          )}

          <div className="text-xs text-neutral-400">æ­¤æ­¥é©Ÿå·²æ”¹ç‚ºç›´æ¥é€£ç·šå¾Œç«¯ï¼ˆè·¨è£ç½®åŒæ­¥ï¼‰ã€‚</div>
        </div>
      );
    }

    function App(){
      const [stage,setStage]=useState("press");
      const [profile,setProfile]=useState(null);
      const [intent,setIntent]=useState(null);
      const meId=getMeId();

      useEffect(()=>{
        const cached=localStorage.getItem("op_player_profile");
        if(cached){ try{ setProfile(JSON.parse(cached)); }catch{} }
      },[]);

      return (
        <div className="w-full max-w-[1200px] mx-auto">
          <div className="min-h-dvh flex items-center justify-center">
            {stage==="press"   && <PressAnyKey onProceed={()=>setStage("profile")} />}
            {stage==="profile" && <NameAvatar defaultName={profile?.playerName} onDone={(p,i)=>{ setProfile(p); setIntent(i||{}); setStage("choice"); }} />}
            {stage==="choice"  && profile && (<RoomChoice profile={profile} intent={intent} />)}
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
  </script>

  <audio id="sfxIntro" src="audio/intro.mp3" preload="auto" loop autoplay></audio>
  <audio id="bgm" src="audio/bgm.mp3" preload="auto" loop autoplay></audio>

  <div class="audio-toggle" id="audioCtrl" style="display:none">
    <button id="btnMute" title="éœéŸ³/å–æ¶ˆéœéŸ³" aria-label="Mute/Unmute">
      <svg id="icoVol" width="16" height="16" viewBox="0 0 24 24" fill="#ffd36a">
        <path d="M4 9v6h4l5 4V5L8 9H4z"></path>
        <path id="wave" d="M16 8c1.5 1.5 1.5 6.5 0 8" stroke="#ffd36a" stroke-width="2" fill="none"/>
      </svg>
    </button>
    <input id="rngVol" class="vol" type="range" min="0" max="100" step="1" value="65" />
  </div>

  <script>
    (function(){
      const S={ muteKey:"op_audio_mute", volKey:"op_audio_vol", hasStarted:false, fadeTimer:null, autoTried:false };
      const $intro=document.getElementById('sfxIntro');
      const $bgm=document.getElementById('bgm');
      const $wrap=document.getElementById('audioCtrl');
      const $btn=document.getElementById('btnMute');
      const $ico=document.getElementById('icoVol');
      const $wave=document.getElementById('wave');
      const $rng=document.getElementById('rngVol');

      const savedMute=localStorage.getItem(S.muteKey);
      const savedVol=localStorage.getItem(S.volKey);
      let muted=savedMute==="1";
      let vol=isNaN(+savedVol)?20:Math.max(0,Math.min(100,+savedVol));
      setVolume(vol); applyMuteUI(); $wrap.style.display='flex';

      function setVolume(v){
        vol=v; $rng.value=String(v);
        const gain=muted?0:(v/100);
        $bgm.volume=Math.min(1,Math.max(0,gain));
        if($intro) $intro.volume=Math.min(1,Math.max(0,Math.min(0.9,gain*1.2)));
        localStorage.setItem(S.volKey,String(v));
      }
      function fade(el,target,ms){
        clearInterval(S.fadeTimer);
        const stepMs=40, steps=Math.max(1,Math.round(ms/stepMs));
        const start=el.volume; let n=0;
        S.fadeTimer=setInterval(()=>{
          n++; const t=n/steps; el.volume=start+(target-start)*t;
          if(n>=steps){ clearInterval(S.fadeTimer); el.volume=target; }
        }, stepMs);
      }
      function applyMuteUI(){
        const on=!muted;
        $ico.setAttribute('fill', on?'#ffd36a':'#bbb');
        $wave.setAttribute('stroke', on?'#ffd36a':'#bbb');
      }
      async function tryAutoStart(){
        if(S.autoTried||S.hasStarted) return; S.autoTried=true;
        try{ setVolume(vol); await $bgm.play(); if(!muted) $bgm.volume=Math.min(1,vol/100); S.hasStarted=true; }
        catch(e){ S.hasStarted=false; }
      }
      async function startAudioAfterGesture(){
        if(S.hasStarted) return; S.hasStarted=true;
        try{
          $bgm.volume=0; await $bgm.play().catch(()=>{});
          if($intro && $intro.src){
            $intro.currentTime=0; $intro.volume=Math.min(1,(vol/100)*0.9);
            await $intro.play().catch(()=>{});
            $intro.onended=()=>{ if(!muted) fade($bgm, Math.min(1, vol/100), 1200); };
          }else{
            if(!muted) fade($bgm, Math.min(1, vol/100), 800);
          }
        }catch(e){ S.hasStarted=false; }
      }
      $btn.addEventListener('click', ()=>{
        muted=!muted; localStorage.setItem(S.muteKey, muted?"1":"0"); applyMuteUI();
        if(muted){
          fade($bgm,0,250); if($intro && !$intro.paused) fade($intro,0,150);
        }else{
          setVolume(vol); if($bgm.paused){ $bgm.play().catch(()=>{}); }
          fade($bgm, Math.min(1, vol/100), 250);
        }
      });
      $rng.addEventListener('input', (e)=> setVolume(+e.target.value));
      document.addEventListener('DOMContentLoaded', tryAutoStart);
      window.__OPAudio = { startAudio: startAudioAfterGesture, setVolume, mute: ()=>{ if(!muted) $btn.click(); }, unmute: ()=>{ if(muted) $btn.click(); } };
    })();
  </script>
</body>
</html>
