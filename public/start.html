function WaitingRoom({ roomId, profile }){
  const [players, setPlayers] = React.useState([]); // {sid,name,avatar,ready}
  const [hostSid, setHostSid] = React.useState(null);
  const [isReady, setIsReady] = React.useState(false);
  const [mySid, setMySid] = React.useState(null);

  // 你的後端（Render）
  const SERVER = 'https://onepiece-card-online.onrender.com';

  React.useEffect(()=>{
    // 1) 載入對應後端的 socket.io client（避免版本衝突）
    const s = io(SERVER, { transports:['websocket'] });
    setMySid(s.id); // 注意：有些版本 connect 後才會有 s.id，下面有保險

    // 2) 連上就加入等待室
    s.on('connect', ()=>{
      setMySid(s.id);
      const me = JSON.parse(localStorage.getItem('op_player_profile')||'{}');
      s.emit('LOBBY_JOIN', {
        roomId,
        name: me.playerName || profile?.playerName || ('玩家' + String(Math.random()*1000|0)),
        avatar: Number(me.playerAvatar || profile?.playerAvatar) || 1,
        pid: getMeId?.() || null
      });
    });

    // 3) 接收等待室狀態（跨裝置同步）
    s.on('LOBBY_STATE', (st)=>{
      setHostSid(st.hostSid || null);
      setPlayers(Array.isArray(st.players) ? st.players : []);
      // 自己的 ready 狀態
      const mine = (st.players||[]).find(p=>p.sid===s.id);
      if (mine) setIsReady(!!mine.ready);
    });

    // 4) 收到開始 → 一起跳 game.html
    s.on('NAVIGATE_GAME', ({ roomId, serverURL })=>{
      const url = new URL('/game.html', location.origin);
      url.searchParams.set('room', roomId);
      url.searchParams.set('server', serverURL || SERVER);
      window.location.href = url.toString();
    });

    // 清理
    return ()=>{
      try { s.emit('LOBBY_LEAVE', { roomId }); } catch {}
      s.disconnect();
    };
  }, [roomId]);

  const iAmHost = (hostSid && mySid && hostSid === mySid);
  const everyoneReady = players.length>0 && players.every(p=>p.ready);

  function toggleReady(){
    const next = !isReady;
    setIsReady(next);
    const s = io(SERVER); // 取現有連線（簡版保險：再次取會複用同連線）
    s.emit('LOBBY_READY', { roomId, ready: next });
  }

  function startGame(){
    if (!iAmHost || !everyoneReady) return;
    const s = io(SERVER);
    s.emit('LOBBY_START', { roomId, serverURL: SERVER });
  }

  return (
    <div className="card w-[min(860px,96vw)] p-6 space-y-5">
      <div className="text-lg font-bold">等待室（房號：{roomId}）</div>

      <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
        {players.map(p=>(
          <div key={p.sid} className="flex items-center gap-3 rounded-lg border border-neutral-700/60 bg-neutral-900/60 px-3 py-2">
            <img src={profile?.avatarUrl || `./images/avatars/${p.avatar}.png`} className="w-10 h-10 rounded-full object-cover border border-white/10" />
            <div className="flex-1">
              <div className="font-bold text-sm">{p.name}{p.sid===hostSid ? '（房主）':''}</div>
              <div className="text-xs text-neutral-400">{p.ready ? '已準備' : '未準備'}</div>
            </div>
          </div>
        ))}
      </div>

      <div className="flex flex-wrap items-center gap-3">
        <button className={`btn ${isReady?'btn-secondary':'btn-primary'}`} onClick={toggleReady}>
          {isReady ? '取消準備' : '我準備好了'}
        </button>
        <button className="btn" onClick={()=> navigator.clipboard?.writeText(roomId).then(()=>alert('房號已複製')).catch(()=>prompt('複製房號', roomId))}>
          複製房號
        </button>
        <button className="btn" onClick={()=>{
          const link = `${location.origin}/game.html?room=${roomId}&server=${encodeURIComponent(SERVER)}`;
          navigator.clipboard?.writeText(link).then(()=>alert('邀請連結已複製')).catch(()=>prompt('複製邀請連結', link));
        }}>
          複製邀請連結
        </button>
        <div className="grow"></div>
        <button
          className={`btn ${iAmHost && everyoneReady ? 'btn-primary' : 'btn-disabled'}`}
          onClick={startGame}
          disabled={!iAmHost || !everyoneReady}
          title={!iAmHost ? '只有房主可以開始' : (!everyoneReady ? '所有人準備後才能開始':'' )}
        >
          房主開始
        </button>
      </div>

      <div className="text-xs text-neutral-400">
        提示：這裡是伺服器同步的等待室。所有裝置都能看到彼此、切換準備。房主按「開始」後，所有人會同時進入對戰。
      </div>
    </div>
  );
}
