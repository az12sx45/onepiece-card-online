<!-- /result.html -->
<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>è³½å­£çµç®—ï½œå‰å¤§èˆªé“çˆ­éœ¸æˆ°</title>
<style>
:root{
  --bg:#0b1014; --card:#141a1f; --line:#2a3038;
  --text:#e9f0f8; --muted:#9aa5b2; --accent:#ffd36b; --accent2:#ffb84a;
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'Noto Sans TC',sans-serif;
  background:radial-gradient(circle at 50% 30%,#0e141a 0%,#090c10 80%);
  color:var(--text); min-height:100vh;
}
.header{
  position:sticky;top:0;z-index:10;
  background:rgba(16,22,28,.75);
  backdrop-filter:blur(10px);
  border-bottom:1px solid rgba(255,255,255,.08);
}
.wrap{max-width:1280px;margin:0 auto;padding:14px 18px;}
.h1{font-weight:800;letter-spacing:.5px}

/* ç‰ˆå‹ï¼šå·¦ ç©å®¶æ¸…å–® / ä¸­ å‹¾é¸ / å³ çµ±ä¸€æ¸…å–®è¡¨ */
.layout{
  display:grid; gap:18px;
  grid-template-columns: 280px 220px 1fr;
}
@media (max-width: 1180px){
  .layout{ grid-template-columns: 280px 1fr; }
  .metrics{ order:2; }
  .tablewrap{ order:3; }
}
@media (max-width: 860px){
  .layout{ grid-template-columns: 1fr; }
}

/* å¡ç‰‡ */
.card{
  background:rgba(20,24,28,.82);
  border:1px solid rgba(255,255,255,.08);
  border-radius:18px;
  padding:16px;
  backdrop-filter:blur(8px);
  box-shadow:0 6px 16px rgba(0,0,0,.35);
}
.section-title{ font-weight:800; font-size:18px; margin-bottom:8px; }

/* å·¦ï¼šç©å®¶æ¸…å–® */
.player-item{
  display:grid;
  grid-template-columns: 28px minmax(0, 260px) 1fr;  /* rank | avatar+ç¨±è™Ÿ(æ›´å¯¬) | åå­— */
  align-items:start;
  gap:10px;
  padding:10px;
  border:1px solid rgba(255,255,255,.06);
  border-radius:12px;
  background:rgba(255,255,255,.03);
  overflow:hidden;
}

.player-item.top1{
  border-color: rgba(255,211,107,.45);
  background: rgba(255,211,107,.06);
}
.rank-dot{
  width:26px;height:26px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  font-weight:800;font-size:12px;
  color:#0a0d10;background:var(--accent);
}

/* é ­åƒï¼‹é‡‘å¹£ï¼‹æ‡¸è³ï¼‹ç¨±è™Ÿéƒ½æ”¾é€™ä¸€æ¬„ï¼ˆç¸±å‘ï¼‰ */
.avatar-col{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:4px;
  min-width:0;
  width:100%;
}

.avatar{
  width:44px;height:44px;border-radius:50%;
  object-fit:cover;
  background:#2a333d;
  border:1px solid rgba(255,255,255,.18);
}
.avatar-meta{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:2px;
}
.coins{
  color:var(--accent);
  font-weight:800;
  font-variant-numeric:tabular-nums;
  font-size:13px;
}
.player-bounty{
  font-size:10px;
  line-height:1.2;
  max-width:120px;
  text-align:center;
}
.player-bounty-amt{
  font-weight:700;
  letter-spacing:.5px;
  white-space:nowrap;
}

/* åå­—åœ¨å³å´ç¨ç«‹ä¸€æ¬„ */
.pinfo{ line-height:1.2; display:flex; align-items:center; height:100%; }
.pname{ font-weight:700; }

/* ===== ç¨±è™Ÿæ¡†åŸºç¤æ¨£å¼ï¼ˆé…åˆç¤ºç¯„æª” v3ï¼‰ ===== */
.player-title-badge{
  position:relative;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  padding:4px 16px;
  font-size:11px;
  font-weight:800;
  letter-spacing:.5px;
  margin-top:4px;
  text-align:center;
  white-space:nowrap;

  width:100%;
  max-width:260px;
  box-sizing:border-box;
  margin-left:auto;
  margin-right:auto;
}

.player-title-badge span,
.player-title-badge .text{
  position:relative;
  z-index:3;
  white-space:nowrap;
}

/* è®“æ–‡å­—åœ¨å›ºå®šæ¡†è£¡ï¼Œå¤ªé•·å°±ç”¨ ... ä¸è¦æŠŠæ¡†æ’å£ */
.player-title-badge .text{
  display:inline-block;
  max-width:100%;
  overflow:hidden;   /* é˜²æ­¢è·‘å‡ºæ¡†ï¼›JS æœƒç¸®å­— */
}

/* åŸºç¤å‹•ç•« */
@keyframes float{
  0%,100%{transform:translateY(0px);}
  50%{transform:translateY(-3px);}
}
@keyframes pulse{
  0%,100%{filter:brightness(1);}
  50%{filter:brightness(1.18);}
}
@keyframes softGlow{
  0%,100%{opacity:.5;}
  50%{opacity:.95;}
}
@keyframes shine{
  0%{transform:translateX(-130%);opacity:0;}
  20%{opacity:0;}
  40%{transform:translateX(130%);opacity:1;}
  60%{opacity:0;}
  100%{transform:translateX(130%);opacity:0;}
}

/* Tier 1ï¼šæ™®é€šåœ“è§’é•·æ–¹å½¢ */
.tier-1 .player-title-badge{
  border-radius:8px;
  border:1px solid #777c84;
  background:linear-gradient(135deg,#333842,#171920);
  color:#d0d3d8;
  text-shadow:0 0 6px rgba(0,0,0,.8);
}

/* Tier 2ï¼šå…©å´æ–œåˆ‡æ¨™ç±¤ */
.tier-2 .player-title-badge{
  border-radius:999px;
  padding:6px 24px;
  border:1px solid #63d2ff;
  background:linear-gradient(135deg,#1b4d7e,#63d2ff);
  color:#e8f9ff;
  box-shadow:0 0 10px rgba(99,210,255,.6);
  overflow:visible;
}
.tier-2 .player-title-badge::before,
.tier-2 .player-title-badge::after{
  content:"";
  position:absolute;
  top:0; bottom:0;
  width:14px;
  background:inherit;
}
.tier-2 .player-title-badge::before{
  left:-8px;
  transform:skewX(-24deg);
}
.tier-2 .player-title-badge::after{
  right:-8px;
  transform:skewX(24deg);
}

/* Tier 3ï¼šéŠç”²ç‰Œï¼ˆå…­è§’ï¼‰ */
.tier-3 .player-title-badge{
  padding:7px 22px;
  color:#ffe4c4;
  background:
    radial-gradient(circle at 0 0,rgba(255,255,255,.12) 0,transparent 55%),
    radial-gradient(circle at 100% 100%,rgba(255,120,60,.25) 0,transparent 55%),
    linear-gradient(135deg,#3a0f18,#8b1c24);
  border:2px solid #f48c2b;
  box-shadow:
    0 0 0 1px rgba(0,0,0,.6),
    0 0 18px rgba(244,140,43,.9);
  clip-path:polygon(8% 0,92% 0,100% 50%,92% 100%,8% 100%,0 50%);
}
.tier-3 .player-title-badge::before{
  content:"";
  position:absolute;
  inset:2px;
  border-radius:10px;
  border:1px dashed rgba(255,223,186,.35);
  opacity:.7;
}

/* Tier 4ï¼šç‹å®¶ç›¾å¾½ */
.tier-4 .player-title-badge{
  padding:8px 24px 10px;
  color:#f9f0ff;
  background:radial-gradient(circle at top,#5c35b5,#1e1032);
  border:2px solid #e1c4ff;
  box-shadow:
    0 0 0 1px rgba(90,40,200,.6),
    0 0 22px rgba(147,96,255,1);
  border-radius:16px 16px 10px 10px;
  overflow:visible;
  animation:float 5s ease-in-out infinite;
}
.tier-4 .player-title-badge::before{
  content:"";
  position:absolute;
  left:50%;
  bottom:-10px;
  transform:translateX(-50%);
  width:60%;
  height:16px;
  background:linear-gradient(to bottom,#e1c4ff,#6e3bd1);
  clip-path:polygon(50% 100%,0 0,100% 0);
  box-shadow:0 4px 10px rgba(0,0,0,.6);
}

/* Tier 5ï¼šç‹åº§é›™ç¿¼å¾½ç«  */
.tier-5 .player-title-badge{
  padding:8px 30px;
  color:#fff9e0;
  background:linear-gradient(135deg,#5a2400,#ffcf66);
  border-radius:999px;
  border:3px solid #ffe08a;
  box-shadow:
    0 0 0 1px rgba(255,224,138,.55),
    0 0 26px rgba(255,204,110,1);
  overflow:visible;
  animation:float 4.5s ease-in-out infinite, pulse 3.8s ease-in-out infinite;
}
.tier-5 .player-title-badge::before,
.tier-5 .player-title-badge::after{
  content:"";
  position:absolute;
  top:50%;
  width:26px;
  height:16px;
  background:radial-gradient(circle at 0 50%,rgba(255,255,255,.95) 0,rgba(255,224,138,.1) 70%);
  transform:translateY(-50%);
  filter:drop-shadow(0 0 8px rgba(255,224,138,.9));
}
.tier-5 .player-title-badge::before{
  left:-16px;
  clip-path:polygon(100% 0,0 50%,100% 100%);
}
.tier-5 .player-title-badge::after{
  right:-16px;
  clip-path:polygon(0 0,100% 50%,0 100%);
}
.tier-5 .player-title-badge .text::after{
  content:"";
  position:absolute;
  inset:-2px;
  background:linear-gradient(120deg,transparent 0,rgba(255,255,255,.9) 45%,transparent 75%);
  mix-blend-mode:screen;
  transform:translateX(-130%);
  animation:shine 3.6s ease-in-out infinite;
}

/* Tier 6ï¼šç½ªé‡‘ç¢§è¼ç…Œãƒ»å‚³èªªçš‡å† ç´‹ç«  */
.tier-6 .player-bounty-amt{
  color:#fff4cf;
  text-shadow:0 0 6px rgba(255,215,128,.9);
}
.tier-6 .player-title-badge{
  padding:9px 38px;
  color:#fffdf5;
  background:
    radial-gradient(circle at 20% 0,rgba(255,255,255,.4) 0,transparent 55%),
    radial-gradient(circle at 80% 100%,rgba(255,210,120,.7) 0,transparent 55%),
    linear-gradient(135deg,#4b2a00,#c68b00,#ffe7a3);
  border-radius:999px;
  border:4px solid #ffe9c4;
  box-shadow:
    0 0 0 1px rgba(255,255,255,.45),
    0 0 0 6px rgba(158,106,32,.75),
    0 0 38px rgba(255,243,196,1);
  overflow:visible;
  position:relative;
  text-shadow:
    0 0 8px rgba(0,0,0,1),
    0 0 22px rgba(255,245,210,1);
  animation:float 4.2s ease-in-out infinite, pulse 3.4s ease-in-out infinite;
}

/* å…§å±¤æµ®é›•æ¡† */
.tier-6 .player-title-badge::before{
  content:"";
  position:absolute;
  inset:4px;
  border-radius:999px;
  border:2px solid rgba(255,252,230,.85);
  box-shadow:
    inset 0 0 8px rgba(255,255,255,.7),
    0 0 16px rgba(255,252,210,.7);
  opacity:.98;
  z-index:1;
}

/* å‘¨åœå¯¶çŸ³å…‰é» */
.tier-6 .player-title-badge::after{
  content:"";
  position:absolute;
  inset:0;
  pointer-events:none;
  background:
    radial-gradient(circle at 12% 50%,#fff 0,rgba(255,255,255,0) 55%),
    radial-gradient(circle at 88% 50%,#fff 0,rgba(255,255,255,0) 55%),
    radial-gradient(circle at 50% -10%,#fff 0,rgba(255,255,255,0) 60%);
  mix-blend-mode:screen;
  opacity:.75;
  z-index:1;
}

/* çš‡å†  + åŠå¢œ + ä¸­å¤®å…‰æšˆ */
.tier-6 .player-title-badge .crown{
  position:absolute;
  top:-16px;
  left:50%;
  transform:translateX(-50%);
  font-size:15px;
  text-shadow:
    0 0 10px #ffffff,
    0 0 18px rgba(255,230,160,1);
  z-index:4;
}
.tier-6 .player-title-badge .pendant{
  position:absolute;
  bottom:-14px;
  left:50%;
  transform:translateX(-50%);
  width:18px;
  height:18px;
  background:radial-gradient(circle,#fff7d0 0,#f0b400 45%,#8b4c00 100%);
  border-radius:50%;
  box-shadow:
    0 4px 8px rgba(0,0,0,.8),
    0 0 10px rgba(255,230,170,1);
  z-index:2;
}
.tier-6 .player-title-badge .pendant::before{
  content:"";
  position:absolute;
  top:-6px;
  left:50%;
  transform:translateX(-50%);
  width:9px;
  height:5px;
  border-radius:999px;
  background:radial-gradient(circle,#fffbe6 0,#b57a1f 100%);
}
.tier-6 .player-title-badge .glow{
  position:absolute;
  inset:-30%;
  background:radial-gradient(circle,rgba(255,255,255,.45) 0,é€æ˜ 60%);
  background:radial-gradient(circle,rgba(255,255,255,.45) 0,transparent 60%);
  mix-blend-mode:screen;
  opacity:.65;
  z-index:0;
  animation:softGlow 4.4s ease-in-out infinite;
}

/* ä¸­ï¼šæŒ‡æ¨™å‹¾é¸ */
.metric-list{ display:flex; flex-direction:column; gap:6px; }
.metric{
  display:flex; align-items:center; gap:10px;
  padding:8px 10px; border-radius:10px;
  border:1px solid rgba(255,255,255,.06);
  background:rgba(255,255,255,.03);
  cursor:pointer; user-select:none;
}
.metric input{ width:16px; height:16px; }
.metric.active{ border-color:rgba(255,211,107,.45); background:rgba(255,211,107,.06); }
.small{ font-size:13px; color:var(--muted) }

/* å³ï¼šçµ±ä¸€æ¸…å–®è¡¨ï¼ˆé ­åƒ/IDé¡¯ç¤ºä¸€æ¬¡ï¼›å‹¾é¸é …ç›®â†’åŒä¸€æ¬„å…§ä¸¦åˆ—å¤šæ¢ï¼‰ */
.table{ width:100%; border-collapse:collapse; }
.table th,.table td{ padding:10px; border-bottom:1px solid rgba(255,255,255,.06); text-align:left; vertical-align:middle; }
.table thead th{ color:var(--muted); font-weight:600; }
.cell-player{ display:flex; align-items:center; gap:10px; }
.cell-player .avatar{ width:36px; height:36px; border-radius:50%; border:1px solid rgba(255,255,255,.15) }
.cell-player .name{ font-weight:700 }
.cell-player .pid{ font-size:12px; color:var(--muted) }

/* ä¸¦åˆ—å¤šæ¢ï¼ˆæ¯å€‹æŒ‡æ¨™ä¸€æ¢ï¼‰ */
.metrics-cell{ display:flex; flex-direction:column; gap:6px; }
.metric-line{ display:flex; align-items:center; gap:8px; }
.metric-badge{
  font-size:12px; color:var(--muted); min-width:74px;
  padding:2px 6px; border:1px solid rgba(255,255,255,.08); border-radius:999px;
  text-align:center; background:rgba(255,255,255,.03);
}

/* ç´°é•·æ¢ï¼ˆ10pxï¼‰ï¼‹ æœ«ç«¯æ•¸å­— */
.bar-wrap{ flex:1; position:relative; height:10px; }
.bar{ position:absolute; inset:0; background:#2b333b; border:1px solid rgba(255,255,255,.08); border-radius:999px; overflow:hidden; }
.fill{ position:absolute; left:0; top:0; bottom:0; background:linear-gradient(90deg,var(--accent),var(--accent2)); }
.val-in{ position:absolute; right:6px; top:50%; transform:translateY(-50%); font-size:12px; color:#fff; font-variant-numeric:tabular-nums; }
.val-out{ margin-left:6px; font-size:12px; color:#fff; font-variant-numeric:tabular-nums; }

/* å°å·¥å…· */
.badge{
  padding:4px 10px;border:1px solid rgba(255,255,255,.15);
  border-radius:999px;font-size:13px;color:var(--accent);
}
.btn{
  padding:8px 12px;border:1px solid rgba(255,255,255,.1);
  border-radius:10px;background:rgba(255,255,255,.06);
  color:var(--text);cursor:pointer;transition:.15s;
}
.btn:hover{ background:rgba(255,255,255,.14); }
/* é˜²æ­¢æœªè¼‰å…¥ Tailwind æ™‚ç„¡æ³•éš±è— */
.hidden{display:none !important;}

/* ===== èªªæ˜é¢æ¿ ===== */
#helpModal, #bountyModal{
  /* çµ±ä¸€è¦†è“‹å±¤æ¨£å¼ï¼šè¦‹åŸæ‡¸è³é‡‘å½ˆçª— */
}
.help-sheet{
  width:min(960px,94vw);
  background:rgba(20,24,28,.86);
  border:1px solid rgba(255,255,255,.1);
  border-radius:18px;
  backdrop-filter: blur(8px);
  padding:18px;
}
.help-title{ font-weight:900;font-size:20px;margin-bottom:8px; }
.help-sub{ color:var(--muted);font-size:13px;margin-bottom:12px; }
.help-grid{
  display:grid;gap:12px;
  grid-template-columns: 1fr 1fr;
}
@media (max-width:860px){ .help-grid{ grid-template-columns:1fr; } }
.help-box{
  border:1px solid rgba(255,255,255,.08);
  border-radius:14px;padding:12px;background:rgba(255,255,255,.03);
}
.help-box h4{ font-size:15px;font-weight:800;margin-bottom:6px; }
.help-box ul{ margin-left:1em; }
.help-box li{ margin:4px 0; color:#cfd7e2; }
.help-math{
  margin-top:6px;padding:8px;border-radius:10px;
  background:rgba(255,255,255,.04);border:1px dashed rgba(255,255,255,.12);
  font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
  font-size:13px;color:#dfe7f3;
}
.help-note{ font-size:12px;color:var(--muted);margin-top:6px; }

/* ===== é›·é”åœ–å½ˆçª—ï¼ˆæ–°å¢ï¼‰ ===== */
#radarModal.hidden{ display:none !important; }
#radarModal{
  position: fixed; inset: 0; z-index: 210;
  display: flex; align-items: center; justify-content: center;
  background: rgba(0,0,0,.7);
}
.radar-sheet{
  width: min(980px, 96vw);
  display: grid; gap: 16px;
  grid-template-columns: 1fr 280px;
  background: rgba(20,24,28,.86);
  border: 1px solid rgba(255,255,255,.1);
  border-radius: 18px; padding: 16px;
  backdrop-filter: blur(8px);
}
.radar-head{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:6px; }
.radar-legend{ display:flex; align-items:center; gap:12px; font-size:13px; color:var(--muted); }
.radar-dot{ width:10px; height:10px; border-radius:50%; display:inline-block; }
.radar-canvas-wrap{ display:flex; align-items:center; justify-content:center; }
.radar-side{ display:flex; flex-direction:column; gap:10px; }
.radar-side .btn{ width:100%; }

/* è®“ã€Œè‡ªå·±çš„é ­åƒã€æœ‰å¯é»æç¤º */
.player-list .avatar.me{ cursor:pointer; outline:2px solid rgba(255,211,107,.35); }
.player-list .avatar.me:hover{ outline-color: rgba(255,211,107,.8); }
</style>
</head>
<body>
  <div class="header">
    <div class="wrap" style="display:flex;align-items:center;justify-content:space-between;gap:12px">
      <div>
        <div class="h1">è³½å­£çµç®—</div>
        <div class="small" id="roomLbl">æˆ¿è™Ÿ â€”</div>
      </div>
      <div style="display:flex;align-items:center;gap:10px">
        <div class="badge" id="seasonLbl">Season â€”</div>
        <button class="btn" id="openHelp">ğŸ“– èªªæ˜</button>
        <button class="btn" onclick="fireBounty()">ğŸ“œ æœ¬æ¬¡æ‡¸è³å–®</button>
        <button class="btn" onclick="location.href='start.html'">è¿”å›ç­‰å¾…æˆ¿</button>
      </div>
    </div>
  </div>

  <div class="wrap layout">
    <!-- å·¦ï¼šç©å®¶æ¸…å–® -->
    <aside class="card">
      <div class="section-title">ç©å®¶æ¸…å–®ï¼ˆä¾é‡‘å¹£æ’åï¼‰</div>
      <div class="player-list" id="playerList"></div>
    </aside>

    <!-- ä¸­ï¼šæŒ‡æ¨™å‹¾é¸ -->
    <aside class="card metrics">
      <div class="section-title">åœ–è¡¨é …ç›®</div>
      <div class="metric-list" id="metricList"></div>
      <div class="small" style="margin-top:8px">
        å‹¾é¸å¾Œï¼Œå³å´æ¯ä½ç©å®¶é‚£åˆ—æœƒåœ¨åŒä¸€æ¬„ä½ã€Œä¸¦åˆ—å¤šæ¢ã€ç´°é•·æ¢ï¼›æ•¸å­—é¡¯ç¤ºåœ¨å„æ¢æœ«ç«¯ã€‚
      </div>
    </aside>

    <!-- å³ï¼šçµ±ä¸€æ¸…å–®è¡¨ï¼ˆæ¯äººä¸€åˆ—ï¼Œä¸¦åˆ—å¤šæ¢ï¼‰ -->
    <main class="card tablewrap">
      <table class="table" id="detailTable">
        <thead>
          <tr id="theadRow">
            <th>ç©å®¶</th>
            <th>æ•¸æ“š</th>
          </tr>
        </thead>
        <tbody id="tbodyRows"></tbody>
      </table>
    </main>
  </div>

  <!-- === æ‡¸è³é‡‘å½ˆçª—ï¼ˆä¿®æ­£ï¼šbg-black/70ï¼‰ === -->
  <div id="bountyModal" class="hidden fixed inset-0 z-[200] flex items-center justify-center bg-black/70">
    <div class="relative">
      <canvas id="bountyCanvas" width="768" height="1152"></canvas>
      <button id="closeBounty" class="absolute top-2 right-2 px-3 py-1 text-sm bg-black/70 text-white rounded">âœ•</button>
    </div>
  </div>

  <!-- === èªªæ˜é¢æ¿ï¼ˆæ–°ï¼‰ === -->
  <div id="helpModal" class="hidden fixed inset-0 z-[200] flex items-center justify-content-center bg-black/70">
    <div class="help-sheet">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:6px">
        <div>
          <div class="help-title">åˆ†æ•¸èˆ‡æ‡¸è³é‡‘èªªæ˜</div>
          <div class="help-sub">ç°¡æ˜“ç‰ˆè¦å‰‡ï¼Œçµ¦ç©å®¶å¿«é€Ÿç†è§£è¨ˆåˆ†æ–¹å¼</div>
        </div>
        <button class="btn" id="closeHelp">é—œé–‰</button>
      </div>

      <div class="help-grid">
        <div class="help-box">
          <h4>é‡‘å¹£ï¼ˆcoinScoreï¼‰</h4>
          <ul>
            <li>æ¯å±€å‹è€…æ‹¿é‡‘å¹£ï¼š<b>1ï¼ˆä¿åº•ï¼‰+ ç•¶å±€æ“Šå€’æ•¸ + å¹³æ‰‹å»¶é•·åŠ æˆ</b></li>
            <li>ç¾…å‚‘è‹¥é æ¸¬åˆ°å‹è€…ï¼šå†æ‹¿åŒé‡é‡‘å¹£ï¼ˆå‘½ä¸­åˆ†å¦è¨ˆï¼‰</li>
          </ul>
        </div>
        <div class="help-box">
          <h4>æ”»æ“Šï¼ˆatkScoreï¼‰</h4>
          <ul>
            <li>æ±ºé¬¥å‹åˆ© â‡’ å–<b>å°¾æ•¸å·®</b>ï¼ˆæˆ‘ âˆ’ å°æ‰‹ï¼Œâ‰¤0 ä¸åŠ ï¼‰</li>
            <li>é¦™å‰å£«å¼·åŒ–ï¼šå…ˆ +1 å†æ¯”è¼ƒ</li>
            <li>å‡±å¤š/åŸºæ‹‰å¼·åŒ–æ±ºé¬¥ï¼š<b>ç„¡è¦–é˜²ç¦¦/é–ƒé¿ Ã—2</b></li>
            <li>é­¯å¤«å¼·åŒ–ï¼ˆç¾¤é´‰ç ²ï¼‰ï¼šåŒæ™‚æ“Šå€’å¤šäºº â‡’ <b>Ã—äººæ•¸</b></li>
            <li>å‡±å¤šå¼·åŒ–æ¸…å ´ï¼šè¢«æ¸…å ´è€…å°¾æ•¸ç¸½å’Œ Ã—2 Ã—äººæ•¸</li>
          </ul>
        </div>
        <div class="help-box">
          <h4>é˜²ç¦¦ï¼ˆdefScoreï¼‰</h4>
          <ul>
            <li><b>æ“‹ä½/æŠµæ¶ˆ</b>ä»–äººæ•ˆæœï¼šåŠ <b>æ”»æ–¹é‚£å¼µç‰Œçš„å°¾æ•¸</b>ï¼ˆä¾‹ï¼šç´¢éš†5è¢«æ“‹ +5ï¼‰</li>
            <li><b>åæ®º</b>ï¼ˆé­æ±ºé¬¥ä½†ä½ è´ï¼‰ï¼šåŠ <b>ä½ çš„å°¾æ•¸ âˆ’ æ”»æ–¹å°¾æ•¸</b>ï¼ŒåŒæ¨£åƒè©²æ±ºé¬¥çš„åŠ ä¹˜</li>
          </ul>
        </div>
        <div class="help-box">
          <h4>å‘½ä¸­ï¼ˆhitScoreï¼‰</h4>
          <ul>
            <li>é¨™äººå¸ƒçŒœä¸­å°¾æ•¸ï¼šå°æ‰‹å°¾æ•¸ Ã— é€£æ“Šæ•¸</li>
            <li>ç´¢éš†æ“Šå€’ï¼šå°æ‰‹å°¾æ•¸ Ã—2</li>
            <li>ç¾…å‚‘é æ¸¬æˆåŠŸï¼šè©²å±€å‹è€…å¯¦æ‹¿é‡‘å¹£ Ã—5</li>
          </ul>
        </div>
        <div class="help-box">
          <h4>åµæŸ¥ï¼ˆintelScoreï¼‰</h4>
          <ul>
            <li>çœ‹è¦‹çš„æ¯å¼µç‰Œï¼Œéƒ½åŠ è©²ç‰Œ<b>å°¾æ•¸</b>ï¼ˆç¾…è³“ã€ç¾…æª¢è¦–ã€é»‘é¬å­è¦†è“‹ã€å¡å¡”åº«æ —é çŸ¥ï¼‰</li>
          </ul>
        </div>
        <div class="help-box">
          <h4>ç”Ÿå­˜ï¼ˆsurvivalScoreï¼‰</h4>
          <ul>
            <li>æ¯è¼ªåˆ°ä½ ä¸€æ¬¡ï¼š+1</li>
            <li>é€²å…¥æœ€çµ‚æ¯”ç‰Œï¼šÃ—2ï¼›è‹¥åˆæ‹¿åˆ°æœ€çµ‚å‹åˆ©ï¼šå† Ã—2</li>
          </ul>
        </div>
      </div>

      <div class="help-box" style="margin-top:12px">
        <h4>æ‡¸è³é‡‘ï¼ˆæœ€å¾Œæ›ç®—ï¼‰</h4>
        <div class="help-math">æ‡¸è³é‡‘ ï¼ é‡‘å¹£ Ã— 200,000,000 ï¼‹ (æ”»æ“Šï¼‹å‘½ä¸­) Ã— 10,000,000 ï¼‹ (é˜²ç¦¦ï¼‹åµæŸ¥ï¼‹ç”Ÿå­˜) Ã— 5,000,000ï¼Œå†ä¹˜ä¸Šç©å®¶æ•¸å¹³è¡¡ä¿‚æ•¸ (6 / ç©å®¶æ•¸)ã€‚</div>
        <div class="help-note">â€» ç©å®¶è¶Šå¤šï¼Œä¿‚æ•¸è¶Šå°ï¼Œé¿å…äººå¤šæˆ¿çš„æ‡¸è³é‡‘çˆ†ç‚¸ï¼›ä¸åŒæˆ¿ä»å¯ä»¥äº’ç›¸æ¯”è¼ƒã€‚</div>
      </div>
    </div>
  </div>

  <!-- === é›·é”åœ–ï¼ˆæˆ‘çš„ vs. å–®ä¸€å°æ‰‹ï¼‰ã€æ–°å¢ã€‘ === -->
  <div id="radarModal" class="hidden">
    <div class="radar-sheet">
      <div>
        <div class="radar-head">
          <div class="section-title">èƒ½åŠ›é›·é”åœ–</div>
          <div class="radar-legend">
            <span><span class="radar-dot" style="background:#4e9cff"></span> æˆ‘</span>
            <span><span class="radar-dot" style="background:#ff6384"></span> å°æ‰‹</span>
          </div>
        </div>
        <div class="radar-canvas-wrap">
          <canvas id="radarCanvas" width="600" height="600"></canvas>
        </div>
      </div>
      <div class="radar-side">
        <div class="small">é¸æ“‡è¦æ¯”è¼ƒçš„å°æ‰‹ï¼ˆä¸€æ¬¡ä¸€ä½ï¼‰ï¼š</div>
        <select id="oppoSelect" class="btn"></select>
        <button id="closeRadar" class="btn">é—œé–‰</button>
      </div>
    </div>
  </div>

<script src="https://onepiece-card-online.onrender.com/socket.io/socket.io.js"></script>
<script>
/* ====== å…¨åŸŸç‹€æ…‹ ====== */
const RESUME = true;
let LAST_FINAL = null;   // æœ€æ–° final
let STATE = null;        // æœ€æ–° socket ç‹€æ…‹
let MY_PID = null;       // æˆ‘çš„ pidï¼ˆèˆ‡ id ä¸åŒï¼‰
let MY_ID = null;

const qs = new URLSearchParams(location.search);
const roomId = qs.get('room') || sessionStorage.getItem('op_room') || 'â€”';
document.getElementById('roomLbl').textContent = 'æˆ¿è™Ÿ ' + roomId;

/* avatar è·¯å¾‘ä¿®æ­£ */
function avatarUrl(v){
  if(v==null) return '';
  if(typeof v === 'number') return `images/avatars/${v}.png`;
  if(/^https?:\/\//i.test(v)) return v;
  if(typeof v === 'string'){
    if(v.includes('/')) return v;
    return `images/avatars/${v}`;
  }
  return '';
}

/* å‹¾é¸çš„æŒ‡æ¨™ï¼ˆç§»é™¤ç¸½åˆ†ï¼‰ */
const METRICS = [
  { key:'coinScore',  title:'é‡‘å¹£' },
  { key:'atkScore',   title:'æ”»æ“Š' },
  { key:'defScore',   title:'é˜²ç¦¦' },
  { key:'hitScore',   title:'å‘½ä¸­' },
  { key:'intelScore', title:'åµæŸ¥' },
  { key:'survivalScore', title:'ç”Ÿå­˜' }
];

/* å°æ‡‰ï¼škey â†’ ä¸­æ–‡åç¨±ï¼ˆçµ¦ç¨±è™Ÿé¡¯ç¤ºç”¨ï¼‰ */
const METRIC_NAME_MAP = {
  atkScore: 'æ”»æ“Š',
  hitScore: 'å‘½ä¸­',
  defScore: 'é˜²ç¦¦',
  intelScore: 'åµæŸ¥',
  survivalScore: 'ç”Ÿå­˜'
};

/* å„é …ç›®ã€å„å€é–“çš„ç¨±è™Ÿè¡¨ï¼ˆ1â€“6 å°æ‡‰ä½ çš„å€é–“ï¼‰ */
const TITLE_TABLE = {
  atkScore: {
    1:'æ–¬æ–·é‹¼éµçš„åŠ›é‡',
    2:'æµæ«»è¦‹ç¿’ç”Ÿ',
    3:'éœ¸ç‹è‰²çºç¹è€…',
    4:'éµæ‹³',
    5:'ä¸–ç•Œæœ€å¼·çš„ç”·äºº',
    6:'ä¸–ç•Œæœ€å¼·ç”Ÿç‰©'
  },
  hitScore: {
    1:'é¨™äººå¸ƒæ©¡çš®ç­‹',
    2:'ç‹™æ“Šæ‰‹',
    3:'ç‹™æ“Šç‹',
    4:'ç¥çš„åˆ¶è£',
    5:'è¶…éŸ³é€Ÿç‹™æ“Šæ‰‹',
    6:'æˆ‘èƒ½æ‰“ä¸­èèŸ»çš„çœ‰å¿ƒ'
  },
  defScore: {
    1:'å…­å¼ éµå¡Š',
    2:'æ­¦è£è‰²åˆå­¸è€…',
    3:'é‹¼éµæ°£çƒ',
    4:'é‘½çŸ³å–¬èŒ²',
    5:'éœ²å¨œåˆ©äºæ—',
    6:'å±éšœæœå¯¦èƒ½åŠ›è€…'
  },
  intelScore: {
    1:'èˆªæµ·å£«è¦‹ç¿’ç”Ÿ',
    2:'ç›£è¦–é›»è©±èŸ²',
    3:'è¦‹èè‰²é«˜æ‰‹',
    4:'CP9 æƒ…å ±å®˜',
    5:'CP0 è«œå ±å“¡',
    6:'ä¸–ç•Œç¶“æ¿Ÿæ–°èå ±ç¤¾ç¤¾é•·'
  },
  survivalScore: {
    1:'é¨™äººå¸ƒçš„ç”Ÿå­˜ä¹‹é“',
    2:'å¥‡è¹Ÿ Boy',
    3:'å·¨äººæ—',
    4:'ä¸æ­»é³¥é¦¬å¯',
    5:'å¤ä»£ç¨®çš„éŸŒæ€§',
    6:'ä¸æ­»ç¥ä¹‹é¨å£«åœ˜'
  }
};

let ORDERED_IDS = []; // ä¾é‡‘å¹£æ’å
let ROWS = [];        // æ¯ä½ç©å®¶çš„åˆ†æ•¸
let ACTIVE = new Set(['coinScore']); // é è¨­é¡¯ç¤ºï¼šé‡‘å¹£

/* ===== æ‡¸è³è¨ˆç®—å·¥å…·ï¼ˆèˆ‡æµ·å ±åŒå…¬å¼ï¼‰ ===== */
function computeBountyFromScore(score, playerCount){
  const s = score || {};
  const coins = +s.coinScore || 0;
  const atk   = +s.atkScore   || 0;
  const hit   = +s.hitScore   || 0;
  const def   = +s.defScore   || 0;
  const intel = +s.intelScore || 0;
  const surv  = +s.survivalScore || 0;

  const N = playerCount || 4;
  const factor = 6 / N;

  return (
    coins * 200000000 * factor +
    (atk + hit) * 10000000 * factor +
    (def + intel + surv) * 5000000 * factor
  );
}

/* æŠŠæ‡¸è³é‡‘æ›ç®—æˆã€Œå¹¾å„„ã€ï¼ˆå­—ä¸²ï¼‰ */
function formatBountyYi(bounty){
  if(!bounty || bounty <= 0) return '0 å„„';
  const yi = bounty / 100000000; // 1 å„„ = 1e8
  let s = yi >= 10 ? yi.toFixed(0) : yi.toFixed(1);
  s = s.replace(/\.0$/,'');
  return s + ' å„„';
}

/* ä¾ 6 å€‹å€é–“ï¼Œæ±ºå®š tierï¼ˆ1~6ï¼‰ */
function decideTierByBounty(bounty){
  if (bounty <   1000000000) return 1; // <10 å„„
  if (bounty <   3000000000) return 2; // 10â€“30 å„„
  if (bounty <   4000000000) return 3; // 30â€“40 å„„
  if (bounty <   5000000000) return 4; // 40â€“50 å„„
  if (bounty <   6000000000) return 5; // 50â€“60 å„„
  return 6;                             // 60 å„„ä»¥ä¸Š
}

/* æ‰¾å‡ºé€™ä½ç©å®¶æœ¬æ¬¡ã€Œå“ªå€‹é …ç›®æœ€é«˜ã€â†’ atk / hit / def / intel / survival */
function pickMainMetricKey(row){
  const keys = ['atkScore','hitScore','defScore','intelScore','survivalScore'];
  let bestKey = keys[0];
  let bestVal = -Infinity;
  for(const k of keys){
    const v = Number(row[k]||0);
    if (v > bestVal){
      bestVal = v;
      bestKey = k;
    }
  }
  return bestKey;
}

/* ä¾æ‡¸è³å€é–“ + ä¸»é …ç›®ï¼Œæ±ºå®šç¨±è™Ÿæ–‡å­—èˆ‡ tier */
function getTitleInfoForRow(row, playerCount){
  const score = {
    coinScore: row.coinScore,
    atkScore: row.atkScore,
    defScore: row.defScore,
    hitScore: row.hitScore,
    intelScore: row.intelScore,
    survivalScore: row.survivalScore
  };
  const bounty = computeBountyFromScore(score, playerCount);
  const tier = decideTierByBounty(bounty);
  const mainKey = pickMainMetricKey(row);
  const tableByKey = TITLE_TABLE[mainKey] || {};
  const label = tableByKey[tier] || '';
  const metricName = METRIC_NAME_MAP[mainKey] || '';

  return {
    bounty,
    tier,
    mainKey,
    metricName,
    label
  };
}

/* ====== ç¨±è™Ÿæ¡†ï¼šè‡ªå‹•ç¸®å°å­—é«”ï¼Œç›´åˆ°å¡é€²æ¡†è£¡ ====== */
function adjustTitleFontSizes(){
  const nodes = document.querySelectorAll('.player-title-badge .text');
  nodes.forEach(el=>{
    if (!el.textContent) return;
    el.style.fontSize = '';                    // é‡è¨­
    const badge = el.closest('.player-title-badge');
    if (!badge) return;
    const maxWidth = badge.clientWidth;
    if (!maxWidth) return;

    let fs = parseFloat(getComputedStyle(el).fontSize) || 11;
    const minFs = 8;
    let guard = 0;

    // ç‚ºäº†å¯è®€æ€§ï¼Œå‘ä¸‹å–æ•´ 0.5pxï¼ˆé¿å…å­åƒç´ æŠ–å‹•ï¼‰
    while (el.scrollWidth > badge.clientWidth && fs > minFs && guard < 30){
      fs -= 0.5;
      el.style.fontSize = fs + 'px';
      guard++;
    }
  });
}

/* å·¦æ¬„ç©å®¶æ¸…å–® */
function renderPlayersLeft(final, myId){
  const el = document.getElementById('playerList');
  const playerCount = (final.playerCount) ||
    Object.keys(final.playersMeta || {}).length ||
    (final.ranking ? final.ranking.length : 4);

  const list = (final.ranking||[]).map((r,idx)=>{
    const pm = final.playersMeta?.[r.id] || {};
    const name = r.name || pm.name || ('P'+(r.id+1));
    const pid  = (r.pid != null ? r.pid : pm.pid) ?? '';
    const ava  = (r.avatar != null ? r.avatar : pm.avatar) ?? '';
    const coins = r.coins || 0;

    const row = ROWS.find(x=>x.id===r.id) || {
      coinScore:coins, atkScore:0, defScore:0, hitScore:0, intelScore:0, survivalScore:0
    };
    const info = getTitleInfoForRow(row, playerCount);
    const rawBounty = Math.floor(info.bounty || 0);
    const bountyStr = rawBounty.toLocaleString('en-US'); // è©³ç´°æ•¸å­—ï¼‹åƒåˆ†ä½
    const tierClass = info.tier ? ('tier-'+info.tier) : 'tier-1';

    return {
      idx:idx+1,
      id:r.id,
      name,
      pid,
      ava,
      coins,
      tierClass,
      bountyStr,
      titleLabel: info.label
    };
  });
  ORDERED_IDS = list.map(p=>p.id);

  el.innerHTML = list.map((p,i)=>{
    const isMe = (myId != null && p.id === myId) || (MY_PID != null && String(p.pid) === String(MY_PID));
    const highlight = (myId != null || MY_PID != null) ? isMe : (i === 0);
    const titleText = p.titleLabel ? `${p.titleLabel}` : '';

    return `
      <div class="player-item ${highlight ? 'top1' : ''} ${p.tierClass}">
        <div class="rank-dot">${p.idx}</div>

        <div class="avatar-col">
          <img class="avatar ${isMe?'me':''}"
               data-id="${p.id}"
               ${isMe?'title="é»æˆ‘çœ‹é›·é”åœ–"':''}
               src="${avatarUrl(p.ava)}" alt="">
          <div class="avatar-meta">
            <div class="coins">${p.coins}</div>
            <div class="player-bounty">
              <div class="player-bounty-amt">æ‡¸è³é‡‘ ${p.bountyStr}</div>
              ${titleText ? `
                <div class="player-title-badge">
                  <!-- Tier 6 æœƒç”¨åˆ°çš„è£é£¾å…ƒç´ ï¼Œå…¶ä»– tier ä¹Ÿæ²’é—œä¿‚ -->
                  <div class="glow"></div>
                  <span class="crown">ğŸ‘‘</span>
                  <span class="text">${titleText}</span>
                  <div class="pendant"></div>
                </div>
              ` : ''}
            </div>
          </div>
        </div>

        <div class="pinfo">
          <div class="pname">${p.name}</div>
        </div>
      </div>
    `;
  }).join('');

  /* ç”Ÿæˆå®Œç¨±è™Ÿæ¡†ä¹‹å¾Œï¼Œèª¿æ•´ç¨±è™Ÿå­—é«”å¤§å° */
  adjustTitleFontSizes();

  // ç¶å®šï¼šåªæœ‰ã€Œè‡ªå·±ã€çš„é ­åƒèƒ½æ‰“é–‹é›·é”åœ–ï¼ˆä¿æŒä¸å‹•ï¼‰
  el.querySelectorAll('img.avatar.me').forEach(img=>{
    img.addEventListener('click', ()=>{
      const myIdResolved = Number(img.getAttribute('data-id'));
      openRadar(myIdResolved);
    });
  });
}

/* å‹¾é¸é¢æ¿ */
function buildMetricPanel(){
  const ml = document.getElementById('metricList');
  ml.innerHTML = METRICS.map(m=>{
    const on = ACTIVE.has(m.key);
    return `
      <label class="metric ${on?'active':''}" data-key="${m.key}">
        <input type="checkbox" value="${m.key}" ${on?'checked':''}/>
        <span>${m.title}</span>
      </label>
    `;
  }).join('');

  ml.querySelectorAll('label.metric').forEach(lbl=>{
    const key = lbl.getAttribute('data-key');
    const cb = lbl.querySelector('input[type="checkbox"]');
    cb.addEventListener('change', ()=>{
      if(cb.checked) ACTIVE.add(key); else ACTIVE.delete(key);
      lbl.classList.toggle('active', cb.checked);
      renderDetailTable();
    });
  });
}

/* å–®ä¸€ç©å®¶ä¸€åˆ—ï¼šåœ¨åŒä¸€æ¬„ä½ä¸¦åˆ—å¤šæ¢ï¼ˆæ¯å€‹å‹¾é¸çš„æŒ‡æ¨™å„ä¸€æ¢ï¼‰
   cap è¦å‰‡ï¼šcap = (æœ¬å ´è©²æŒ‡æ¨™æœ€å¤§å€¼) + 10ï¼›è‹¥å…¨ç‚º 0ï¼Œcap = 10ã€‚ */
function renderMetricsCell(r, capMap){
  const keys = Array.from(ACTIVE);
  if(keys.length===0) return '<div class="small" style="color:var(--muted)">ï¼ˆå°šæœªå‹¾é¸é …ç›®ï¼‰</div>';

  const lines = keys.map(key=>{
    const m = METRICS.find(x=>x.key===key);
    const val = Number(r[key]||0);
    const cap = Math.max(10, capMap[key] || 10);
    const pct = Math.max(0, Math.min(100, (100*val/cap)));
    const showInside = pct >= 18;
    return `
      <div class="metric-line">
        <span class="metric-badge">${m?m.title:key}</span>
        <div class="bar-wrap">
          <div class="bar"></div>
          <div class="fill" style="width:${pct}%"></div>
          ${showInside ? `<span class="val-in">${val}</span>` : ``}
        </div>
        ${!showInside ? `<span class="val-out">${val}</span>` : ``}
      </div>
    `;
  }).join('');

  return `<div class="metrics-cell">${lines}</div>`;
}

/* å³å´è¡¨æ ¼ */
function renderDetailTable(){
  const thead = document.getElementById('theadRow');
  const tbody = document.getElementById('tbodyRows');

  thead.innerHTML = `<th>ç©å®¶</th><th>æ•¸æ“š</th>`;

  // ä¾è¦æ ¼ï¼šcap = æœ¬å ´æœ€å¤§å€¼ + 10ï¼›è‹¥å…¨ 0ï¼Œcap=10
  const capMap = {};
  for(const key of ACTIVE){
    const maxVal = Math.max(0, ...ROWS.map(r=> Number(r[key]||0) ));
    capMap[key] = Math.max(10, maxVal + 10);
  }

  tbody.innerHTML = ORDERED_IDS.map(id=>{
    const r = ROWS.find(x=>x.id===id) || {};
    const playerCell = `
      <div class="cell-player">
        <img class="avatar" src="${avatarUrl(r.avatar)}" alt="">
        <div>
          <div class="name">${r.name||('P'+(id+1))}</div>
        </div>
      </div>
    `;
    return `<tr>
      <td>${playerCell}</td>
      <td>${renderMetricsCell(r, capMap)}</td>
    </tr>`;
  }).join('');
}

/* ä¸»æ¸²æŸ“ */
function renderFinal(final){
  document.getElementById('seasonLbl').textContent = 'Season ' + (final.seasonNo||1);
  LAST_FINAL = final;

  const playerCount = final.playerCount ||
    Object.keys(final.playersMeta || {}).length ||
    (final.ranking ? final.ranking.length : 4);

  MY_ID = guessMyId(final, MY_PID);

  const names={}, avatars={}, pids={};
  (final.ranking||[]).forEach(r=>{
    const pm = final.playersMeta?.[r.id] || {};
    names[r.id]   = r.name ?? pm.name ?? ('P'+(r.id+1));
    avatars[r.id] = (r.avatar != null ? r.avatar : pm.avatar) ?? '';
    pids[r.id]    = (r.pid != null ? r.pid : pm.pid) ?? '';
  });
  if(final.playersMeta){
    for(const [k,pm] of Object.entries(final.playersMeta)){
      const i = +k;
      if(!names[i])   names[i] = pm.name || ('P'+(i+1));
      if(!avatars[i]) avatars[i] = pm.avatar ?? '';
      if(typeof pids[i]==='undefined') pids[i] = pm.pid ?? '';
    }
  }

  ROWS = Object.keys(final.scoreboard||{}).map(k=>{
    const id = +k; const s = final.scoreboard[id]||{};
    const row = {
      id,
      name:names[id],
      avatar:avatars[id],
      pid:pids[id],
      coinScore:s.coinScore||0,
      atkScore:s.atkScore||0,
      defScore:s.defScore||0,
      hitScore:s.hitScore||0,
      intelScore:s.intelScore||0,
      survivalScore:s.survivalScore||0
    };

    const info = getTitleInfoForRow(row, playerCount);
    row.bounty = info.bounty;
    row.titleTier = info.tier;
    row.mainMetricKey = info.mainKey;
    row.mainMetricName = info.metricName;
    row.titleLabel = info.label;
    return row;
  });

  renderPlayersLeft(final, MY_ID);
  buildMetricPanel();
  renderDetailTable();
}

/* ====== å•Ÿå‹•éšæ®µï¼šè¼‰å…¥å¿«å– +ï¼ˆå¯é¸ï¼‰æ¥çºŒç›£çœ‹ ====== */
(function init(){
  const pidUrl   = qs.get('pid');
  const pidSS    = sessionStorage.getItem('op_pid');
  const pidState = STATE?.myPlayerId || STATE?.me?.playerId;
  MY_PID = pidUrl || pidSS || pidState || null;
  console.log('[MY_PID resolved]', { pidUrl, pidSS, pidState, MY_PID });

  try{
    const cached=sessionStorage.getItem('op_final');
    if(cached){ renderFinal(JSON.parse(cached)); }
  }catch(e){ console.warn(e); }

  if(!RESUME) return;

  const serverURL = new URLSearchParams(location.search).get('server')
  || "https://onepiece-card-online.onrender.com";
  const socket = io(serverURL, { transports: ['websocket'] });

  socket.on('connect', ()=>{
    socket.emit('JOIN', { roomId, resume:true, pid:MY_PID });
  });
  socket.on('STATE', (s)=>{
    STATE = s;
    if(s && s.final){ renderFinal(s.final); }
  });

  // èªªæ˜é¢æ¿
  document.getElementById('openHelp')?.addEventListener('click', ()=> {
    document.getElementById('helpModal')?.classList.remove('hidden');
  });
  document.getElementById('closeHelp')?.addEventListener('click', ()=> {
    document.getElementById('helpModal')?.classList.add('hidden');
  });
  document.getElementById('helpModal')?.addEventListener('click', (e)=> {
    if(e.target.id==='helpModal') e.currentTarget.classList.add('hidden');
  });
})();

/* ====== æ‡¸è³é‡‘ï¼špid -> id å°æ‡‰èˆ‡æŒ‰éˆ•è§¸ç™¼ ====== */
function fallbackId(final){
  if (Array.isArray(final?.ranking) && final.ranking.length) return final.ranking[0].id;
  if (final?.playersMeta){
    const ids = Object.keys(final.playersMeta).map(x=>+x).sort((a,b)=>a-b);
    if (ids.length) return ids[0];
  }
  return 0;
}

function guessMyId(final, pid){
  if(final?.playersMeta && pid!=null){
    for(const [k,pm] of Object.entries(final.playersMeta)){
      if(pm && String(pm.pid) === String(pid)) return +k;
    }
  }
  if(Array.isArray(final?.ranking)){
    const hit = final.ranking.find(r => String(r.pid) === String(pid));
    if(hit) return hit.id;
  }
  const asNum = Number(pid);
  if (Number.isInteger(asNum) && asNum >= 0) {
    if (final?.scoreboard && Object.prototype.hasOwnProperty.call(final.scoreboard, String(asNum))) {
      return asNum;
    }
    if (Array.isArray(final?.ranking) && asNum < final.ranking.length) {
      return asNum;
    }
  }
  return fallbackId(final);
}

async function fireBounty(){
  const final = LAST_FINAL || (STATE && STATE.final);
  if(!final){ alert('å°šæœªå–å¾—çµç®—è³‡æ–™'); return; }

  if (!MY_PID) {
    const fromSS = sessionStorage.getItem('op_pid');
    if (fromSS) MY_PID = fromSS;
  }

  let myId = guessMyId(final, MY_PID);
  if (!final.playersMeta || !final.playersMeta[myId]) {
    myId = fallbackId(final);
  }

  try{
    await showBounty(final, myId);
  }catch(err){
    console.error('[bounty] error:', err);
    alert('æ‡¸è³é‡‘ç”Ÿæˆå¤±æ•—ï¼šè«‹æª¢æŸ¥ images/wanted.png èˆ‡é ­åƒè·¯å¾‘æ˜¯å¦å­˜åœ¨');
  }
}
</script>

<!-- === æ‡¸è³é‡‘ç¹ªè£½ === -->
<script>
function calcBounty(score){
  const s = score || {};

  const coins = +s.coinScore || 0;
  const atk   = +s.atkScore   || 0;
  const hit   = +s.hitScore   || 0;
  const def   = +s.defScore   || 0;
  const intel = +s.intelScore || 0;
  const surv  = +s.survivalScore || 0;

  const N = (LAST_FINAL?.playerCount)
         || Object.keys(LAST_FINAL?.playersMeta || {}).length
         || 4;
  const factor = 6 / N;

  return (
      coins * 200000000 * factor
    + (atk + hit) * 10000000 * factor
    + (def + intel + surv) * 5000000 * factor
  );
}

function loadImage(src){
  return new Promise((resolve)=>{
    const img = new Image();
    img.crossOrigin = "anonymous";
    img.onload  = ()=> resolve(img);
    img.onerror = ()=> resolve(null);
    img.src = src;
  });
}

function avatarUrl(v){
  if(v==null) return '';
  if(typeof v === 'number') return `images/avatars/${v}.png`;
  if(/^https?:\/\//i.test(v)) return v;
  if(typeof v === 'string'){
    if(v.includes('/')) return v;
    return `images/avatars/${v}`;
  }
  return '';
}

// === æ‡¸è³é‡‘ç¹ªè£½ï¼ˆé ­åƒåœ¨ä¸‹å±¤ï¼Œæµ·å ±åœ¨ä¸Šå±¤ï¼‰ ===
async function showBounty(final, myId){
  const me = (final?.playersMeta && final.playersMeta[myId]) || {
    name: `P${(myId|0)+1}`, pid: myId|0, avatar: null
  };
  const s  = (final?.scoreboard && final.scoreboard[myId]) || {
    coinScore:0, atkScore:0, defScore:0, hitScore:0, intelScore:0, survivalScore:0
  };

  const bounty = calcBounty(s);
  const canvas = document.getElementById('bountyCanvas');
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // === å°é½Šåƒæ•¸ï¼ˆä½ çµ¦çš„é‚£çµ„ï¼‰ ===
  const cx = 382;
  const cy = 489;
  const r  = 250;
  const nameY = 939;
  const bountyY = 1032;
  const nameFont = 126;
  const bountyFont = 78;

  // === è¼‰åœ– ===
  const bg = await loadImage('images/wanted.png');
  const fallbackAvatarIdx = (myId % 8) + 1;
  const avaUrl = avatarUrl(me.avatar) || `images/avatars/${fallbackAvatarIdx}.png`;
  const avatar = await loadImage(avaUrl);

  // å…ˆç•«é ­åƒï¼ˆåœ¨ä¸‹å±¤ï¼Œåšåœ“å½¢è£åˆ‡ï¼‰
  ctx.save();
  ctx.beginPath();
  ctx.arc(cx, cy, r, 0, Math.PI * 2);
  ctx.closePath();
  ctx.clip();
  if (avatar) ctx.drawImage(avatar, cx - r, cy - r, r * 2, r * 2);
  ctx.restore();

  // å†ç•«æ‡¸è³æµ·å ±ï¼ˆåœ¨ä¸Šå±¤ï¼‰
  if (bg) ctx.drawImage(bg, 0, 0, canvas.width, canvas.height);

  // åç¨±
  ctx.fillStyle = "#674832";
  ctx.textAlign = "center";
  ctx.font = `bold ${nameFont}px 'Times New Roman', serif`;

  // ç´°é‚Šæ¡†åƒæ•¸
  const nameStrokeW = Math.max(2, Math.round(nameFont * 0.035));
  ctx.lineWidth = nameStrokeW;
  ctx.lineJoin  = "round";
  ctx.miterLimit = 2;
  ctx.strokeStyle = "#412513";
  ctx.fillStyle   = "#674832";

  const nameTxt = me.name || (`P${(myId|0)+1}`);
  ctx.strokeText(nameTxt, cx, nameY);
  ctx.fillText(nameTxt,   cx, nameY);

  // æ‡¸è³é‡‘é¡ï¼ˆå®Œæ•´æ•¸å­—ï¼‰
  const bountyStr = Number(bounty).toLocaleString('en-US');

  ctx.save();
  ctx.textAlign = 'center';
  ctx.textBaseline = 'alphabetic';

  ctx.font = `300 ${bountyFont * 1}px "Cambria", "Georgia", "Arial", serif`;
  ctx.fillStyle = '#38281d';
  ctx.shadowColor = 'rgba(0,0,0,0.15)';
  ctx.shadowBlur = 4;
  ctx.shadowOffsetX = 1;
  ctx.shadowOffsetY = 1;

  ctx.fillText(bountyStr, cx, bountyY);
  ctx.restore();

  // é¡¯ç¤ºå½ˆçª—
  document.getElementById('bountyModal').classList.remove('hidden');
}

document.getElementById('closeBounty').onclick = ()=>{
  document.getElementById('bountyModal').classList.add('hidden');
};
document.getElementById('bountyModal').addEventListener('click',(e)=>{
  if(e.target.id==='bountyModal') e.currentTarget.classList.add('hidden');
});
</script>

<script>
/* ===== é›·é”åœ–ç¹ªè£½èˆ‡äº’å‹•ï¼ˆæ–°å¢ï¼‰ ===== */
function rowById(pid){
  return ROWS.find(r => r.id === pid);
}
function polar(cx, cy, radius, rad){
  return [cx + radius * Math.cos(rad), cy + radius * Math.sin(rad)];
}
function drawPoly(ctx, points, fillStyle, strokeStyle){
  if (!points || !points.length) return;
  ctx.beginPath();
  ctx.moveTo(points[0][0], points[0][1]);
  for(let i=1;i<points.length;i++) ctx.lineTo(points[i][0], points[i][1]);
  ctx.closePath();
  if (fillStyle){ ctx.fillStyle = fillStyle; ctx.fill(); }
  if (strokeStyle){ ctx.strokeStyle = strokeStyle; ctx.lineWidth = 2; ctx.stroke(); }
}
// cap = æœ¬å ´è©²è»¸æœ€å¤§å€¼ + 10ï¼›è‹¥å…¨ 0ï¼Œcap=10
function buildRadarCaps(){
  const caps = {};
  for (const m of METRICS){
    const key = m.key;
    const maxVal = Math.max(0, ...ROWS.map(r => Number(r[key]||0)));
    caps[key] = Math.max(10, maxVal + 10);
  }
  return caps;
}

function renderRadar(baseRow, oppRow){
  const ME_COLOR_FILL = 'rgba(78,156,255,.22)';   // æˆ‘ï¼šè—
  const ME_COLOR_LINE = 'rgba(78,156,255,.95)';
  const OP_COLOR_FILL = 'rgba(255,99,132,.20)';   // å°æ‰‹ï¼šæ´‹ç´…
  const OP_COLOR_LINE = 'rgba(255,99,132,.95)';

  const cvs = document.getElementById('radarCanvas');
  const ctx = cvs.getContext('2d');
  const W = cvs.width, H = cvs.height;
  ctx.clearRect(0,0,W,H);

  const cx = W/2, cy = H/2, R = Math.min(W,H)*0.36;
  const axes = METRICS.map(m => m.key);
  const labels = METRICS.map(m => m.title);
  const caps = buildRadarCaps();

  // åº•å±¤è››ç¶² + è»¸ç·š + æ¨™ç±¤
  ctx.save();
  ctx.globalAlpha = 0.85;
  const rings = 5;
  for(let r=1;r<=rings;r++){
    const rr = (R * r) / rings;
    const pts = axes.map((_,i)=>{
      const rad = -Math.PI/2 + i*(2*Math.PI/axes.length);
      return polar(cx, cy, rr, rad);
    });
    drawPoly(ctx, pts, null, 'rgba(255,255,255,.12)');
  }
  ctx.font = '12px system-ui,-apple-system,Segoe UI,Roboto,Noto Sans TC,sans-serif';
  ctx.fillStyle = 'rgba(233,240,248,.92)';
  ctx.strokeStyle = 'rgba(255,255,255,.12)';
  for(let i=0;i<axes.length;i++){
    const rad = -Math.PI/2 + i*(2*Math.PI/axes.length);
    const [x,y] = polar(cx, cy, R, rad);
    ctx.beginPath(); ctx.moveTo(cx,cy); ctx.lineTo(x,y); ctx.stroke();

    const [lx,ly] = polar(cx, cy, R+20, rad);
    ctx.textAlign = (Math.cos(rad)>0.35) ? 'left' : (Math.cos(rad)<-0.35 ? 'right':'center');
    ctx.textBaseline = (Math.sin(rad)>0.35) ? 'top' : (Math.sin(rad)<-0.35 ? 'bottom':'middle');
    ctx.fillText(labels[i], lx, ly);
  }
  ctx.restore();

  // å·¥å…·ï¼šç”± row ç”Ÿé»ã€ç•«å¤šé‚Šå½¢
  function makePoints(row){
    if(!row) return null;
    return axes.map((key,i)=>{
      const val = Math.max(0, Number(row[key]||0));
      const cap = Math.max(1, caps[key]||1);
      const ratio = Math.min(1, val / cap);
      const rad = -Math.PI/2 + i*(2*Math.PI/axes.length);
      const [x,y] = polar(cx, cy, R*ratio, rad);
      return { x,y,rad,val };
    });
  }
  function strokeFill(points, fill, line){
    if(!points || !points.length) return;
    ctx.beginPath();
    ctx.moveTo(points[0].x, points[0].y);
    for(let i=1;i<points.length;i++) ctx.lineTo(points[i].x, points[i].y);
    ctx.closePath();
    ctx.fillStyle = fill; ctx.strokeStyle = line; ctx.lineWidth = 2;
    ctx.fill(); ctx.stroke();
  }
  function drawMarkersWithValues(points, color, pushOut){
    if(!points) return;
    ctx.font = '12px system-ui,-apple-system,Segoe UI,Roboto,Noto Sans TC,sans-serif';
    for(const p of points){
      // é»
      ctx.beginPath();
      ctx.arc(p.x, p.y, 3, 0, Math.PI*2);
      ctx.fillStyle = color;
      ctx.fill();

      // æ•¸å­—ï¼ˆæ²¿è»¸ç·šå¾€å¤–æ¨ä¸€é»ï¼‰
      const [tx,ty] = polar(cx, cy, Math.hypot(p.x-cx, p.y-cy) + (pushOut||12), p.rad);
      ctx.textAlign = (Math.cos(p.rad)>0.35) ? 'left' : (Math.cos(p.rad)<-0.35 ? 'right':'center');
      ctx.textBaseline = (Math.sin(p.rad)>0.35) ? 'top' : (Math.sin(p.rad)<-0.35 ? 'bottom':'middle');

      // å…ˆæé‚Šå†å¡«è‰²
      const label = String(p.val);
      ctx.lineWidth = 3;
      ctx.strokeStyle = 'rgba(0,0,0,.55)';
      ctx.strokeText(label, tx, ty);
      ctx.fillStyle = 'rgba(245,248,252,.98)';
      ctx.fillText(label, tx, ty);
    }
  }

  // æˆ‘ã€å°æ‰‹
  const mePts  = makePoints(baseRow);
  const opPts  = oppRow ? makePoints(oppRow) : null;

  // å…ˆç•«å°æ‰‹ï¼Œå†ç•«è‡ªå·±
  if(opPts){ strokeFill(opPts, OP_COLOR_FILL, OP_COLOR_LINE); }
  if(mePts){ strokeFill(mePts, ME_COLOR_FILL, ME_COLOR_LINE); }

  // æ¨™è¨˜ + æ•¸å­—ï¼šæˆ‘ï¼ˆæ¨ 12pxï¼‰ã€å°æ‰‹ï¼ˆæ¨ 22pxï¼‰
  if(mePts){ drawMarkersWithValues(mePts, ME_COLOR_LINE, 12); }
  if(opPts){ drawMarkersWithValues(opPts, OP_COLOR_LINE, 22); }

  // ä¸­å¿ƒå°åœ“
  ctx.beginPath(); ctx.arc(cx,cy,3,0,Math.PI*2);
  ctx.fillStyle='rgba(255,255,255,.6)'; ctx.fill();
}

function openRadar(myId){
  const final = LAST_FINAL || (STATE && STATE.final);
  if (!final) return;
  const me = rowById(myId);
  if (!me) return;

  // å»ºç«‹å°æ‰‹æ¸…å–®
  const oppoSel = document.getElementById('oppoSelect');
  const others = ORDERED_IDS.filter(id => id !== myId).map(id => rowById(id)).filter(Boolean);
  oppoSel.innerHTML = [
    `<option value="">ï¼ˆä¸æ¯”è¼ƒï¼‰</option>`,
    ...others.map(r => `<option value="${r.id}">${r.name||('P'+(r.id+1))}</option>`)
  ].join('');

  // åˆæ¬¡æ¸²æŸ“ï¼ˆåªæœ‰æˆ‘ï¼‰
  renderRadar(me, null);

  // ç›£è½åˆ‡æ›
  oppoSel.onchange = ()=>{
    const vid = Number(oppoSel.value||NaN);
    renderRadar(me, Number.isFinite(vid) ? rowById(vid) : null);
  };

  // é¡¯ç¤ºå½ˆçª—
  document.getElementById('radarModal').classList.remove('hidden');
}

// é—œé–‰
document.getElementById('closeRadar').addEventListener('click', ()=>{
  document.getElementById('radarModal').classList.add('hidden');
});
document.getElementById('radarModal').addEventListener('click', (e)=>{
  if(e.target.id === 'radarModal') e.currentTarget.classList.add('hidden');
});
</script>

</body>
</html>
