<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>å‰å¤§èˆªé“çˆ­éœ¸æˆ°ï½œæ­£å¼å°æˆ°</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <style>
    html,body{height:100%;background:#0f1113;color:#eaecee}
    .card{ background: rgba(16,20,24,.80);              /* å¾®é€æ˜é¢æ¿è‰²ï¼š#101418 / 80% */
  -webkit-backdrop-filter: blur(6px);
  backdrop-filter: blur(6px);                   /* ç»ç’ƒæ¯›ç»ç’ƒæ•ˆæœ */
  border: 1px solid rgba(255,255,255,.06);      /* é‚Šç·šèª¿æ·¡ï¼Œè·Ÿæ•´é«”æ›´æ­ */
  border-radius: 16px; }
    .thumb{ width:68px; aspect-ratio:1242/1863; object-fit:cover; border-radius:10px; border:1px solid #2f353c; background:#0a0d10 }
    .thumb-sm{ width:42px; aspect-ratio:1242/1863; object-fit:cover; border-radius:8px; border:1px solid #2f353c; background:#0a0d10 }
    .deck{ position:relative; width:120px; aspect-ratio:1242/1863; border-radius:14px; border:1px solid #2a2f35; overflow:hidden; box-shadow:0 12px 28px rgba(0,0,0,.45) }
    .deck > img{ width:100%; height:100%; object-fit:cover; background:#0a0d10 }
    .deck .cnt{ position:absolute; right:-8px; top:-8px; background:#facc15; color:#111; border-radius:999px; padding:.15rem .45rem; font-size:12px; border:1px solid #caa902 }
    .modal{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,.55); z-index:50 }

    /* === FX: Glow / Flip / Shake / Pulse === */
    @keyframes fx-glow { 0% { box-shadow: 0 0 0 rgba(250, 204, 21, 0); } 50% { box-shadow: 0 0 24px rgba(250, 204, 21, .6); } 100% { box-shadow: 0 0 0 rgba(250, 204, 21, 0); } }
    .fx-glow { animation: fx-glow .8s ease-out 1; }
    @keyframes fx-flip { 0%{ transform: rotateY(0deg) scale(0.9); filter: brightness(1.1); } 50%{ transform: rotateY(90deg) scale(1.05); filter: brightness(1.3); } 100%{ transform: rotateY(180deg) scale(1.0); filter: brightness(1.0);} }
    .fx-flip { transform-style: preserve-3d; animation: fx-flip .45s ease-out 1; }
    @keyframes fx-shake { 0%,100%{ transform: translateX(0);} 20%{ transform: translateX(-6px);} 40%{ transform: translateX(5px);} 60%{ transform: translateX(-4px);} 80%{ transform: translateX(3px);} }
    .fx-shake { animation: fx-shake .45s ease-out 1; }
    @keyframes fx-pulse { 0%{ transform: scale(1);} 40%{ transform: scale(1.15);} 100%{ transform: scale(1);} }
    .fx-pulse { animation: fx-pulse .45s ease-out 1; }

    /* === Duel Overlay === */
    #duelFx { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: radial-gradient(60% 60% at 50% 50%, rgba(0,0,0,.75), rgba(0,0,0,.9)); z-index: 80; }
    #duelFx.show { display: flex; }
    #duelFx .arena { position: relative; width: min(1000px, 92vw); height: min(460px, 64vh); border-radius: 16px; border: 1px solid #2b3138; background: linear-gradient(180deg,#0f1317,#0b0e11); box-shadow: 0 12px 40px rgba(0,0,0,.55) inset; overflow: hidden; }
    #duelFx .slot { position: absolute; top: 50%; width: 40%; max-width: 360px; aspect-ratio: 1242/1863; transform: translateY(-50%) translateX(0); display: flex; flex-direction: column; gap: 10px; align-items: center; }
    #duelFx .slot.left { left: 8%; }
    #duelFx .slot.right{ right: 8%; }
    #duelFx .cardimg { width: 100%; height: 100%; border-radius: 14px; border: 1px solid #2f353c; background:#0a0d10; box-shadow: 0 18px 36px rgba(0,0,0,.45); transform-origin: center; }
    #duelFx .meta { display:flex; align-items:center; gap:10px; padding: 6px 10px; border:1px solid #2b3138; border-radius: 999px; background:#12171c; color:#e6e9ee; font-size: 14px; }
    #duelFx .meta img { width:28px; height:28px; border-radius:999px; border:1px solid #2b3138; }
    #duelFx .pid{ opacity:.9; font-weight:600; }
    #duelFx .vs { position:absolute; left:50%; top:50%; transform: translate(-50%,-50%) scale(0.8); font-weight: 900; letter-spacing:.05em; font-size: clamp(48px, 9vw, 110px); color: #f5d15a; text-shadow: 0 0 30px rgba(245,209,90,.85), 0 0 8px rgba(0,0,0,.6); opacity: 0; transition: opacity .25s ease, transform .25s ease. }
    #duelFx .arena.spread .slot.left  { transform: translateY(-50%) translateX(-12%); }
    #duelFx .arena.spread .slot.right { transform: translateY(-50%) translateX( 12%); }
    #duelFx .arena.spread .vs { opacity:1; transform: translate(-50%,-50%) scale(1); }
    #duelFx .arena.collide .slot.left, #duelFx .arena.collide .slot.right { transform: translateY(-50%) translateX(0) scale(1.05); }
    #duelFx .arena.collide .vs { opacity:0; transform: translate(-50%,-50%) scale(0.9); }

    @keyframes burn { 0%{ filter: brightness(1) saturate(1); box-shadow: 0 0 0 rgba(255,120,0,0); transform: none; opacity:1; } 30%{ filter: brightness(1.25) saturate(1.5); box-shadow: 0 0 26px rgba(255,140,0,.65);} 60%{ filter: brightness(1.5) saturate(2) hue-rotate(-12deg); transform: rotate(-2deg) scale(1.06);} 100%{ opacity:0; transform: translateY(-24px) scale(0.9); filter: brightness(1.6) saturate(2.2);} }
    @keyframes flame { 0%,100%{ opacity:.35; transform: translate(-50%,-55%) scale(1); filter:hue-rotate(-10deg) saturate(1.5);} 50%{ opacity:.65; transform: translate(-50%,-60%) scale(1.08); filter:hue-rotate(-18deg) saturate(2);} }
    .burning .cardimg { position: relative; animation: burn .9s ease-out forwards; }
    .burning .cardimg::after{ content:''; position:absolute; left:50%; top:50%; width: 140%; height: 140%; background: radial-gradient(35% 25% at 50% 30%, rgba(255,230,120,.85), transparent 60%), radial-gradient(50% 40% at 50% 60%, rgba(255,120,0,.55), transparent 70%); mix-blend-mode: screen; pointer-events: none; transform: translate(-50%,-55%); animation: flame .9s ease-out forwards; }

    /* å¼·åŒ–ç‰¹æ•ˆï¼šå…‰çƒ */
    .fx-orb { position: fixed; width: 14px; height: 14px; border-radius: 999px;
      background: radial-gradient(circle at 40% 40%, #fff, #facc15 55%, rgba(250,204,21,.2) 70%);
      box-shadow: 0 0 16px rgba(250,204,21,.9), 0 0 36px rgba(250,204,21,.55);
      pointer-events:none; z-index: 90; opacity:.95;
      transition: transform .6s cubic-bezier(.2,.7,.1,1), opacity .2s ease .5s;
    }

    /* === æ“²ç¡¬å¹£ Overlay & å‹•ç•«æ¡† === */
    #coinOverlay {
      position: fixed;
      inset: 0;
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,.7);
      opacity: 0;
      pointer-events: none;
      transition: opacity .3s ease;
    }
    #coinOverlay.show { opacity: 1; pointer-events: auto; }

    #coinFrame {
      background: radial-gradient(circle at 50% 40%,rgba(24,28,32,0.9) 0%,rgba(12,14,16,0.92) 60%,rgba(0,0,0,0.0) 100%);
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.06);
      box-shadow: 0 24px 48px rgba(0,0,0,.8), 0 2px 4px rgba(0,0,0,.6), 0 0 1px rgba(255,255,255,.08) inset, 0 0 30px rgba(0,0,0,.6) inset;
      padding: 16px;
      width: 400px; max-width: 90vw; max-height: 90vh;
      display: flex; align-items: center; justify-content: center;
      transform: scale(.9); transition: transform .3s ease;
    }
    #coinOverlay.show #coinFrame { transform: scale(1); }
    #coinFrame video { width: 100%; height: auto; max-height: 70vh; border-radius: 12px; box-shadow: 0 12px 28px rgba(0,0,0,.6); outline: none; }
    #coinOverlay video { outline: none; }

    /* === æ‰“å‡ºå¡ç‰‡ã€Œå¿«é–ƒã€Overlayï¼ˆæ–°å¢ï¼‰ === */
    #playedOverlay{ position:fixed; inset:0; z-index: ninetyfive; z-index:95; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,.72); opacity:0; pointer-events:none; transition:opacity .25s ease; }
    #playedOverlay.show{ opacity:1; pointer-events:auto; }
    #playedFrame{ display:flex; flex-direction:column; gap:10px; align-items:center; }
    #playedImg{ width:min(40vw,320px); height:auto; border-radius:14px; border:1px solid #2f353c; box-shadow:0 18px 36px rgba(0,0,0,.45); }
    #playedMeta{ font-size:14px; color:#cbd5e1; opacity:.95; }

    
/* === å ´åœ°èƒŒæ™¯ç›´æ¥æ›åœ¨ bodyï¼ˆv2ï¼‰ === */
:root{
  --venue-bg-url: none;  /* ç”± JS å‹•æ…‹è¨­å®š */
}

/* é è¨­ä½ çš„åŸæœ¬èƒŒæ™¯ */
body{
  background:
    radial-gradient(1200px 800px at 10% 20%, rgba(255,184,77,.06), transparent 60%),
    radial-gradient(1200px 800px at 90% 80%, rgba(0,158,255,.05), transparent 60%),
    linear-gradient(180deg,#0f1113 0%,#14171a 100%);
  transition: background-image .25s ease, background-size .25s ease, background-position .25s ease;
}

/* å•Ÿç”¨å ´åœ°èƒŒæ™¯æ™‚ï¼šæŠŠåœ–ç‰‡ç–Šåœ¨æœ€åº•å±¤ï¼Œå†è¦†ä¸€é»æ·¡æ·¡çš„é®ç½©ï¼Œç¶­æŒå¯è®€æ€§ */
body.venue-on{
  background-image:
    var(--venue-bg-url), /* å ´åœ°åœ–ç‰‡ï¼ˆæœ€åº•å±¤ï¼‰ */
    radial-gradient(1200px 800px at 10% 20%, rgba(0,0,0,.18), transparent 60%),
    radial-gradient(1200px 800px at 90% 80%, rgba(0,0,0,.18), transparent 60%),
    linear-gradient(180deg,#0f1113 0%,#14171a 100%);
  background-size: cover, auto, auto, auto;
  background-position: center, center, center, center;
  background-repeat: no-repeat, no-repeat, no-repeat, no-repeat;
  background-attachment: fixed, fixed, fixed, fixed; /* æ»‘å‹•æ™‚æ›´ç©©å®š */
}

/* ç©å®¶å°æ¡†ï¼šèƒŒæ™¯å®Œå…¨é€æ˜ï¼ˆç§»é™¤æ¯›ç»ç’ƒã€ä¿ç•™é‚Šç·šï¼‰ */
#players .border,
#players .border-amber-400,
#players [class*="bg-\\[\\#12161b\\]"],
#players .card{
  background: transparent !important;
  -webkit-backdrop-filter: none !important;
  backdrop-filter: none !important;
  box-shadow: none !important;  /* è‹¥åŸæœ¬æœ‰é™°å½±æƒ³æ¸…æ‰ */
}

/*ï¼ˆå¯é¸ï¼‰ç›®å‰å›åˆæ¡†ä»çµ¦ä¸€é»é‡‘è‰²è¼ªå»“ï¼ŒèƒŒæ™¯ä¿æŒé€æ˜ */
#players .current{
  background: transparent !important;
  box-shadow: 0 0 0 1px rgba(255,200,80,.35) !important;
}

/*ï¼ˆå¯é¸ï¼‰è®“ç©å®¶å¡æ–‡å­—åœ¨ä»»ä½•åº•åœ–ä¸Šéƒ½æ¸…æ¥šäº› */
#players .card, 
#players .card *{
  text-shadow: 0 1px 1px rgba(0,0,0,.35);
}
/* === ç©å®¶æ¡†æ¶è¦–è¦ºçµ±ä¸€ === */

/* é è¨­ï¼šæ‰€æœ‰ç©å®¶å°æ¡† å…¨é€æ˜åº• + ç™½è‰²åŠé€æ˜è¼ªæ¡† */
#players .card,
#players .border,
#players .border-amber-400,
#players [class*="bg-\\[\\#12161b\\]"]{
  background: transparent !important;
  -webkit-backdrop-filter: none !important;
  backdrop-filter: none !important;
  border: 1.5px solid rgba(255,255,255,.25) !important; /* ç™½è‰²åŠé€æ˜é‚Šç·š */
  border-radius: 14px;
  box-shadow: none !important;
  transition: border-color .25s ease, box-shadow .25s ease;
}

/* ç•¶å‰å›åˆçš„ç©å®¶ï¼ˆä¿æŒé‡‘é‚Šæˆ–äº®é‚Šï¼‰ */
#players .current,
#players .is-turn,
#players .active{
  border: 1.8px solid rgba(255,200,80,.85) !important;  /* é‡‘è‰²äº®é‚Š */
  box-shadow: 0 0 10px rgba(255,200,80,.4) !important;
}

/* è¢«æ·˜æ±°æˆ–ç„¡æ³•è¡Œå‹•çš„ç©å®¶ï¼ˆç°é‚Šã€é™ä½é€æ˜åº¦ï¼‰ */
#players .eliminated,
#players .disabled{
  opacity: .55;
  border-color: rgba(255,255,255,.1) !important;
}

/* è®“ç©å®¶åç¨±ã€é‡‘å¹£æ•¸åœ¨ä»»ä½•èƒŒæ™¯ä¸Šéƒ½æ¸…æ¥š */
#players .card *,
#players .border *,
#players .border-amber-400 *{
  text-shadow: 0 1px 2px rgba(0,0,0,.5);
}

/* === åªç§»é™¤ç©å®¶é ­åƒçš„é‚Šæ¡†/å¤–æ¡†/é™°å½± === */
#players .avatar,
#players .avatar img,
#players img.avatar,
#players img.rounded-full,
#players .player-avatar,
#players .player-avatar img {
  border: none !important;
  outline: none !important;
  box-shadow: none !important;
}

/* å¦‚æœä½ çš„é ­åƒå¤–é¢é‚„åŒ…äº†ä¸€å±¤æœ‰é‚Šæ¡†çš„å®¹å™¨ï¼ˆå¸¸è¦‹ avatar-wrap/containerï¼‰ */
#players .avatar-wrap,
#players .avatar-container {
  border: none !important;
  outline: none !important;
  box-shadow: none !important;
}

/* ä¿éšªï¼šç©å®¶å¡ä¸­çš„æ‰€æœ‰ img éƒ½ä¸åŠ é‚Šæ¡†ï¼ˆä¸å½±éŸ¿å¤–å±¤å¡ç‰‡é‚Šæ¡†ï¼‰ */
#players .card img {
  border: none !important;
  box-shadow: none !important;
  outline: none !important;
}

/* 1) æŠŠåŸæœ¬ body çš„èƒŒæ™¯äº¤çµ¦ä¸€å€‹å›ºå®šåœ–å±¤è™•ç† */
html, body{
  min-height: 100%;
  background: none !important;   /* å…ˆæ¸…æ‰åŸæœ¬æœƒæ²å‹•çš„èƒŒæ™¯ */
}

body{
  position: relative;             /* è®“ ::before å¯ä»¥æ­£å¸¸ç–Šåº• */
  --venue-bg-url: none;           /* ç”± JS è¨­å®š url("...") æˆ– none */
}

/* 2) å›ºå®šåœ¨è¦–çª—åº•ä¸‹çš„èƒŒæ™¯åœ–å±¤ï¼ˆä¸è·Ÿè‘—æ²å‹•ï¼‰ */
body::before{
  content: '';
  position: fixed;
  inset: 0;                       /* ä½”æ»¿è¦–çª— */
  z-index: -1;                    /* æ°¸é åœ¨æ‰€æœ‰å…§å®¹ä¹‹ä¸‹ */
  background:
    var(--venue-bg-url),                                              /* å ´åœ°åœ– */
    radial-gradient(1200px 800px at 10% 20%, rgba(0,0,0,.18), transparent 60%),
    radial-gradient(1200px 800px at 90% 80%, rgba(0,0,0,.18), transparent 60%),
    linear-gradient(180deg,#0f1113 0%,#14171a 100%);                  /* åŸæœ¬çš„æ¼¸å±¤åº• */
  background-size: cover, auto, auto, auto;
  background-position: center, center, center, center;
  background-repeat: no-repeat, no-repeat, no-repeat, no-repeat;
  /* ä¸ç”¨ background-attachmentï¼Œå› ç‚ºæœ¬èº«å°±æ˜¯ fixed å±¤ */
}

/* 3) æŠŠæœƒæ“‹ä½çš„ä¸»å®¹å™¨æ”¹æˆé€æ˜ï¼ˆé¿å…ã€Œé»‘è‰²æ±è¥¿ã€å¾€ä¸Šè“‹ï¼‰ */
#app, .table, .board, main, .page, .wrap{
  background: transparent !important;
}


/* ===== BGM æ’­æ”¾æ¢ï¼šç™½è‰²åŠé€æ˜æŒ‰éˆ• & æ¸…å–® ===== */
#bgmBar{
  border-color: rgba(255,255,255,.12) !important;
  background: rgba(20,24,28,.65) !important;
  -webkit-backdrop-filter: blur(6px);
  backdrop-filter: blur(6px);
}
#bgmBar button{
  color: #fff;
  border: 1px solid rgba(255,255,255,.18);
  background: rgba(255,255,255,.06);
  border-radius: 10px;
  padding: 6px 10px;
  line-height: 1;
  user-select: none;
  transition: background .2s ease, border-color .2s ease, transform .05s ease;
}
#bgmBar button:hover{
  background: rgba(255,255,255,.12);
  border-color: rgba(255,255,255,.28);
}
#bgmBar button:active{
  transform: translateY(1px);
}
#bgmBar button:focus{ outline: none; box-shadow: none; }

/* éš¨æ©Ÿé–‹å•Ÿçš„ç‹€æ…‹ */
#bgmBar .is-active{
  background: rgba(255,255,255,.18);
  border-color: rgba(255,255,255,.38);
  font-weight: 600;
}

/* æ›²ç›®æ¸…å–®å½ˆå±¤ */
#bgmMenu{
  position: absolute;
  right: 0;
  top: calc(100% + 6px);
  width: min(72vw, 420px);
  max-height: 52vh;
  overflow: auto;
  padding: 8px;
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(16,20,24,.88);
  -webkit-backdrop-filter: blur(8px);
  backdrop-filter: blur(8px);
  border-radius: 14px;
  box-shadow: 0 10px 32px rgba(0,0,0,.45);
  z-index: 60;
}
#bgmMenu .item{
  display: flex; align-items: center; gap: 8px;
  padding: 8px 10px; border-radius: 10px; cursor: pointer;
  color: #fff; font-size: 13px;
  border: 1px solid transparent;
}
#bgmMenu .item:hover{
  background: rgba(255,255,255,.08);
  border-color: rgba(255,255,255,.12);
}
#bgmMenu .item.active{
  background: rgba(255,255,255,.14);
  border-color: rgba(255,255,255,.28);
  font-weight: 600;
}

/* === BGM åœ“è§’ SVG æŒ‰éˆ• === */
#bgmBar .icon-btn{
  width: 36px; height: 36px;
  border-radius: 12px;
  color: #fff;
  border: 1px solid rgba(255,255,255,.18);
  background: rgba(255,255,255,.06);
  display: inline-flex; align-items: center; justify-content: center;
  transition: background .18s ease, transform .06s ease, border-color .18s ease, box-shadow .18s ease;
}
#bgmBar .icon-btn:hover{
  background: rgba(255,255,255,.12);
  border-color: rgba(255,255,255,.28);
  box-shadow: 0 6px 18px rgba(0,0,0,.25);
}
#bgmBar .icon-btn:active{ transform: translateY(1px); }
#bgmBar .icon-btn.big{ width: 40px; height: 40px; font-weight: 700; }

/* éš¨æ©Ÿå•Ÿå‹•æ™‚æœ‰äº®åº¦ï¼ˆæ²¿ç”¨ is-activeï¼‰ */
#bgmShuffle.is-active{
  background: rgba(255,255,255,.18);
  border-color: rgba(255,255,255,.38);
}

/* SVG çµ±ä¸€å°ºå¯¸ï¼ˆä¸ç”¨æ¯å€‹éƒ½è¨­ï¼‰ */
#bgmBar .icon-btn svg{ width: 18px; height: 18px; fill: currentColor; }
#bgmBar .icon-btn.big svg{ width: 20px; height: 20px; }

/* æ›²åä¾èˆŠå¯é»å±•é–‹æ¸…å–® */
#bgmTitle{ cursor: pointer; }

#bgmMenu .dot{ width: 8px; height: 8px; border-radius: 50%; background: currentColor; opacity:.8; }

/* BGM æ’­æ”¾å™¨æ¢ï¼šæ”¹ç‚ºå®Œå…¨é€æ˜åº•ï¼ˆä¸å½±éŸ¿æŒ‰éˆ•å¤–è§€ï¼‰ */
#bgmBar{
  background: transparent !important;
  border-color: transparent !important;
  -webkit-backdrop-filter: none !important;
  backdrop-filter: none !important;
  box-shadow: none !important;
  padding-left: 0 !important;  /* å¯é¸ï¼šè®“æ¢æ›´è²¼åˆå³å´ */
  padding-right: 0 !important; /* å¯é¸ */
}

/* è‹¥æƒ³ä¿ç•™ä¸€é»ç´°ç·šè¼ªå»“ï¼Œæ”¹ç”¨é€™ä¸€è¡Œå–ä»£ä¸Šé¢çš„ border-color è¨­å®š */
// #bgmBar{ border-color: rgba(255,255,255,.10) !important; }


/* === LAW & LUFFY modals visibility === */
#lawSwapModal.hidden, #luffyBoostModal.hidden { display:none; }

.deck .cnt{ display:none !important; }

/* === ç‰Œå †å¤–åœˆç´…è‰²å‘¼å¸å…‰ï¼ˆä¸å‹•åœ–ç‰‡æœ¬é«”ï¼‰ === */
@keyframes deckHaloBreath {
  0%,100% { opacity: .28; box-shadow:
      0 0 0 2px rgba(239,68,68,.35),
      0 0 18px 6px rgba(239,68,68,.25); }
  50%     { opacity: .95; box-shadow:
      0 0 0 3px rgba(239,68,68,.55),
      0 0 30px 12px rgba(239,68,68,.38); }
}

#btnDraw.hot{
  position: relative;
  overflow: visible;              /* è®“å¤–åœˆä¸è¢«è£åˆ‡ */
  border-radius: 12px;            /* å¤–åœˆåœ“è§’ï¼Œå°é½Šä½ åŸæœ¬æŒ‰éˆ• */
}

/* åªåšå¤–åœˆå…‰æšˆï¼šæ”¾åœ¨ ::afterï¼Œä¸å½±éŸ¿é»æ“Š */
#btnDraw.hot::after{
  content: '';
  position: absolute;
  inset: -8px;                    /* å¤–åœˆè·é›¢ï¼Œèª¿å¤§å¯æ›´å¤–æ“´ */
  border-radius: 16px;
  pointer-events: none;
  animation: deckHaloBreath 2.2s ease-in-out infinite;
}

/* ä¿è­‰åœ–ç‰‡æœ¬é«”ä¸è¢«æ”¹å‹•ï¼ˆé¿å…ä¹‹å‰çš„æ¨£å¼æ®˜ç•™ï¼‰ */
#btnDraw #deckImg{
  outline: none !important;
  box-shadow: none !important;
  animation: none !important;
}

/* å°Šé‡ã€Œæ¸›å°‘å‹•æ…‹ã€åå¥½ï¼šä¿ç•™éœæ…‹æé‚Šã€åœç”¨å‹•ç•« */
@media (prefers-reduced-motion: reduce){
  #btnDraw.hot::after{ animation: none !important; }
}


</style>
</head>
<body>
<header class="sticky top-0 z-40 bg-[#101418]/80 backdrop-blur border-b border-[#1c2229]">
  <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
    <!-- å·¦å´æ¨™é¡Œ -->
    <div class="font-semibold tracking-wide">å‰å¤§èˆªé“çˆ­éœ¸æˆ°</div>

    <!-- æˆ¿è™Ÿ/é€£ç·šï¼šç•™è‘—çµ¦ç¨‹å¼ç”¨ï¼Œä½†ç•«é¢éš±è— -->
    <div class="hidden text-xs px-2 py-1 rounded border border-neutral-700">æˆ¿è™Ÿï¼š<span id="roomLbl">â€”</span></div>
    <div class="hidden text-xs px-2 py-1 rounded border border-neutral-700">é€£ç·šï¼š<span id="connLbl" class="text-red-400">disconnected</span></div>

    <!-- ä¿ç•™å¯¶ç®±ï¼ˆå¯è¦‹ï¼‰ -->
    <div class="text-xs px-2 py-1 rounded border border-neutral-700">å¯¶ç®±å‰©é¤˜ï¼š<span id="chestLbl">0</span> æš</div>

    <!-- æ‹‰åˆ°æœ€å³é‚Šï¼šéŸ³æ¨‚æ¢ -->
    <div class="ml-auto flex items-center gap-2 w-full sm:w-auto">
      <div id="bgmBar" class="flex items-center gap-2 px-2 py-1 rounded-lg border border-[#2a2f35] bg-[#14181c]/80">
        <!-- æ§åˆ¶éˆ• -->
       <button id="bgmPrev" class="icon-btn" title="ä¸Šä¸€é¦–" aria-label="ä¸Šä¸€é¦–">
  <!-- ä¸Šä¸€é¦–ï¼š|â—€ -->
  <svg viewBox="0 0 24 24" aria-hidden="true">
    <path d="M7 12L18 5v14L7 12zM6 5h2v14H6z"/>
  </svg>
</button>

<button id="bgmPlay" class="icon-btn big" title="æ’­æ”¾/æš«åœ" aria-label="æ’­æ”¾/æš«åœ">
  <!-- â–¶ -->
  <svg id="iconPlay" viewBox="0 0 24 24" aria-hidden="true">
    <path d="M8 5v14l11-7z"/>
  </svg>
  <!-- â¸ï¼ˆé è¨­éš±è—ï¼Œæ’­æ”¾æ™‚é¡¯ç¤ºï¼‰ -->
  <svg id="iconPause" class="hidden" viewBox="0 0 24 24" aria-hidden="true">
    <path d="M6 5h4v14H6zm8 0h4v14h-4z"/>
  </svg>
</button>

<button id="bgmNext" class="icon-btn" title="ä¸‹ä¸€é¦–" aria-label="ä¸‹ä¸€é¦–">
  <!-- â–¶| -->
  <svg viewBox="0 0 24 24" aria-hidden="true">
    <path d="M6 6l11 6-11 6V6zm12 0h2v12h-2z"/>
  </svg>
</button>

<button id="bgmShuffle" class="icon-btn" title="éš¨æ©Ÿæ’­æ”¾" aria-label="éš¨æ©Ÿæ’­æ”¾">
  <!-- äº¤éŒ¯ç®­é ­ -->
  <svg viewBox="0 0 24 24" aria-hidden="true">
    <path d="M17 3h4v4h-2V6h-2.17l-3.9 3.9 1.41 1.41L18.83 8H19v2h2V6a3 3 0 0 0-4-3zM4 6h5.17l3.9 3.9-1.41 1.41L7.17 8H4V6zm0 12h3.17l3.9-3.9 1.41 1.41L8.83 20H4v-2zm17-2v4h-4a3 3 0 0 1-3-3v-.17l-2.1-2.1 1.41-1.41 2.69 2.69c.24.24.57.39.91.39H19v-2h2z"/>
  </svg>
</button>

        <!-- éŸ³é‡ -->
        <div class="flex items-center gap-1 ml-1">
          <span class="text-xs opacity-70">ğŸ”Š</span>
          <input id="bgmVol" type="range" min="0" max="1" step="0.01" value="0.7"
                 class="w-24 accent-amber-300" />
        </div>

        <!-- æ›²å -->
        <div id="bgmTitle"
             class="text-xs sm:max-w-[280px] md:max-w-[360px] truncate ml-2 opacity-90">
          æœªæ’­æ”¾
        </div>

        <!-- éš±è— audio å…ƒä»¶ -->
        <audio id="bgmAudio" preload="auto"></audio>
      </div>
    </div>

    <!-- é€™ä¸‰å€‹è¼¸å…¥ç•™è‘—ä½†éš±è—ï¼Œé¿å…æ‰“å£ä½ ç¾æœ‰ JS ç¶å®š -->
    <input id="inpName" class="hidden w-40 px-2 py-1.5 rounded-lg border border-neutral-700 bg-[#14181c]" placeholder="æš±ç¨±"/>
    <input id="inpRoom" class="hidden w-28 px-2 py-1.5 rounded-lg border border-neutral-700 bg-[#14181c]" placeholder="æˆ¿è™Ÿ"/>
    <button id="btnJoin" class="hidden px-3 py-1.5 rounded-lg border border-neutral-700 bg-[#14181c] hover:bg-[#192028]">åŠ å…¥</button>
  </div>
</header>

  <main class="max-w-7xl mx-auto px-3 md:px-4 py-4 grid gap-4 lg:grid-cols-[1.2fr_.8fr]">
    <section class="space-y-3">
      <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
        <div class="card p-3 md:col-span-2">
          <div class="text-sm mb-2 opacity-80">æœ¬å±€å ´åœ°</div>
          <div id="venues" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-2"></div>
        </div>
        <div class="card p-3 flex items-center justify-between gap-3">
  <div class="text-sm opacity-80">
    ç‰Œå †
    <span id="deckCnt" class="ml-2 px-1.5 py-0.5 rounded border border-[#2a2f35] text-amber-300 font-semibold">0</span>
  </div>
  <button id="btnDraw" class="deck">
    <img id="deckImg" src="images/cards/back.png" alt="deck"/>
    <!-- å·²ç§»é™¤èˆŠçš„ .cnt å¾½ç«  -->
  </button>
</div>

        <div class="card p-3 md:col-span-3">
          <div class="flex items-center justify-between mb-2">
            <div class="text-sm opacity-80">æ£„ç‰Œ</div>
            <button id="btnNextRound" class="hidden px-3 py-1.5 rounded-lg border border-amber-400 bg-amber-300 text-black text-sm">ä¸‹ä¸€å±€ â–¶</button>
          </div>
            <div id="discard" class="flex gap-2 overflow-x-auto"></div>
        </div>
      </div>

      <div id="myPlayZone" class="hidden grid grid-cols-1 sm:grid-cols-2 gap-3">
        <button id="playHand" class="border border-[#2f353c] rounded-xl overflow-hidden"><img id="imgHand" src=""/></button>
        <button id="playDrawn" class="border border-[#2f353c] rounded-xl overflow-hidden"><img id="imgDrawn" src=""/></button>
      </div>

      <div class="card p-3">
        <div class="flex items-center justify-between mb-2">
          <div class="text-sm opacity-80">å°å±€æ—¥èªŒ</div>
          <div class="text-xs text-neutral-400">è¼ªåˆ°ï¼š<span id="turnLbl">â€”</span>ï½œéšæ®µï¼š<span id="stepLbl">â€”</span></div>
        </div>
        <ol id="logBox" class="text-sm space-y-1 list-decimal pl-5 max-h-72 overflow-auto"></ol>
      </div>
    </section>

    <aside class="space-y-3">
      <div class="card p-3">
        <div class="text-sm mb-2 opacity-80">ç©å®¶</div>
        <div id="players" class="grid gap-2"></div>
      </div>
      <!-- è¨Šæ¯é¢æ¿å·²ç§»é™¤ -->
    </aside>
  </main>

  <div id="modal" class="modal hidden"><div class="card w-[min(92vw,680px)] p-4"></div></div>

  <!-- Duel Overlay -->
  <div id="duelFx">
    <div class="arena">
      <div class="slot left">
        <img class="cardimg" src="images/cards/back.png" alt="left"/>
        <div class="meta">
          <img class="ava" src="images/avatars/1.png" alt="ava"/>
          <span class="pid">P1</span>
        </div>
      </div>
      <div class="slot right">
        <img class="cardimg" src="images/cards/back.png" alt="right"/>
        <div class="meta">
          <img class="ava" src="images/avatars/2.png" alt="ava"/>
          <span class="pid">P2</span>
        </div>
      </div>
      <div class="vs">VS</div>
    </div>
  </div>

  <!-- å¯¶ç®±æ¸…ç©º â†’ çµç®—å‰ 7 ç§’åœ–ç‰‡ -->
  <div id="finalOverlay" class="hidden fixed inset-0 z-[220] flex items-center justify-center bg-black/80">
    <div class="relative">
      <!-- ä¸Šæ–¹æ–‡å­— -->
      <div class="absolute left-1/2 -translate-x-1/2 top-4 sm:top-6
                  text-white text-xl sm:text-2xl font-bold tracking-wide
                  drop-shadow-[0_0_10px_rgba(0,0,0,0.9)]">
        å¯¶ç®±å·²ç©ºï¼Œç­‰å¾…çµç®—...
      </div>
      <!-- ä¸­é–“åœ–ç‰‡ï¼šæ›æˆä½ è‡ªå·±çš„åœ–æª”è·¯å¾‘ -->
      <img src="images/final_ready.png"
           alt="å¯¶ç®±å·²ç©ºï¼Œç­‰å¾…çµç®—"
           class="max-h-[80vh] rounded-2xl shadow-2xl border border-white/20">
    </div>
  </div>

  <!-- æ“²ç¡¬å¹£å‹•ç•«ï¼ˆåªæœ‰æœ¬æ©Ÿæ’­æ”¾ï¼‰ -->
  <div id="coinOverlay" class="hidden">
    <div id="coinFrame">
      <video id="coinVideo" src="videos/coin.mp4" playsinline preload="auto"></video>
    </div>
  </div>

  <!-- ä¸€æ¬¡æ€§ã€Œå½±éŸ³è§£é–ã€éš±è—å½±ç‰‡ï¼ˆiOS ç”¨ï¼‰ -->
  <video id="mediaUnlocker"
         playsinline
         preload="auto"
         class="hidden"
         src="videos/gamestart.mp4">
  </video>

  <!-- æ‰“å‡ºå¡ç‰‡ã€Œå¿«é–ƒã€Overlayï¼ˆæ–°å¢ï¼‰ -->
  <div id="playedOverlay" class="hidden">
    <div id="playedFrame">
      <img id="playedImg" src="images/cards/back.png" alt="played"/>
      <div id="playedMeta" class="text-sm"></div>
    </div>
  </div>

  <!-- å¼·åŒ–æŠ€èƒ½å½±ç‰‡ï¼ˆå…¨é«”æ’­æ”¾ï¼‰ -->
  <div id="enhOverlay" class="hidden fixed inset-0 z-[140] flex items-center justify-center bg-black/70">
    <video id="enhVideo" playsinline preload="auto" class="max-w-[80vw] max-h-[80vh] rounded-xl shadow-2xl"></video>
  </div>



  <!-- === ç¾…ï¼ˆå¼·åŒ–ï¼‰æŸ¥çœ‹å¾Œçš„äº¤æ›è©¢å•æ¡† === -->
  <div id="lawSwapModal" class="hidden fixed inset-0 z-[90] flex items-center justify-center bg-black/70">
    <div class="w-[min(560px,92vw)] rounded-2xl border border-neutral-700/70 bg-neutral-900/80 backdrop-blur p-5">
      <div class="text-lg font-bold mb-3">ROOMãƒ»SCAN</div>
      <div class="flex items-center gap-4 mb-4">
        <img id="lawTargetImg" class="w-40 h-56 object-contain rounded-lg border border-white/10" />
        <div class="text-sm opacity-80">
          <div class="mb-2">ç›®æ¨™ç©å®¶ï¼š<span id="lawTargetName" class="font-semibold"></span></div>
          <div>ä½ è¦å’Œä»–çš„æ‰‹ç‰Œäº¤æ›å—ï¼Ÿ</div>
        </div>
      </div>
      <div class="flex justify-end gap-2">
        <button id="lawSwapCancel" class="px-3 py-1.5 rounded-lg border border-white/20 bg-white/10 hover:bg-white/20">å–æ¶ˆ</button>
        <button id="lawSwapOk" class="px-3 py-1.5 rounded-lg border border-white/20 bg-white/10 hover:bg-white/20">äº¤æ›</button>
      </div>
    </div>
  </div>

  <!-- === é­¯å¤«ï¼ˆå¼·åŒ–ï¼‰ç™¼å‹•ç¢ºèªæ¡† === -->
  <div id="luffyBoostModal" class="hidden fixed inset-0 z-[90] flex items-center justify-center bg-black/70">
    <div class="w-[min(520px,92vw)] rounded-2xl border border-neutral-700/70 bg-neutral-900/80 backdrop-blur p-5">
      <div class="text-lg font-extrabold mb-3">ç™¼å‹•</div>
      <div class="text-sm opacity-80 mb-4">é­¯å¤«å¼·åŒ–ï¼šæ˜¯å¦ç™¼å‹•ï¼Ÿ</div>
      <div class="flex justify-end">
        <button id="luffyBoostGo" class="px-4 py-2 rounded-lg border border-white/20 bg-white/10 hover:bg-white/20">
          çŒ¿ç‹ç¾¤é´‰ç‚®
        </button>
      </div>
    </div>
  </div>


<script>
/* === è·¯å¾‘å·¥å…· === */
const CARD     = id => `images/cards/${id}.png`;
const CARD_ENH = id => `images/cards/enh/${id}.png`; // â˜… å¼·åŒ–å¡é¢
const VEN      = name => `images/venues/${name}.png`;
const AVA      = a => `images/avatars/${a||1}.png`;

const el = {
  conn: document.getElementById('connLbl'),
  roomLbl: document.getElementById('roomLbl'),
  name: document.getElementById('inpName'),
  room: document.getElementById('inpRoom'),
  join: document.getElementById('btnJoin'),
  venues: document.getElementById('venues'),
  discard: document.getElementById('discard'),
  deckCnt: document.getElementById('deckCnt'),
  deckBtn: document.getElementById('btnDraw'),
  imgHand: document.getElementById('imgHand'),
  imgDrawn: document.getElementById('imgDrawn'),
  playZone: document.getElementById('myPlayZone'),
  playHand: document.getElementById('playHand'),
  playDrawn: document.getElementById('playDrawn'),
  players: document.getElementById('players'),
  log: document.getElementById('logBox'),
  /* msg: å·²ç§»é™¤ */
  turnLbl: document.getElementById('turnLbl'),
  stepLbl: document.getElementById('stepLbl'),
  modal: document.getElementById('modal'),
  chestLbl: document.getElementById('chestLbl'),
  nextRound: document.getElementById('btnNextRound'),
};


// === BGM æ’­æ”¾æ¸…å–®ï¼ˆç…§ä½ æä¾›çš„ 20 é¦–ï¼‰ ===
const BGM_LIST = [
  { title: "OP 01 â€“ ã‚¦ã‚£ãƒ¼ã‚¢ãƒ¼!(We Are)", src: "audio/bgm/track01.mp3" },
  { title: "OP 02 â€“ Believe", src: "audio/bgm/track02.mp3" },
  { title: "OP 03 â€“ ãƒ’ã‚«ãƒªã¸", src: "audio/bgm/track03.mp3" },
  { title: "OP 04 â€“ BON VOYAGE!", src: "audio/bgm/track04.mp3" },
  { title: "OP 05 â€“ ã‚³ã‚³ãƒ­ã®ã¡ãš", src: "audio/bgm/track05.mp3" },
  { title: "OP 06 â€“ BRAND NEW WORLD", src: "audio/bgm/track06.mp3" },
  { title: "OP 07 â€“ ã‚¦ã‚£ãƒ¼ã‚¢ãƒ¼!ï½7äººã®éº¥ã‚ã‚‰æµ·è³Šå›£ç¯‡ï½", src: "audio/bgm/track07.mp3" },
  { title: "OP 08 â€“ Crazy Rainbow", src: "audio/bgm/track08.mp3" },
  { title: "OP 09 â€“ Jungle P", src: "audio/bgm/track09.mp3" },
  { title: "OP 10 â€“ ã‚¦ã‚£ãƒ¼ã‚¢ãƒ¼!ï½ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¯ãƒ³ãƒ”ãƒ¼ã‚¹10é€±å¹´", src: "audio/bgm/track10.mp3" },
  { title: "OP 11 â€“ Share The World", src: "audio/bgm/track11.mp3" },
  { title: "OP 12 â€“ é¢¨ã‚’ã•ãŒã—ã¦", src: "audio/bgm/track12.mp3" },
  { title: "OP 13 â€“ One day", src: "audio/bgm/track13.mp3" },
  { title: "OP 14 â€“ Fight Together", src: "audio/bgm/track14.mp3" },
  { title: "OP 15 â€“ We Go!", src: "audio/bgm/track15.mp3" },
  { title: "OP 16 â€“ Hands Up!", src: "audio/bgm/track16.mp3" },
  { title: "OP 17 â€“ Wake up!", src: "audio/bgm/track17.mp3" },
  { title: "OP 18 â€“ Hard Knock Days", src: "audio/bgm/track18.mp3" },
  { title: "OP 19 â€“ We Can!", src: "audio/bgm/track19.mp3" },
  { title: "OP 20 â€“ Hope", src: "audio/bgm/track20.mp3" }
];

// === å–å¾— DOM ===
const bgmAudio   = document.getElementById('bgmAudio');
const bgmTitleEl = document.getElementById('bgmTitle');
const bgmPlayBtn = document.getElementById('bgmPlay');
const bgmPrevBtn = document.getElementById('bgmPrev');
const bgmNextBtn = document.getElementById('bgmNext');
const bgmVol     = document.getElementById('bgmVol');
const bgmShuffle = document.getElementById('bgmShuffle');
const iconPlay  = document.querySelector('#bgmPlay #iconPlay');
const iconPause = document.querySelector('#bgmPlay #iconPause');

function setPlayVisual(isPlaying){
  if (!iconPlay || !iconPause) return;
  if (isPlaying){
    iconPlay.classList.add('hidden');
    iconPause.classList.remove('hidden');
  }else{
    iconPause.classList.add('hidden');
    iconPlay.classList.remove('hidden');
  }
}


// è®“æ›²åå¯ç•¶ã€Œå±•é–‹æ¸…å–®ã€çš„åˆ‡æ›éˆ•
let bgmMenu = document.getElementById('bgmMenu');
if (!bgmMenu) {
  // å»ºç«‹å½ˆå±¤å®¹å™¨ï¼ˆæ”¾åœ¨ header è£¡ã€é å³å°é½Šï¼‰
  const header = document.querySelector('header .max-w-7xl') || document.querySelector('header > div');
  const anchor = header.querySelector('#bgmBar') || header;
  const wrap = document.createElement('div');
  wrap.style.position = 'relative';
  anchor.parentNode.insertBefore(wrap, anchor);
  wrap.appendChild(anchor);

  bgmMenu = document.createElement('div');
  bgmMenu.id = 'bgmMenu';
  bgmMenu.classList.add('hidden');
  wrap.appendChild(bgmMenu);
}

// === ç‹€æ…‹ ===
let bgmIndex   = Number(localStorage.getItem('bgm_index') || '0') % BGM_LIST.length;
let isShuffle  = localStorage.getItem('bgm_shuffle') === '1';
let userInteracted = false; // è§£é™¤ç€è¦½å™¨è‡ªå‹•æ’­æ”¾é™åˆ¶
let wasPlayingBeforeDuck = false; // å½±ç‰‡ä»‹å…¥å‰æ˜¯å¦åœ¨æ’­æ”¾
let duckSet = new Set(); // æ­£åœ¨æ’­æ”¾ä¸­çš„å½±ç‰‡é›†åˆï¼ˆåŒæ™‚å¤šæ®µä¹Ÿèƒ½æ­£ç¢ºå›å¾©ï¼‰

// === iOS / Safari å½±éŸ³è§£é–ï¼šéš±è—å½±ç‰‡æ’­ä¸€ä¸‹å°±è§£é–å¾ŒçºŒæœ‰è²æ’­æ”¾ ===
let _mediaUnlocked = false;

function unlockMediaOnce(){
  if (_mediaUnlocked) return;
  const v = document.getElementById('mediaUnlocker');
  if (!v) {
    _mediaUnlocked = true;
    return;
  }
let _mediaUnlocked = false;

function unlockMediaOnce(){
  if (_mediaUnlocked) return;
  const v = document.getElementById('mediaUnlocker');
  if (!v) {
    // æ²’é€™æ”¯å½±ç‰‡å°±ç®—äº†ï¼Œç•¶ä½œå·²è§£é–ï¼ˆé¿å…ä¸€ç›´ retryï¼‰
    _mediaUnlocked = true;
    return;
  }

  try { v.currentTime = 0; } catch(e){}

  // è¶…å°è²ã€æœ‰è²æ’­æ”¾ï¼ˆè§£é™¤å°å°ï¼‰ï¼Œæ™‚é–“æ‹‰å¾ˆçŸ­
  v.muted  = false;
  v.volume = 0.05;

  v.play().then(()=>{
    // âœ… åªæœ‰çœŸçš„é–‹å§‹æ’­äº†ï¼Œæ‰ç®—è§£é–æˆåŠŸ
    _mediaUnlocked = true;

    // æ’­ä¸€ä¸‹å°±å¥½ï¼ˆç´„ 0.2 ç§’ï¼‰
    setTimeout(()=>{
      try { v.pause(); } catch(e){}
    }, 200);
  }).catch(err=>{
    console.warn('media unlock failed', err);
    // âŒ æ’­å¤±æ•—ä¸è¦æŠŠ _mediaUnlocked è¨­æˆ trueï¼Œé€™æ¨£ä¸‹æ¬¡é»ç•«é¢é‚„èƒ½å†è©¦
  });
}


// ç©å®¶ç¬¬ä¸€æ¬¡é»ç•«é¢ â†’ åŒæ™‚æ¨™è¨˜äº’å‹• + è§£é–å½±éŸ³
function bindFirstInteractionUnlock(){
  const handler = ()=>{
    userInteracted = true;     // è·Ÿ BGM é‚£å€‹é‚è¼¯å…±ç”¨
    unlockMediaOnce();
    window.removeEventListener('pointerdown', handler);
    window.removeEventListener('touchstart', handler);
    window.removeEventListener('click', handler);
  };
  window.addEventListener('pointerdown', handler, { passive:true });
  window.addEventListener('touchstart', handler, { passive:true });
  window.addEventListener('click', handler, { passive:true });
}

// è¼‰å…¥è…³æœ¬å°±ç¶å®šä¸€æ¬¡
bindFirstInteractionUnlock();

// ===== UI ç¹ªè£½ =====
function paintTitle(){ bgmTitleEl.textContent = BGM_LIST[bgmIndex]?.title || 'æœªæ’­æ”¾'; }
function paintShuffleBtn(){
  if (isShuffle) bgmShuffle.classList.add('is-active');
  else bgmShuffle.classList.remove('is-active');
}
function renderMenu(){
  const cur = bgmIndex;
  const html = BGM_LIST.map((t,i)=>`
    <div class="item ${i===cur?'active':''}" data-i="${i}">
      <span class="dot" style="opacity:${i===cur?1:.35}"></span>
      <span class="title" style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${t.title}</span>
      <span class="sec" style="opacity:.7; font-size:12px;">${String(i+1).padStart(2,'0')}</span>
    </div>
  `).join('');
  bgmMenu.innerHTML = html || '<div class="text-xs opacity-70 p-2">ï¼ˆæ²’æœ‰æ›²ç›®ï¼‰</div>';
}

paintTitle(); paintShuffleBtn(); renderMenu();

// ===== åŸºæœ¬æ§åˆ¶ =====
function loadTrack(i, {autoPlay=false} = {}){
  if (!Number.isInteger(i)) return;
  bgmIndex = (i + BGM_LIST.length) % BGM_LIST.length;
  localStorage.setItem('bgm_index', String(bgmIndex));
  const item = BGM_LIST[bgmIndex]; if (!item) return;

  if (bgmAudio.getAttribute('src') !== item.src) {
    bgmAudio.setAttribute('src', item.src);
    try { bgmAudio.load(); } catch(e){}
  }
  paintTitle(); renderMenu();

   if (autoPlay && userInteracted) {
   bgmAudio.play().then(()=> setPlayVisual(true))
     .catch(()=> setPlayVisual(false));
 } else {
   setPlayVisual(false);
 }

}

function nextIndex(){
  if (!isShuffle) return (bgmIndex + 1) % BGM_LIST.length;
  if (BGM_LIST.length <= 1) return bgmIndex;
  let j = bgmIndex;
  while (j === bgmIndex) j = Math.floor(Math.random()*BGM_LIST.length);
  return j;
}
function prevIndex(){
  if (!isShuffle) return (bgmIndex - 1 + BGM_LIST.length) % BGM_LIST.length;
  return nextIndex();
}

// ===== äº‹ä»¶ï¼šæ§åˆ¶éˆ• =====
bgmPlayBtn.addEventListener('click', ()=>{
  userInteracted = true;
  if (bgmAudio.paused) {
    if (!bgmAudio.getAttribute('src')) loadTrack(bgmIndex);
    bgmAudio.play().then(()=> setPlayVisual(true));
  } else {
    bgmAudio.pause(); setPlayVisual(false);
  }
});


bgmNextBtn.addEventListener('click', ()=>{
  userInteracted = true; loadTrack(nextIndex(), {autoPlay:true});
});
bgmPrevBtn.addEventListener('click', ()=>{
  userInteracted = true; loadTrack(prevIndex(), {autoPlay:true});
});
bgmShuffle.addEventListener('click', ()=>{
  isShuffle = !isShuffle;
  localStorage.setItem('bgm_shuffle', isShuffle ? '1' : '0');
  paintShuffleBtn();
});
bgmVol.addEventListener('input', ()=>{
  const v = Number(bgmVol.value || '0.7');
  bgmAudio.volume = Math.max(0, Math.min(1, v));
  localStorage.setItem('bgm_vol', String(bgmAudio.volume));
});

// ===== æ›²å â†’ å±•é–‹/æ”¶åˆæ¸…å–® =====
function openMenu(){ bgmMenu.classList.remove('hidden'); }
function closeMenu(){ bgmMenu.classList.add('hidden'); }
function toggleMenu(){ bgmMenu.classList.toggle('hidden'); }
bgmTitleEl.style.cursor = 'pointer';
bgmTitleEl.title = 'é»æˆ‘å±•é–‹æ›²ç›®æ¸…å–®';
bgmTitleEl.addEventListener('click', ()=>{ toggleMenu(); });

// æ¸…å–®é»æ“Š
bgmMenu.addEventListener('click', (ev)=>{
  const it = ev.target.closest('.item'); if (!it) return;
  const i = Number(it.getAttribute('data-i'));
  userInteracted = true;
  loadTrack(i, {autoPlay:true});
  closeMenu();
});
// é»å¤–é¢é—œé–‰
document.addEventListener('click', (ev)=>{
  const bar = document.getElementById('bgmBar');
  if (!bar) return;
  if (!bar.contains(ev.target) && !bgmMenu.contains(ev.target)) closeMenu();
});
document.addEventListener('keydown', (ev)=>{ if (ev.key === 'Escape') closeMenu(); });

// ===== éŸ³é‡åˆå§‹åŒ– =====
(function initVolume(){
  const saved = Number(localStorage.getItem('bgm_vol'));
  if (Number.isFinite(saved) && saved >= 0 && saved <= 1) {
    bgmVol.value = String(saved); bgmAudio.volume = saved;
  } else {
    bgmVol.value = '0.7'; bgmAudio.volume = 0.7;
  }
})();

// æ’­å®Œè‡ªå‹•ä¸‹ä¸€é¦–
bgmAudio.addEventListener('ended', ()=>{ loadTrack(nextIndex(), {autoPlay:true}); });
bgmAudio.addEventListener('play',  ()=> setPlayVisual(true));
bgmAudio.addEventListener('pause', ()=> setPlayVisual(false));
bgmAudio.addEventListener('ended', ()=>{ setPlayVisual(false); loadTrack(nextIndex(), {autoPlay:true}); });


// åˆå§‹è¼‰å…¥ä¸€æ¬¡ï¼ˆä¸è‡ªå‹•æ’­ï¼‰
loadTrack(bgmIndex, {autoPlay:false});

// ===================================================
//    ğŸ”‡ è‡ªå‹• Duckï¼šä»»ä½• <video> æ’­æ”¾å°±æš«åœ BGM
//    å…¨éƒ¨å½±ç‰‡çµæŸå¾Œï¼ˆduckSet æ¸…ç©ºï¼‰è‡ªå‹•çºŒæ’­
// ===================================================
function duckOn(videoEl){
  if (!duckSet.has(videoEl)) {
    duckSet.add(videoEl);
    // ç¬¬ä¸€æ¬¡è¢« duck æ™‚ï¼Œè¨˜ä½åŸæœ¬æ˜¯å¦åœ¨æ’­
    if (duckSet.size === 1) {
      wasPlayingBeforeDuck = !bgmAudio.paused && !bgmAudio.ended;
      if (wasPlayingBeforeDuck) {
        try{ bgmAudio.pause(); }catch(e){}
         setPlayVisual(false);
      }
    }
  }
}
function duckOff(videoEl){
  if (duckSet.has(videoEl)) {
    duckSet.delete(videoEl);
    if (duckSet.size === 0 && wasPlayingBeforeDuck) {
      // å…¨éƒ¨å½±ç‰‡éƒ½åœäº† â†’ è‡ªå‹•çºŒæ’­
      bgmAudio.play().then(()=> setPlayVisual(true))
  .catch(()=>{ /* å¯èƒ½è¢«æ“‹ï¼Œç¶­æŒæš«åœå¤–è§€ */ });
      wasPlayingBeforeDuck = false;
    }
  }
}
function attachDuck(video){
  if (!video || video.__duckBound) return;
  video.__duckBound = true;
  video.addEventListener('play',  ()=>duckOn(video));
  // å½±ç‰‡å¯èƒ½ææ—© pauseã€æˆ–æ­£å¸¸ ended
  video.addEventListener('pause', ()=>duckOff(video));
  video.addEventListener('ended', ()=>duckOff(video));
}
// å…ˆç¶ç›®å‰é é¢ä¸Šå·²å­˜åœ¨çš„æ‰€æœ‰å½±ç‰‡
document.querySelectorAll('video').forEach(attachDuck);
// å†ç”¨ MutationObserver ç¶å¾ŒçºŒå‹•æ…‹æ’å…¥çš„å½±ç‰‡ï¼ˆä¾‹å¦‚ overlay è£¡æ–°å»ºï¼‰
const mo = new MutationObserver((ms)=>{
  for (const m of ms){
    m.addedNodes && m.addedNodes.forEach(node=>{
      if (node instanceof HTMLVideoElement) attachDuck(node);
      if (node.querySelectorAll){
        node.querySelectorAll('video').forEach(attachDuck);
      }
    });
  }
});
mo.observe(document.documentElement, {subtree:true, childList:true});




const sp = new URLSearchParams(location.search);
const presetRoom   = sp.get('room') || '';
el.room.value = presetRoom; el.roomLbl.textContent = presetRoom || 'â€”';
const presetName   = sp.get('name') || '';
el.name.value = presetName;
const presetAvatar = Number(sp.get('avatar') || '1') || 1;
const presetN      = Math.max(2, Math.min(8, Number(sp.get('n') || '4') || 4));

const serverURL = sp.get('server') || undefined;
const socket = io(serverURL, { transports:['websocket'] });
let me = { roomId: presetRoom || 'op-001', playerId: null, secret: localStorage.getItem('opSecret')||'' };
let state = null;
let _finalRedirecting = false; 

/* === æ–°å¢ï¼šå¿«é–ƒç‹€æ…‹å…¨åŸŸè®Šæ•¸ === */
let _flashBusy = false;       // æ­£åœ¨é¡¯ç¤ºå¿«é–ƒä¸­
let _deferEnhCardId = null;   // å»¶å¾Œæ’­æ”¾å½±ç‰‡çš„ cardIdï¼ˆç­‰å¿«é–ƒçµæŸå†æ’­ï¼‰
let _silentDiscards = [];
let _enhSignal = null;    // EMIT enh_fx è¨Šè™Ÿï¼šåªåœ¨æ­¤å¡è¢«æ‰“å‡ºæ™‚æ‰å…è¨±æ’­å¼·åŒ–å½±ç‰‡

// === äº‹ä»¶æµï¼ˆæ—¥èªŒï¼‰ ===
let feed = [];          // é€™å€‹é™£åˆ—å°±æ˜¯ç•«é¢ä¸Šé¡¯ç¤ºçš„å°å±€æ—¥èªŒ
let _seenRound = null;  // å·²é¡¯ç¤ºçš„è¼ªæ¬¡
let _seenSrvLen = 0;    // å·²åŒæ­¥çš„ server log è¡Œæ•¸

let localPending = null; // â˜… æœ¬åœ°æš«å­˜

// === ç°¡æ˜“ç‰¹æ•ˆå·¥å…· ===
function onceFx(dom, cls, delay=0){
  if(!dom) return;
  setTimeout(()=>{
    dom.classList.remove(cls);
    void dom.offsetWidth;
    dom.classList.add(cls);
  }, delay);
}

/* === æ“²ç¡¬å¹£å½±ç‰‡æ’­æ”¾ï¼ˆæœ¬æ©Ÿï¼Œé™„æ¡†+æ·¡å…¥æ·¡å‡ºï¼‰ === */
let _coinPlaying = false;
function playCoinFx(){
  const ov  = document.getElementById('coinOverlay');
  const vid = document.getElementById('coinVideo');
  if (!ov || !vid) return;
  if (_coinPlaying) return;          // é¿å…é‡è¤‡è§¸ç™¼
  _coinPlaying = true;

  // ğŸ‘‰ é–‹å§‹æ’­ä¹‹å‰ï¼Œå…ˆè¨˜éŒ„ã€Œç•¶ä¸‹ BGM æ˜¯å¦æ­£åœ¨æ’­æ”¾ã€
  const bgmWasPlaying =
    typeof bgmAudio !== 'undefined' &&
    bgmAudio &&
    !bgmAudio.paused &&
    !bgmAudio.ended;

  // é¡¯ç¤º overlay
  ov.classList.remove('hidden');
  ov.classList.add('show');

  // å½±ç‰‡å¾é ­ã€æ­£å¸¸éŸ³é‡
  try { vid.currentTime = 0; } catch(e){}
  vid.volume = 1.0;
  vid.muted  = false;

  // è‹¥ç•¶æ™‚ BGM æœ‰åœ¨æ’­ï¼Œå…ˆæš«åœä¸€ä¸‹ï¼ˆä¿éšªï¼Œå¤šä¸€å±¤è€Œå·²ï¼‰
  if (bgmWasPlaying && bgmAudio) {
    try { bgmAudio.pause(); } catch(e){}
  }

  // æ­£å¸¸æ’­å®Œ â†’ cleanup
  const onEnded = ()=> cleanup();
  vid.addEventListener('ended', onEnded, { once:true });

  let failTimer = null;
  function armFailsafe(){
    clearTimeout(failTimer);
    const dur = Number.isFinite(vid.duration) && vid.duration > 0
      ? vid.duration * 1000
      : 4000; // æ²’è®€åˆ°é•·åº¦å°±æŠ“ 4 ç§’
    failTimer = setTimeout(()=> cleanup(), dur + 500);
  }

  function cleanup(){
    clearTimeout(failTimer);

    // é—œé–‰ overlay
    ov.classList.remove('show');
    setTimeout(()=>{
      ov.classList.add('hidden');
      _coinPlaying = false;
    }, 300);

    // åœæ­¢å½±ç‰‡
    try {
      vid.pause();
      vid.currentTime = 0;
    } catch(e){}

    // æ¸…æ‰äº‹ä»¶
    vid.removeEventListener('ended', onEnded);

    // å‘Šè¨´ duck ç³»çµ±ï¼šé€™æ”¯ video ä¸ç®—åœ¨ã€Œæ­£åœ¨æ’­æ”¾ã€è£¡äº†
    try {
      if (typeof duckOff === 'function') duckOff(vid);
    } catch(e){}

    // â­ é—œéµï¼šå¦‚æœä¸€é–‹å§‹ BGM æœ‰åœ¨æ’­ï¼Œå°±å¹«ä½ çºŒæ’­
    if (bgmWasPlaying && bgmAudio) {
      bgmAudio.play().catch(()=> {
        // æœ‰äº›ç€è¦½å™¨å¯èƒ½æ“‹è‡ªå‹•æ’­æ”¾ï¼Œå°±ç®—äº†ï¼Œä¸å†å ±éŒ¯
      });
    }
  }

  // å˜—è©¦æ’­æ”¾å½±ç‰‡
  vid.play().then(()=>{
    armFailsafe();
  }).catch(()=>{
    // è‹¥æœ‰è²æ’­æ”¾è¢«ç€è¦½å™¨æ“‹æ‰ï¼Œæ”¹ç”¨éœéŸ³æ’­æ”¾ + é»æ“Šé—œé–‰
    vid.muted = true;
    vid.play().then(()=>{
      ov.addEventListener('click', ()=> cleanup(), { once:true });
      armFailsafe();
    }).catch(()=>{
      // é€£éœéŸ³éƒ½æ’­ä¸å‹• â†’ ç›´æ¥é—œæ‰ï¼Œä¸å½±éŸ¿éŠæˆ²æµç¨‹
      cleanup();
    });
  });
}

/* === å¼·åŒ–å½±ç‰‡ï¼ˆå…¨é«”åŒæ­¥æ’­æ”¾ï¼‰ === */

/* === å¼·åŒ–å½±ç‰‡ï¼ˆå…¨é«”åŒæ­¥æ’­æ”¾ï¼‰ === */
// 20 å¼µå¡çš„å¼·åŒ–å½±ç‰‡è·¯å¾‘ï¼ˆ0.mp4 ~ 19.mp4ï¼›è‹¥ä½ æœ‰è‡ªè¨‚ï¼Œæ”¹é€™è£¡å³å¯ï¼‰
const ENH_VID = Array.from({length:20}, (_,i)=> `videos/enh/${i}.mp4`);

// æ’­æ”¾æŒ‡å®šå¡çš„å¼·åŒ–å½±ç‰‡ï¼ˆå…¨é«”ï¼‰
function playEnhFxFor(cardId){
  const ov  = document.getElementById('enhOverlay');
  const vid = document.getElementById('enhVideo');
  if (!ov || !vid) return;

  const src = ENH_VID[cardId] || ENH_VID[0];
  if (vid.getAttribute('src') !== src) {
    vid.setAttribute('src', src);
    try { vid.load(); } catch(e){}
  }

  // é¡¯ç¤º overlay
  ov.classList.remove('hidden');

  // å¾é ­ + æ­£å¸¸éŸ³é‡å˜—è©¦
  try { vid.currentTime = 0; } catch(e){}
  vid.volume = 1.0;
  vid.muted  = false;

  // æ’­å®Œæˆ–é€¾æ™‚éƒ½æœƒé—œé–‰
  const onEnded = ()=> cleanup();
  vid.addEventListener('ended', onEnded, { once:true });

  let failTimer = null;
  function armFailsafe(){
    clearTimeout(failTimer);
    const dur = Number.isFinite(vid.duration) && vid.duration > 0 ? vid.duration*1000 : 5000;
    failTimer = setTimeout(()=> cleanup(), dur + 600);
  }
  function cleanup(){
    clearTimeout(failTimer);
    ov.classList.add('hidden');
    try { vid.pause(); vid.currentTime = 0; } catch(e){}
    vid.removeEventListener('ended', onEnded);
    // ç§»é™¤é»æ“Šé—œé–‰ç›£è½ï¼ˆè‹¥æœ‰ï¼‰
    const newOv = ov.cloneNode(true);
    ov.replaceWith(newOv);
  }

  // å…ˆå˜—è©¦æœ‰è²æ’­æ”¾ï¼›è‹¥è¢«ç€è¦½å™¨æ“‹ï¼Œæ”¹ç”¨éœéŸ³æ’­æ”¾ + å…è¨±é»ä¸€ä¸‹é—œé–‰
  vid.play().then(()=>{
    armFailsafe();
  }).catch(()=>{
    vid.muted = true;
    vid.play().then(()=>{
      // ä½¿ç”¨è€…é»ä¸€ä¸‹ä¹Ÿèƒ½ææ—©é—œï¼ˆé¿å…å¡ä½ï¼‰
      ov.addEventListener('click', cleanup, { once:true });
      armFailsafe();
    }).catch(()=>{
      // é€£éœéŸ³ä¹Ÿå¤±æ•— â†’ ç›´æ¥æ”¶æ‰ï¼Œé¿å…æµç¨‹é˜»å¡
      cleanup();
    });
  });
}
/* === å¼·åŒ–ç‰¹æ•ˆå·¥å…·ï¼ˆå…‰çƒï¼‰èˆ‡æ’­æ”¾è¨˜éŒ„ === */
const _enhPlayed = new Set();
let _lastRoundNo = null;

function playEnhanceFx(venueName, targetImg, cardId, key){
  if (!venueName || !targetImg) return;
  const venImg = document.querySelector(`#venues img[data-name="${venueName}"]`);
  if (!venImg) { targetImg.src = CARD_ENH(cardId); _enhPlayed.add(key); return; }

  const vr = venImg.getBoundingClientRect();
  const tr = targetImg.getBoundingClientRect();
  const sx = vr.left + vr.width/2,  sy = vr.top + vr.height/2;
  const tx = tr.left + tr.width/2,  ty = tr.top + tr.height/2;

  const orb = document.createElement('div');
  orb.className = 'fx-orb';
  orb.style.transform = `translate(${sx}px, ${sy}px) scale(1)`;
  document.body.appendChild(orb);

  requestAnimationFrame(()=>{
    orb.style.transform = `translate(${tx}px, ${ty}px) scale(1.2)`;
    setTimeout(()=>{
      targetImg.src = CARD_ENH(cardId);
      onceFx(targetImg, 'fx-glow');
      orb.style.opacity = '0';
      setTimeout(()=>{ orb.remove(); }, 220);
      _enhPlayed.add(key);
    }, 620);
  });
}

// ä¸Šä¸€æ¬¡æ¸²æŸ“çš„å¿«ç…§
let _prev = { chest: null, discardLen: 0, aliveMap: {} };

/* ========= åå­—å·¥å…· ========= */
function pname(i){
  const p = state?.players?.[i];
  if (!p) return `P${(i??0)+1}`;
  const nm = p.client?.displayName || p.displayName || '';
  return nm || `P${i+1}`;
}
function pnameBy(p){
  if (!p) return 'P?';
  const nm = p.client?.displayName || p.displayName || '';
  return nm || `P${(p.id??0)+1}`;
}

/* ========= å¡ç‰Œâ†’å ´åœ°å°ç…§èˆ‡å¼·åŒ–åˆ¤æ–· ========= */
const CARD_VENUE = {
  0:"å¾·é›·æ–¯ç¾…è–©é¬¥æŠ€å ´", 1:"è‰¾å°¼è‰¾æ–¯å¤§å»³", 2:"é˜¿æ‹‰å·´æ–¯å¦", 3:"å·´æ‹‰è’‚", 4:"ä½çƒ",
  5:"å’Œä¹‹åœ‹", 6:"é¾å…‹å“ˆè–©å¾·", 7:"ç¶­è–©åˆ©äº", 8:"é­šäººå³¶", 9:"ä¹è›‡å³¶",
  10:"é¬¼å³¶", 11:"å¤æ³¢å¸è«¸å³¶", 12:"é¬¼å³¶", 13:"å¤æ³¢å¸è«¸å³¶",
  14:"è¬åœ‹", 15:"è¬åœ‹", 16:"èœ‚å·¢å³¶", 17:"èœ‚å·¢å³¶", 18:"å¥§ç¾…å‚‘å…‹æ£®è™Ÿ", 19:"å¥§ç¾…å‚‘å…‹æ£®è™Ÿ"
};
function isEnhancedNow(cardId){
  if (cardId==null || !state?.venues) return false;
  const vn = CARD_VENUE[cardId];
  return !!state.venues.find(v=>v.name===vn);
}

/* ========= å ´åœ° â†’ èƒŒæ™¯åœ–ç‰‡å°ç…§ & åˆ‡æ›å·¥å…· ========= */
/** å ´åœ° â†’ èƒŒæ™¯åœ–ç‰‡å°ç…§ï¼ˆæª”æ¡ˆæ”¾ public/images/venues/xxx.jpg/png è‡ªè¡Œæº–å‚™ï¼‰ */
const VENUE_BG = {
  "å¾·é›·æ–¯ç¾…è–©é¬¥æŠ€å ´": "images/venues/dressrosa.jpg",
  "è‰¾å°¼è‰¾æ–¯å¤§å»³":     "images/venues/enieslobby.jpg",
  "é˜¿æ‹‰å·´æ–¯å¦":       "images/venues/alabasta.jpg",
  "å·´æ‹‰è’‚":           "images/venues/baratie.jpg",
  "ä½çƒ":             "images/venues/zou.jpg",
  "å’Œä¹‹åœ‹":           "images/venues/wano.jpg",
  "é¾å…‹å“ˆè–©å¾·":       "images/venues/punkhazard.jpg",
  "ç¶­è–©åˆ©äº":         "images/venues/weatheria.jpg",
  "é­šäººå³¶":           "images/venues/fishmanisland.jpg",
  "ä¹è›‡å³¶":           "images/venues/amazonlily.jpg",
  "é¬¼å³¶":             "images/venues/onigashima.jpg",
  "å¤æ³¢å¸è«¸å³¶":       "images/venues/sabaody.jpg",
  "è¬åœ‹":             "images/venues/wholecake.jpg",
  "èœ‚å·¢å³¶":           "images/venues/hachinosu.jpg",
  "å¥§ç¾…å‚‘å…‹æ£®è™Ÿ":     "images/venues/oro-jackson.jpg"
};
/** è‹¥ä¸Šé¢æ²’å°åˆ°ï¼Œå°±ç”¨å ´åœ°åè½‰ slug ç•¶ä½œæª”åï¼ˆä¿åº•ï¼‰ */
function venueFallbackURL(name){
  const slug = String(name||"").normalize('NFKD')
    .replace(/[\u0300-\u036f]/g, '')
    .replace(/[^\w\u4e00-\u9fff]+/g, '-')
    .replace(/-+/g,'-').replace(/^-|-$/g,'')
    .toLowerCase();
  return `images/venues/${slug}.jpg`;
}
/** ç›®å‰å¥—ç”¨çš„å ´åœ°åï¼ˆå­˜åœ¨ body çš„ data-venue ä¸Šï¼‰ */

function getCurrentVenueName(){
  return document.body.getAttribute('data-venue') || '';
}

/** v2ï¼šæŠŠåœ–ç‰‡è¨­é€² body çš„ CSS è®Šæ•¸ï¼Œå®Œå…¨ä¸å½±éŸ¿å‰æ™¯äº’å‹• */
function toggleVenueBackground(venueName){
  const current = getCurrentVenueName();

  if (current === venueName){
    // å†é»åŒä¸€å¼µ â†’ é—œé–‰ï¼Œæ¢å¾©åŸæœ¬ç´”èƒŒæ™¯
    document.body.removeAttribute('data-venue');
    document.body.classList.remove('venue-on');
    document.body.style.setProperty('--venue-bg-url', 'none');
    return;
  }

  // åˆ‡åˆ°æ–°å ´åœ°
  const url = VENUE_BG[venueName] || venueFallbackURL(venueName);
  document.body.style.setProperty('--venue-bg-url', `url("${url}")`);
  document.body.setAttribute('data-venue', venueName);
  document.body.classList.add('venue-on');
}

/** ä»ä¿ç•™ç‹€æ…‹æ ¡æ­£ï¼šæ›å±€å¾Œå¦‚æœé€™å¼µå ´åœ°ä¸åœ¨æ¸…å–®ï¼Œå°±è‡ªå‹•é—œæ‰èƒŒæ™¯ */
function reconcileVenueBackground(validVenuesArray){
  const chosen = getCurrentVenueName();
  if(!chosen) return;
  const stillValid = Array.isArray(validVenuesArray) && validVenuesArray.some(v => (v && (v.name === chosen || v.title === chosen)));
  if(!stillValid){
    // ç”¨ chosen å‘¼å«ä¸€æ¬¡æœƒé€²åˆ°ã€Œé—œé–‰ã€åˆ†æ”¯
    toggleVenueBackground(chosen);
  }
}

/** å ´åœ°å¡é»æ“Šå…¥å£ */
function onVenueClick(venueName){
  toggleVenueBackground(venueName);
}


/* ========= æ—¥èªŒ formatter ========= */
function formatLogWithNames(line){
  if(!state?.players) return line;
  return String(line).replace(/P(\d+)/g, (m, numStr)=>{
    const i = Number(numStr) - 1;
    const nm = state.players?.[i]?.client?.displayName || state.players?.[i]?.displayName;
    return nm ? `P${numStr} ${nm}` : `P${numStr}`;
  });
}

/* ========= A-1ï¼šé®ç½©æ±ºé¬¥è³‡è¨Š ========= */
function stripDuelPoints(line){
  if (!line) return line;
  let s = String(line);
  s = s.replace(/ï¼ˆ[^ï¼‰]*(å°¾æ•¸|é»æ•¸|æ•¸å­—)[^ï¼‰]*ï¼‰/g, '');
  s = s.replace(/\bå°¾æ•¸\s*\d+\s*(?:[>ï¼œ<â‰¥â‰¤=]|vs|VS)\s*\d+\b/g, '');
  s = s.replace(/\b\d+\s*(?:[>ï¼œ<â‰¥â‰¤=]|vs|VS)\s*\d+\b/g, '');
  return s.replace(/\s{2,}/g, ' ').trim();
}

/* ===== EMIT äº‹ä»¶è½‰å­—ä¸² ===== */
function msgToLogLine(e){
  if (!e) return null;
  switch(e.type){
    case 'log': return null;
    case 'duel_log': {
      const loser = (typeof e.loserId === 'number') ? pname(e.loserId) : 'æœªçŸ¥ç©å®¶';
      const card  = (typeof e.cardId  === 'number') ? `å¡ ${e.cardId}` : 'æœªçŸ¥å¡ç‰Œ';
      return `æ“Šæ•—ï¼š${loser} çš„ ${card}`;
    }
    case 'duel': {
      const L = (typeof e.leftId  === 'number') ? pname(e.leftId)  : 'ï¼Ÿ';
      const R = (typeof e.rightId === 'number') ? pname(e.rightId) : 'ï¼Ÿ';
      return `æ±ºé¬¥ï¼š${L} vs ${R}`;
    }
    case 'robin_view': {
      const t = (typeof e.targetId === 'number') ? pname(e.targetId) : 'æœªçŸ¥ç©å®¶';
      const c = (typeof e.cardId  === 'number') ? `å¡ ${e.cardId}` : 'æœªçŸ¥ç‰Œ';
      return `ï¼ˆå‡ºç‰Œè€…å¯è¦‹ï¼‰ç¾…è³“ï¼šä½ æŸ¥çœ‹äº† ${t} çš„ ${c}`;
    }
    case 'teach_cover': {
      const arr = Array.isArray(e.cards) ? e.cards : [];
      const list = arr.length ? arr.map(id=>`å¡ ${id}`).join('ã€') : 'ï¼ˆç©ºï¼‰';
      return `ï¼ˆå‡ºç‰Œè€…å¯è¦‹ï¼‰é»‘é¬å­ï¼šä½ è¦†è“‹äº† ${list}`;
    }
    case 'kata_peek': {
      const arr = Array.isArray(e.cards) ? e.cards : [];
      const list = arr.length ? arr.map(id=>`å¡ ${id}`).join('ã€') : 'ï¼ˆç©ºï¼‰';
      return `ï¼ˆå‡ºç‰Œè€…å¯è¦‹ï¼‰å¡å¡”åº«æ —ï¼šä½ çœ‹åˆ°é ‚ç‰Œ â†’ ${list}`;
    }
    case 'kata_order_done': {
      const arr = Array.isArray(e.order) ? e.order : [];
      const list = arr.length ? arr.map(id=>`å¡ ${id}`).join('ã€') : 'ï¼ˆç©ºï¼‰';
      return `ï¼ˆå‡ºç‰Œè€…å¯è¦‹ï¼‰å¡å¡”åº«æ —ï¼šä½ å·²å°‡é ‚ç‰Œæ’åºç‚º â†’ ${list}`;
    }
    case 'usopp_miss': {
      const caster = (typeof e.casterId  === 'number') ? pname(e.casterId)  : 'æœªçŸ¥ç©å®¶';
      const target = (typeof e.targetId  === 'number') ? pname(e.targetId)  : 'æœªçŸ¥ç©å®¶';
      const d = (typeof e.digit === 'number') ? e.digit : '?';
      return `é¨™äººå¸ƒï¼š${caster} çŒœ ${target} çš„å°¾æ•¸ç‚ºã€Œ${d}ã€â†’ çŒœéŒ¯`;
    }
    default: return null;
  }
}

/* ===== å»é‡æ¨å…¥ï¼ˆæ”¹ç‚ºæ¨åˆ° feedï¼‰ ===== */
function pushLogUnique(line){
  if (!line) return;
  const pretty = stripDuelPoints(formatLogWithNames(line));
  if (feed[feed.length - 1] !== pretty) feed.push(pretty);
}

/* ===== Socket é€£ç·šç‹€æ…‹ ===== */
socket.on('connect', ()=>{ el.conn.textContent='connected'; el.conn.classList.replace('text-red-400','text-green-400'); });
socket.on('disconnect', ()=>{ el.conn.textContent='disconnected'; el.conn.classList.replace('text-green-400','text-red-400'); });
socket.on('connect_error', (e)=>{ el.conn.textContent='error'; el.conn.classList.replace('text-green-400','text-red-400'); console.error(e); });

function sendAction(type, payload={}){
  if(me.playerId==null) return;
  socket.emit('ACTION', { type, payload, roomId: me.roomId, playerId: me.playerId, secret: me.secret });
}


el.join.onclick = ()=>{
  me.roomId = (el.room.value || 'op-001').trim();
  try { sessionStorage.setItem('op_room', me.roomId); } catch {}
  const displayName = (el.name.value || presetName || 'P') + Math.floor(Math.random()*100);
  el.roomLbl.textContent = me.roomId;
  socket.emit('JOIN_ROOM', { roomId: me.roomId, displayName, avatar: presetAvatar, secret: me.secret, playerCount: presetN });
};


if (presetRoom) {
  try { sessionStorage.setItem('op_room', presetRoom); } catch {}
  setTimeout(()=>{
    socket.emit('JOIN_ROOM', { roomId: me.roomId, displayName: presetName || 'P', avatar: presetAvatar, secret: me.secret, playerCount: presetN });
  }, 80);
}


const socketOnJoined = ({ playerId, secret })=>{
  me.playerId = playerId;
  me.secret = secret;
  localStorage.setItem('opSecret', secret);

  // â˜… æ–°å¢ï¼šè¨˜éŒ„è‡ªå·±åœ¨æœ¬å±€çš„ playerIdï¼Œä¾› result.html ç”¨
  try {
    sessionStorage.setItem('op_pid', playerId);
    console.log('[SESSION]', 'op_pid =', playerId);
  } catch(e){
    console.warn('sessionStorage set op_pid failed', e);
  }
};
socket.on('JOINED', socketOnJoined);


// â˜… æ–°å¢ï¼šè¨˜éŒ„è‡ªå·±åœ¨æœ¬å±€çš„ playerIdï¼Œä¾› result.html ç”¨
socket.on('JOINED', ({ playerId })=>{
  try {
    sessionStorage.setItem('op_pid', playerId);
    console.log('[SESSION]', 'op_pid=', playerId);
  } catch(e){
    console.warn('sessionStorage set op_pid failed', e);
  }
});

/* ===== æ–°å¢ï¼šshowPlayedFlashï¼ˆæ”¯æ´å¼·åŒ–å¡é¢ + çµæŸå›å‘¼ï¼‰ ===== */
function showPlayedFlash(cardId, byIndex, opt={}){
  
// è‹¥é€™å¼µæ˜¯éœé»˜æ£„ç‰Œ â†’ ä¸åšå¿«é–ƒï¼Œä¹Ÿä¸æ’ç¨‹å½±ç‰‡
if (Array.isArray(_silentDiscards) && _silentDiscards.includes(cardId)) {
  _silentDiscards = _silentDiscards.filter(x => x !== cardId);
  try { if (typeof opt === 'object' && typeof opt.onDone === 'function') opt.onDone(); } catch { }
  return;
}
const ov   = document.getElementById('playedOverlay');
  const img  = document.getElementById('playedImg');
  const meta = document.getElementById('playedMeta');
  if (!ov || !img) return;

  const isEnh = isEnhancedNow(cardId);
  img.src = isEnh ? CARD_ENH(cardId) : CARD(cardId);

  if (meta && typeof byIndex === 'number') {
    meta.textContent = `${pname(byIndex)} æ‰“å‡º`;
  }

  ov.classList.remove('hidden');
  requestAnimationFrame(()=> ov.classList.add('show'));

  setTimeout(()=>{
    ov.classList.remove('show');
    setTimeout(()=>{
      ov.classList.add('hidden');
      if (typeof opt.onDone === 'function') opt.onDone();
    }, 250);
  }, 2000);
}

/* ====== C. STATEï¼šåŒæ­¥ server çš„æ–°è¡Œã€åµæ¸¬æ–°å±€ä¸¦æ¸…ç©º + åµæ¸¬æ–°æ£„ç‰Œ â†’ å¼·åŒ–å…ˆå¿«é–ƒå¾Œæ’­ç‰‡ ====== */
socket.on('STATE', (s)=>{
  const prevTurnIndex  = (state && typeof state.turnIndex === 'number') ? state.turnIndex : null;
  const prevDiscardLen = Array.isArray(state?.discard) ? state.discard.length : 0;

  state = s;

  
 // â˜… å¯¶ç®±ç‚º 0 â†’ å¼•æ“æœƒé™„å¸¶ state.final
  if (state && state.final) {
    // å·²ç¶“è™•ç†é final å°±ä¸è¦é‡è¤‡
    if (_finalRedirecting) return;
    _finalRedirecting = true;

    // å…ˆæŠŠ final è³‡æ–™å­˜èµ·ä¾†ï¼Œresult.html æœƒç”¨
    try {
      sessionStorage.setItem('op_room', me.roomId || '');
      sessionStorage.setItem('op_final', JSON.stringify(state.final)); // â˜… å­˜æ•´ä»½è³‡æ–™
    } catch(e) {
      console.warn('sessionStorage failed', e);
    }

    const ov = document.getElementById('finalOverlay');
    if (ov) {
      // é¡¯ç¤ºã€Œå¯¶ç®±å·²ç©ºï¼Œç­‰å¾…çµç®—...ï¼‹åœ–ç‰‡ã€
      ov.classList.remove('hidden');

      // 7 ç§’å¾Œå†è·³åˆ°çµç®—é 
      setTimeout(()=>{
        const url = new URL('result.html', location.origin);
        url.searchParams.set('room', me.roomId || '');
        if (typeof me.playerId === 'number') {
          url.searchParams.set('pid', String(me.playerId));
        }
        location.href = url.toString();
      }, 7000);
    } else {
      // æ‰¾ä¸åˆ° overlay å°±ç›´æ¥è·³ï¼ˆä¿éšªï¼‰
      const url = new URL('result.html', location.origin);
      url.searchParams.set('room', me.roomId || '');
      if (typeof me.playerId === 'number') url.searchParams.set('pid', String(me.playerId));
      location.href = url.toString();
    }

    return;
  }

// 1) æ–°å±€åµæ¸¬ï¼šroundNo è®Šäº† â†’ æ¸…ç©º feedã€é‡ç½®æŒ‡æ¨™
  if (_seenRound !== state.roundNo) {
    _seenRound   = state.roundNo;
    _seenSrvLen  = 0;
    feed = []; // æ¸…ç©ºå°å±€æ—¥èªŒ
  }

  // 2) æŠŠé€™æ¬¡ STATE è£¡ã€Œserver æ–°å¢çš„è¡Œã€æ¥åˆ° feed å¾Œé¢
  const srvLog = state.log || [];
  if (_seenSrvLen < srvLog.length) {
    for (let i = _seenSrvLen; i < srvLog.length; i++) {
      const pretty = stripDuelPoints(formatLogWithNames(srvLog[i]));
      if (feed[feed.length - 1] !== pretty) feed.push(pretty);
    }
    _seenSrvLen = srvLog.length;
  }

  // 3) åµæ¸¬æ–°æ£„ç‰Œ
  const newDiscardLen = Array.isArray(state.discard) ? state.discard.length : 0;
  if (newDiscardLen > prevDiscardLen) {
    const last = state.discard[newDiscardLen - 1];
    const isBack = last && typeof last === 'object' && last.back === true;
    if (!isBack && typeof last === 'number') {
      if (isEnhancedNow(last)) {
        
if (_enhSignal && _enhSignal.cardId === last) {
  _flashBusy = true;
  showPlayedFlash(last, prevTurnIndex, {
    onDone: ()=>{
      if (typeof playEnhFxFor === 'function') {
        playEnhFxFor(last);
      } else if (typeof playEnhFx === 'function') {
        playEnhFx();
      }
      _flashBusy = false;
      _enhSignal = null;
    }
  });
} else {
  // éæ‰“å‡ºå¡ï¼ˆä¾‹å¦‚ç´¢éš†é€¼æ£„ã€è¦†è“‹é ‚ç‰Œï¼‰æˆ–æ²’æœ‰ enh_fx è¨Šè™Ÿ â†’ åƒ…å¿«é–ƒå¡é¢ï¼Œä¸æ’­å½±ç‰‡
  showPlayedFlash(last, prevTurnIndex);
}
} else {
        showPlayedFlash(last, prevTurnIndex);
      }
    }
  }

  // â˜… æ–°å¢ï¼šæ”¶åˆ°æ–°ç‹€æ…‹å¾Œæ ¡æ­£èƒŒæ™¯ï¼ˆè‹¥é¸çš„å ´åœ°å·²ä¸åœ¨æœ¬å±€å ´åœ°æ¸…å–®å°±è‡ªå‹•é—œé–‰ï¼‰
  reconcileVenueBackground(s.venues);

  render();
});

/* ====== B. EMITï¼šç§è¨Š/ç‰¹æ•ˆä¹Ÿé€² feedï¼ˆå« enh_fx æŠ‘åˆ¶/å»¶å¾Œï¼‰ ====== */
function playDuel({ leftId, rightId, leftAvatar, rightAvatar, winnerId }){
  const fx = document.getElementById('duelFx');
  const arena = fx.querySelector('.arena');
  const L = fx.querySelector('.slot.left');
  const R = fx.querySelector('.slot.right');

  L.querySelector('.ava').src = AVA(leftAvatar  ?? state?.players?.[leftId ]?.client?.avatar ?? state?.players?.[leftId ]?.avatar ?? 1);
  R.querySelector('.ava').src = AVA(rightAvatar ?? state?.players?.[rightId]?.client?.avatar ?? state?.players?.[rightId]?.avatar ?? 1);
  L.querySelector('.pid').textContent = pname(leftId ?? 0);
  R.querySelector('.pid').textContent = pname(rightId ?? 1);

  L.classList.remove('burning'); R.classList.remove('burning');
  arena.classList.remove('spread','collide');
  fx.classList.add('show');

  setTimeout(()=> arena.classList.add('spread'), 50);
  setTimeout(()=>{
    arena.classList.add('collide');
    const loserIsLeft = (winnerId === rightId);
    (loserIsLeft ? L : R).classList.add('burning');
  }, 850);
  setTimeout(()=>{
    fx.classList.remove('show');
    arena.classList.remove('spread','collide');
    L.classList.remove('burning'); R.classList.remove('burning');
  }, 1850);
}

socket.on('EMIT', (e)=>{
  

if (e.type === 'silent_discard' && Array.isArray(e.cards)) {
  _silentDiscards.push(...e.cards);
  return;
}
// è¨˜éŒ„å¼·åŒ–å½±ç‰‡è§¸ç™¼ä¿¡è™Ÿï¼ˆåªå°ã€Œæœ‰äººæ‰“å‡ºçš„é‚£å¼µã€ï¼‰
if (e.type === 'enh_fx' && typeof e.cardId === 'number') {
  _enhSignal = { cardId: e.cardId, at: Date.now() };
  return;
}
if (!e) return;

  // å…¨é«”å¼·åŒ–å½±ç‰‡ï¼šä¼ºæœå™¨å»£æ’­ e.cardId â†’ è‹¥æ­£åœ¨å¿«é–ƒä¸”åŒç‰Œï¼Œæ”¹ç”±å¿«é–ƒ onDone æ’­ï¼›å¦å‰‡ç«‹å³æ’­
  // ä¸€å¾‹å¿½ç•¥ï¼Œåœ¨ STATE â†’ showPlayedFlash çš„ onDone æ’­
  if (e.type === 'enh_fx') {
    return;
  }

  // coin_fxï¼šä¼ºæœå™¨åªä¸Ÿçµ¦ã€Œè©²æŒ‰çš„äººã€
  if (e.type === 'coin_fx') {
    playCoinFx();
    return;
  }

  // æ±ºé¬¥å‹•ç•«
  if (e.type === 'duel') {
    playDuel({ leftId: e.leftId, rightId: e.rightId, winnerId: e.winnerId });
  }

  const line = msgToLogLine(e);
  if (line) {
    const pretty = stripDuelPoints(formatLogWithNames(line));
    if (feed[feed.length - 1] !== pretty) feed.push(pretty);
    render();
  }
});


// ====== LAW & LUFFY UI helpers and socket events (added) ======
const $ = (sel)=>document.querySelector(sel);

// Local UI state for law swap
let _lawTargetId   = null;
let _lawTargetName = '';
let _lawTargetCard = null;

// Project card image resolver
function cardImageURL(cardId){
  return (typeof CARD_IMG === 'function')
    ? CARD_IMG(cardId)
    : (typeof CARD === 'function' ? CARD(cardId) : `images/cards/${cardId}.png`);
}

// Open/Close modals
function openLawSwap(targetId, cardId){
  _lawTargetId   = targetId;
  _lawTargetCard = cardId;

  const nameEl = $('#lawTargetName');
  if (nameEl){
    // Prefer state.players nickname if available
    if (Array.isArray(state?.players) && state.players[targetId]) {
      const nm = state.players[targetId].client?.displayName || state.players[targetId].displayName;
      nameEl.textContent = nm ? `P${targetId+1} ${nm}` : `P${targetId+1}`;
    } else {
      nameEl.textContent = `P${(targetId+1)}`;
    }
  }

  const img = $('#lawTargetImg');
  if (img) img.src = cardImageURL(cardId);

  $('#lawSwapModal')?.classList.remove('hidden');
}
function closeLawSwap(){
  $('#lawSwapModal')?.classList.add('hidden');
  _lawTargetId = null; _lawTargetCard = null;
}

function openLuffyBoost(){
  $('#luffyBoostModal')?.classList.remove('hidden');
}
function closeLuffyBoost(){
  $('#luffyBoostModal')?.classList.add('hidden');
}

// Bind buttons
$('#lawSwapCancel')?.addEventListener('click', ()=>{
  closeLawSwap();
  // cancel â†’ PICK_CANCEL
  socket.emit('ACTION', {
    roomId: me.roomId, playerId: me.playerId, secret: me.secret,
    type: 'PICK_CANCEL'
  });
});
$('#lawSwapOk')?.addEventListener('click', ()=>{
  const target = _lawTargetId;
  closeLawSwap();
  // confirm swap â†’ PICK_TARGET with swap:true
  socket.emit('ACTION', {
    roomId: me.roomId, playerId: me.playerId, secret: me.secret,
    type: 'PICK_TARGET',
    payload: { target, swap: true }
  });
});
$('#luffyBoostGo')?.addEventListener('click', ()=>{
  closeLuffyBoost();
  // commit boost
  socket.emit('ACTION', {
    roomId: me.roomId, playerId: me.playerId, secret: me.secret,
    type: 'LUFFY_BOOST_COMMIT',
    payload: { go: true }
  });
});

// Extra EMIT hooks
socket.on('EMIT', (e)=>{
  if (!e) return;
  // Law (boosted) view result â†’ prompt swap (only caster receives)
  if (e.type === 'law_view' && e.cardId != null && e.targetId != null){
    openLawSwap(e.targetId, e.cardId);
    return;
  }
  // Luffy (boost) prompt
  if (e.type === 'luffy_boost_prompt'){
    openLuffyBoost();
    return;
  }
});


/* ========= æ¸²æŸ“ ========= */
function render(){
  if(!state) return;

  const left = state.deck?.length ?? 0;
el.deckCnt.textContent = left;

 // å°‘æ–¼ 14 â†’ è®“ç‰Œå †æŒ‰éˆ•ç´…å…‰å¾®é–ƒï¼›åä¹‹ç§»é™¤
 if (el.deckBtn) {
   if (left < 14) el.deckBtn.classList.add('hot');
   else           el.deckBtn.classList.remove('hot');
 }

// æƒ³è¦æ•¸å­—è®Šå‹•æ™‚æœ‰å°å½ˆè·³æ•ˆæœï¼Œå¯åŠ ä¸Šé€™è¡Œï¼ˆå¯é¸ï¼‰
onceFx?.(el.deckCnt, 'fx-pulse');

  el.turnLbl.textContent = (state.turnIndex!=null) ? `P${state.turnIndex+1}` : 'â€”';
  el.stepLbl.textContent = state.turnStep || 'â€”';

  // å¯¶ç®±é‡‘å¹£é¡¯ç¤ºï¼ˆå„ªå…ˆ chestCoinsï¼‰
  let chest = state.chestCoins;
  if (typeof chest !== 'number') {
    const cands = [ state.chestLeft, state.chest, state.treasure, state.bank, state.pot, state.meta?.chest, state.meta?.treasure, state.meta?.bank, state.meta?.pot ];
    for (const v of cands){
      if (typeof v === 'number') { chest = v; break; }
      if (v && typeof v.coins  === 'number') { chest = v.coins;  break; }
      if (v && typeof v.amount === 'number') { chest = v.amount; break; }
      if (v && typeof v.value  === 'number') { chest = v.value;  break; }
    }
    if (typeof chest !== 'number') chest = 0;
  }
  if (el.chestLbl) el.chestLbl.textContent = chest;
  if (_prev.chest !== null && _prev.chest !== chest) onceFx(el.chestLbl, 'fx-pulse');
  _prev.chest = chest;

  // å ´åœ°ï¼ˆæ”¹ï¼šå¤–å±¤ç¶ onclick â†’ onVenueClick('å ´åœ°å')ï¼‰
  el.venues.innerHTML='';
  (state.venues||[]).forEach(v=>{
    const d=document.createElement('div');
    d.className='venue-card rounded overflow-hidden border border-[#2a2f35] cursor-pointer';
    d.setAttribute('data-venue', v.name);
    d.setAttribute('onclick', `onVenueClick('${v.name}')`);
    const im=document.createElement('img');
    im.src=VEN(v.name); im.alt=v.name; im.dataset.name = v.name;
    d.appendChild(im);
    el.venues.appendChild(d);
  });

  // æ£„ç‰Œï¼ˆç§˜å¯†æ£„ç‰Œï¼å¡èƒŒï¼‰
  el.discard.innerHTML='';
  (state.discard||[]).forEach(item=>{
    const im=document.createElement('img');
    im.className='thumb';
    const isBack = (item && typeof item === 'object' && item.back === true);
    im.src = isBack ? 'images/cards/back.png' : CARD(item);
    el.discard.appendChild(im);
  });
  const nowLen = (state.discard || []).length;
  if (nowLen > _prev.discardLen) {
    const imgs = el.discard.querySelectorAll('img');
    const last = imgs[imgs.length - 1];
    onceFx(last, 'fx-flip');
  }
  _prev.discardLen = nowLen;

  // ç©å®¶
  el.players.innerHTML='';
  (state.players||[]).forEach((p)=>{
    const isTurn = state.turnIndex===p.id; const isMe = me.playerId===p.id;
    const box = document.createElement('div');
    box.className = `p-3 rounded-xl border ${isTurn?'border-amber-400':'border-[#2a2f35]'} bg-[#12161b] ${isTurn?' current':''}`;
    box.innerHTML = `
      <div class="flex items-center gap-3">
        <img class="w-12 h-12 rounded-full border border-[#2a2f35]" src="${AVA(p?.client?.avatar ?? p?.avatar)}"/>
        <div class="grow">
          <div class="flex items-center justify-between">
            <div class="font-semibold">
              ${pnameBy(p)}
              ${!p.alive ? '<span class="ml-1 text-neutral-400">ï¼ˆå‡ºå±€ï¼‰</span>' : ''}
            </div>
            <div class="text-xs text-neutral-400">é‡‘å¹£ <span class="text-amber-300 font-bold">${p.gold||0}</span></div>
          </div>
          <div class="flex gap-1 mt-1 text-[11px] text-neutral-300">
            ${p.protected?'<span class="px-2 py-0.5 rounded border border-[#2a2f35]">ğŸ›¡ ä¿è­·</span>':''}
            ${p.dodging?'<span class="px-2 py-0.5 rounded border border-[#2a2f35]">ğŸŒ€ é–ƒé¿</span>':''}
            ${p.frozen?'<span class="px-2 py-0.5 rounded border border-[#2a2f35]">â„ å‡çµ</span>':''}
            ${p.skipNext?'<span class="px-2 py-0.5 rounded border border-[#2a2f35]">âš¡ éº»ç—º</span>':''}
            ${p.iceArmed?'<span class="px-2 py-0.5 rounded border border-[#2a2f35]">ğŸ§Š æª¢æŸ¥</span>':''}
            ${(!p.protected&&!p.dodging&&!p.frozen&&!p.skipNext&&!p.iceArmed)?'<span class="opacity-50">â€”</span>':''}
          </div>
          ${isMe? `<div class="mt-2 flex items-center gap-1 text-[11px] text-neutral-400">
             ${p.hand!=null?`<img class="thumb-sm" src="${isEnhancedNow(p.hand)? CARD_ENH(p.hand) : CARD(p.hand)}"/>`:''}
             ${p.tempDraw!=null?`<span>/</span><img class="thumb-sm" src="${isEnhancedNow(p.tempDraw)? CARD_ENH(p.tempDraw) : CARD(p.tempDraw)}"/>`:''}
          </div>`:''}
        </div>
      </div>`;
    el.players.appendChild(box);

    const wasAlive = _prev.aliveMap[p.id];
    if (typeof wasAlive === 'boolean' && wasAlive && !p.alive) onceFx(box, 'fx-shake');
    _prev.aliveMap[p.id] = !!p.alive;
  });

  // è‡ªå·±çš„å‡ºç‰Œå€
  const my = state.players?.[me.playerId];
  const canDraw = state.turnStep==='draw' && state.turnIndex===me.playerId;
  el.deckBtn.disabled = !canDraw; el.deckBtn.style.opacity = canDraw?1:.6;

  const canChoose = state.turnStep==='choose' && state.turnIndex===me.playerId && my;
  el.playZone.classList.toggle('hidden', !canChoose);
  if (canChoose) {
    if (_lastRoundNo !== state.roundNo) { _enhPlayed.clear(); _lastRoundNo = state.roundNo; }

    if (my.hand != null) {
      const key = `${state.roundNo}:${me.playerId}:hand:${my.hand}`;
      const enhanced = isEnhancedNow(my.hand);
      el.imgHand.src = (enhanced && _enhPlayed.has(key)) ? CARD_ENH(my.hand) : CARD(my.hand);
      if (enhanced && !_enhPlayed.has(key)) {
        const vn = CARD_VENUE[my.hand];
        setTimeout(()=> playEnhanceFx(vn, el.imgHand, my.hand, key), 120);
      }
    } else {
      el.imgHand.src = '';
    }

    if (my.tempDraw != null) {
      const key2 = `${state.roundNo}:${me.playerId}:drawn:${my.tempDraw}`;
      const enhanced2 = isEnhancedNow(my.tempDraw);
      el.imgDrawn.src = (enhanced2 && _enhPlayed.has(key2)) ? CARD_ENH(my.tempDraw) : CARD(my.tempDraw);
      if (enhanced2 && !_enhPlayed.has(key2)) {
        const vn2 = CARD_VENUE[my.tempDraw];
        setTimeout(()=> playEnhanceFx(vn2, el.imgDrawn, my.tempDraw, key2), 180);
      }
    } else {
      el.imgDrawn.src = '';
    }
  }

  /* ====== D. render()ï¼šç”¨ feed ç•«ç•«é¢ ====== */
  el.log.innerHTML = '';
  feed.forEach(line=>{
    const li = document.createElement('li');
    li.textContent = line;
    el.log.appendChild(li);
  });

  // ä¸‹ä¸€å±€æŒ‰éˆ•ï¼ˆä¾ viewerCanNextï¼‰
  el.nextRound.classList.toggle('hidden', !(state.allowNextRound && state.viewerCanNext === true));

  renderPending();
}

/* ===== å…¼å®¹ï¼šè‹¥å¤–éƒ¨é‚„èª¿ç”¨ addMsg()ï¼Œæ²¿ç”¨ feed ===== */
function addMsg(e){
  if (!e || e.type === 'peek' || e.type === 'toast') return;
  const line = msgToLogLine(e);
  if (!line) return;
  pushLogUnique(line);
  render();
}

/* =======================
   PENDINGï¼ˆå«é¨™äººå¸ƒä¿®æ­£ & é­¯å¤«/ç¾…/åŸºæ‹‰/å¤§åª½æµç¨‹ï¼‰
   ======================= */
function renderPending(){
  const srvP = state?.pending;
  if (!srvP){ localPending = null; hideModal(); return; }

  let actorId = state.turnIndex;
  if ((srvP.action === 'bigmom-pay' || srvP.action === 'queen') && typeof srvP.target === 'number') {
    actorId = srvP.target;
  }
  if (actorId !== me.playerId){ localPending = null; hideModal(); return; }

  // USOPP
  if (srvP.action === 'usopp') {
    if (srvP.extra?.target != null) {
      localPending = null;
      return showDigits('é¸æ“‡å°¾æ•¸ï¼ˆä¸èƒ½é¸ 1ï¼‰', (d)=>{
        sendAction('PICK_DIGIT',{ digit:d });
        localPending = null;
      }, { ban:[1] });
    }
    if (localPending && localPending.action==='usopp' && localPending.stage==='digit' && Number.isInteger(localPending.target)) {
      return showDigits('é¸æ“‡å°¾æ•¸ï¼ˆä¸èƒ½é¸ 1ï¼‰', (d)=>{
        sendAction('PICK_DIGIT',{ digit:d });
        localPending = null;
      }, { ban:[1] });
    }
    return showTarget('é¸æ“‡è¦çŒœçš„å°è±¡', (i)=>{
      sendAction('PICK_TARGET',{ target:i });
      localPending = { action:'usopp', stage:'digit', target:i, at:Date.now() };
      showDigits('é¸æ“‡å°¾æ•¸ï¼ˆä¸èƒ½é¸ 1ï¼‰', (d)=>{
        sendAction('PICK_DIGIT',{ digit:d });
        localPending = null;
      }, { ban:[1] });
    }, { allowSelf:false });
  }

  // é­¯å¤«
  if (srvP.action === 'luffy') {
    const firstDone = !!(srvP.extra && srvP.extra.firstDone);
    if (!firstDone) {
      return showTarget('é¸æ“‡ç¬¬ä¸€ä½å°è±¡', (i)=>{ sendAction('PICK_TARGET', { target:i }); }, { allowSelf:false });
    }
    return showTargetWithCancel('å†é¸ä¸€ä½ï¼ˆæˆ–å–æ¶ˆç•¥éï¼‰', (i)=>{
      sendAction('LUFFY_SECOND', { target:i });
    }, ()=>{ sendAction('LUFFY_SECOND', { target:-1 }); }, { allowSelf:false });
  }

 // ç¾…ï¼ˆLawï¼‰
if (srvP.action === 'law') {
  const boosted = !!(srvP.extra && srvP.extra.boost);
  if (boosted) {
    // ç¬¬äºŒéšæ®µï¼šå·²é¸å¥½å°è±¡ â†’ é¡¯ç¤ºå°æ–¹æ‰‹ç‰Œ + æ˜¯å¦äº¤æ›
    if (localPending && localPending.action === 'law' && localPending.stage === 'confirm' && Number.isInteger(localPending.target)) {
      const tid = localPending.target;
      const tp = state.players?.[tid];
      const tcard = (tp && typeof tp.hand === 'number') ? tp.hand : null;
      const img = tcard != null ? (isEnhancedNow(tcard) ? CARD_ENH(tcard) : CARD(tcard)) : 'images/cards/back.png';
      const html = `
        <div class="text-lg font-semibold mb-3">ä½ æŸ¥çœ‹äº† ${pname(tid)} çš„æ‰‹ç‰Œ</div>
        <div class="flex justify-center mb-4">
          <img src="${img}" alt="hand" class="w-[min(40vw,260px)] rounded-lg border border-[#2a2f35] shadow-xl"/>
        </div>
        <div class="text-base mb-3">è¦èˆ‡ ${pname(tid)} äº¤æ›æ‰‹ç‰Œå—ï¼Ÿ</div>
        <div class="flex justify-end gap-2">
          <button id="noBtn" class="px-3 py-1.5 rounded-lg border border-[#2a2f35]">ä¸äº¤æ›</button>
          <button id="yesBtn" class="px-3 py-1.5 rounded-lg border border-amber-400 bg-amber-300 text-black">äº¤æ›</button>
        </div>`;
      showModal(html);
      const yesBtn = el.modal.querySelector('#yesBtn');
      const noBtn  = el.modal.querySelector('#noBtn');
      yesBtn.onclick = ()=>{ sendAction('PICK_TARGET', { target: tid, swap: true }); localPending = null; hideModal(); };
      noBtn.onclick  = ()=>{ sendAction('PICK_CANCEL'); localPending = null; hideModal(); };
      return;
    }

    // ç¬¬ä¸€éšæ®µï¼šé¸æ“‡æŸ¥çœ‹ç›®æ¨™
    return showTarget('é¸æ“‡è¦æŸ¥çœ‹/å¯é¸æ“‡äº¤æ›çš„å°è±¡', (i)=>{
      sendAction('PICK_TARGET', { target: i });
      localPending = { action:'law', stage:'confirm', target:i, at:Date.now() };
      const tp = state.players?.[i];
      const tcard = (tp && typeof tp.hand === 'number') ? tp.hand : null;
      const img = tcard != null ? (isEnhancedNow(tcard) ? CARD_ENH(tcard) : CARD(tcard)) : 'images/cards/back.png';
      const html = `
        <div class="text-lg font-semibold mb-3">ä½ æŸ¥çœ‹äº† ${pname(i)} çš„æ‰‹ç‰Œ</div>
        <div class="flex justify-center mb-4">
          <img src="${img}" alt="hand" class="w-[min(40vw,260px)] rounded-lg border border-[#2a2f35] shadow-xl"/>
        </div>
        <div class="text-base mb-3">è¦èˆ‡ ${pname(i)} äº¤æ›æ‰‹ç‰Œå—ï¼Ÿ</div>
        <div class="flex justify-end gap-2">
          <button id="noBtn" class="px-3 py-1.5 rounded-lg border border-[#2a2f35]">ä¸äº¤æ›</button>
          <button id="yesBtn" class="px-3 py-1.5 rounded-lg border border-amber-400 bg-amber-300 text-black">äº¤æ›</button>
        </div>`;
      showModal(html);
      const yesBtn = el.modal.querySelector('#yesBtn');
      const noBtn  = el.modal.querySelector('#noBtn');
      yesBtn.onclick = ()=>{ sendAction('PICK_TARGET', { target: i, swap: true }); localPending = null; hideModal(); };
      noBtn.onclick  = ()=>{ sendAction('PICK_CANCEL'); localPending = null; hideModal(); };
    }, { allowSelf:false });
  }

  // éå¼·åŒ–ç¾…ï¼ˆæ™®é€šäº¤æ›ï¼‰
  return showTarget('é¸æ“‡äº¤æ›å°è±¡', (i)=> sendAction('PICK_TARGET', { target:i }), { allowSelf:false });
}


  // åŸºæ‹‰ï¼ˆKillerï¼‰
  if (srvP.action === 'killer') {
    const boosted = !!(srvP.extra && srvP.extra.boost);

    if (boosted) {
      if (
        localPending &&
        localPending.action === 'killer' &&
        localPending.stage === 'confirm' &&
        Number.isInteger(localPending.target)
      ) {
        const tid = localPending.target;
        const tp = state.players?.[tid];
        const stillDef = !!(tp && (tp.protected || tp.dodging));

        return showYesNo(
          stillDef
            ? `è¦èˆ‡ ${pname(tid)} æ±ºé¬¥å—ï¼Ÿï¼ˆä»–åŸæœ¬æœ‰é˜²ç¦¦ï¼Œå·²å˜—è©¦è§£é™¤ï¼‰`
            : `è¦èˆ‡ ${pname(tid)} æ±ºé¬¥å—ï¼Ÿï¼ˆç›®å‰çœ‹ä¸åˆ°ä¿è­·/é–ƒé¿ï¼‰`,
          'æ±ºé¬¥',
          'ä¸æ±ºé¬¥',
          ()=>{
            sendAction('PICK_TARGET', { target: tid, duel: true });
            localPending = null;
            hideModal();
          },
          ()=>{
            sendAction('PICK_CANCEL');
            localPending = null;
            hideModal();
          }
        );
      }

      return showTarget(
        'é¸æ“‡å°è±¡ï¼ˆå°‡å…ˆè§£é™¤å…¶ä¿è­·/é–ƒé¿ï¼Œç„¶å¾Œå¯é¸æ“‡æ˜¯å¦æ±ºé¬¥ï¼‰',
        (i)=>{
          sendAction('PICK_TARGET', { target: i });
          localPending = { action:'killer', stage:'confirm', target:i, at:Date.now() };

          const tp = state.players?.[i];
          const stillDef = !!(tp && (tp.protected || tp.dodging));

          showYesNo(
            stillDef
              ? `è¦èˆ‡ ${pname(i)} æ±ºé¬¥å—ï¼Ÿï¼ˆä»–åŸæœ¬æœ‰é˜²ç¦¦ï¼Œå·²å˜—è©¦è§£é™¤ï¼‰`
              : `è¦èˆ‡ ${pname(i)} æ±ºé¬¥å—ï¼Ÿï¼ˆç›®å‰çœ‹ä¸åˆ°ä¿è­·/é–ƒé¿ï¼‰`,
            'æ±ºé¬¥',
            'ä¸æ±ºé¬¥',
            ()=>{
              sendAction('PICK_TARGET', { target: i, duel: true });
              localPending = null;
              hideModal();
            },
            ()=>{
              sendAction('PICK_CANCEL');
              localPending = null;
              hideModal();
            }
          );
        },
        { allowSelf:false }
      );
    }

    return showTarget(
      'é¸æ“‡å°è±¡ï¼ˆå°‡è§£é™¤å…¶ä¿è­·/é–ƒé¿ï¼‰',
      (i)=>{
        sendAction('PICK_TARGET', { target:i });
        hideModal();
      },
      { allowSelf:false }
    );
  }

  // å¤§åª½ï¼ˆå¼·åŒ–ï¼‰â€” å…ˆç”±å‡ºç‰Œè€…é¸ç›®æ¨™
  if (srvP.action === 'bigmom') {
    return showTarget('é¸æ“‡ä¸€ä½ç©å®¶ï¼ˆäº¤ 1 é‡‘å¹£æˆ–æ·˜æ±°ç”±å°æ–¹æ±ºå®šï¼‰', (i)=>{ sendAction('PICK_TARGET', { target: i }); }, { allowSelf: false });
  }

  // å¤§åª½ï¼ˆå¼·åŒ–ï¼‰â€” ç›®æ¨™çš„æœ€çµ‚é¸æ“‡
  if (srvP.action === 'bigmom-pay') {
    const target = srvP.target;
    const isMe = (me.playerId === target);
    if (!isMe) { hideModal(); return; }
    const my = state.players?.[me.playerId];
    const canPay = (my && (my.gold || 0) > 0);

    let html = `<div class="text-lg font-semibold mb-2">å¤§åª½ï¼ˆè¬åœ‹ï¼‰ï¼šé¸æ“‡äº¤å‡º 1 é‡‘å¹£ï¼Œæˆ–ç›´æ¥æ·˜æ±°</div>
      <div class="flex justify-end gap-2">
        <button id="dieBtn" class="px-3 py-1.5 rounded-lg border border-[#2a2f35]">æ·˜æ±°</button>
        <button id="payBtn" class="px-3 py-1.5 rounded-lg border ${canPay?'border-amber-400 bg-amber-300 text-black':'border-[#22272d] opacity-40 cursor-not-allowed'}" ${canPay?'':'disabled'}>äº¤å‡º 1 é‡‘å¹£</button>
      </div>`;
    showModal(html);
    const payBtn = el.modal.querySelector('#payBtn');
    const dieBtn = el.modal.querySelector('#dieBtn');
    if (payBtn) payBtn.onclick = ()=>{ if (!canPay) return; sendAction('BIGMOM_CHOICE', { choice:'pay' }); hideModal(); };
    if (dieBtn) dieBtn.onclick = ()=>{ sendAction('BIGMOM_CHOICE', { choice:'die' }); hideModal(); };
    return;
  }

  if(['robin','sanji','zoro','nami','kaido','aokiji','roger'].includes(srvP.action)){
    return showTarget('é¸æ“‡å°è±¡', (i)=> sendAction('PICK_TARGET',{target:i}), {allowSelf:false});
  }

  if(srvP.action==='queen'){
    return showConfirm(`æ›¿ ${pname(srvP.target)} æ“²ç¡¬å¹£`, ()=> sendAction('QUEEN_COIN'));
  }

  if(srvP.action==='bigmom-coin'){
    return showConfirm('å¤§åª½ãƒ»æ“²ç¡¬å¹£', ()=> sendAction('BIGMOM_COIN'));
  }

  if(srvP.action==='kata-order'){
    const labels=(srvP.cards||[]).map(id=>({id,label:`å¡ ${id}`}));
    return showOrder('å¡å¡”åº«æ —ï¼šæ’åºé ‚ç‰Œ', labels, (arr)=> sendAction('ORDER_COMMIT',{order:arr.map(x=>x.id)}));
  }

  if(srvP.action==='teach-multipick'){
    const labels=(srvP.cards||[]).map((id,i)=>({id,label:`(é ‚${i+1}) ${id}`}));
    return showMulti('é»‘é¬å­ï¼šè¦†è“‹å“ªäº›ï¼Ÿ', labels, (picked)=> sendAction('MULTIPICK_COMMIT',{pickedIndices:[...picked]}));
  }

  hideModal();
}

/* ====== Modal helpers ====== */
function hideModal(){ el.modal.classList.add('hidden'); el.modal.querySelector('.card').innerHTML=''; }
function showModal(inner){ el.modal.querySelector('.card').innerHTML = inner; el.modal.classList.remove('hidden'); }

/* ====== å¤šç›®æ¨™ï¼ˆä¿ç•™åŸæ¨£ï¼‰ ====== */
function showMultiTargets(title, opt, onDone){
  const { allowSelf=false, max=2 } = opt||{};
  let html = `<div class="text-lg font-semibold mb-2">${title}</div><div class="grid grid-cols-3 gap-2" id="mtGrid">`;
  (state.players||[]).forEach((p,i)=>{
    const enabled = p.alive && (allowSelf || i!==me.playerId);
    html+=`<button ${enabled?'':'disabled'} data-i="${i}" class="px-3 py-2 rounded-lg border ${enabled?'border-[#2a2f35] hover:bg-[#192028]':'border-[#22272d] opacity-40 cursor-not-allowed'}">P${i+1} ${p.protected?'ğŸ›¡':''} ${p.dodging?'ğŸŒ€':''} ${!p.alive?'âœ–':''}</button>`;
  });
  html+=`</div>
    <div class="flex justify-end gap-2 mt-3">
      <button class="px-3 py-1.5 rounded-lg border border-[#2a2f35]" onclick="document.getElementById('modal').classList.add('hidden')">å–æ¶ˆ</button>
      <button id="mtDone" class="px-3 py-1.5 rounded-lg border border-amber-400 bg-amber-300 text-black" disabled>å®Œæˆ</button>
    </div>`;
  showModal(html);

  const picked = new Set();
  const grid = el.modal.querySelector('#mtGrid');
  const done = el.modal.querySelector('#mtDone');

  grid.querySelectorAll('button[data-i]').forEach(b=>{
    b.onclick = ()=>{
      const i = Number(b.dataset.i);
      if (picked.has(i)) { picked.delete(i); b.classList.remove('border-amber-400'); }
      else { if (picked.size >= max) return; picked.add(i); b.classList.add('border-amber-400'); }
      done.disabled = (picked.size < 1);
    };
  });

  done.onclick = ()=>{ onDone([...picked]); hideModal(); };
}

/* ====== é¸äººé¢æ¿ï¼ˆé¡¯ç¤º P? åå­—ï¼‰ ====== */
function showTarget(title, onPick, opt={}){ 
  const allowSelf=!!opt.allowSelf;
  let html=`<div class="text-lg font-semibold mb-2">${title}</div><div class="grid grid-cols-3 gap-2">`;
  (state.players||[]).forEach((p,i)=>{
    const en=p.alive && (allowSelf || i!==me.playerId);
    html+=`<button ${en?'':'disabled'} data-i="${i}" class="px-3 py-2 rounded-lg border ${en?'border-[#2a2f35] hover:bg-[#192028]':'border-[#22272d] opacity-40 cursor-not-allowed'}">${pname(i)} ${p.protected?'ğŸ›¡':''} ${p.dodging?'ğŸŒ€':''} ${!p.alive?'âœ–':''}</button>`;
  });
  html+=`</div>`;
  showModal(html);
  let locked = false;
  el.modal.querySelectorAll('button[data-i]').forEach(b=> b.onclick = ()=>{
    if (locked) return; locked = true; b.disabled = true; onPick(Number(b.dataset.i));
  });
}

/* ====== å¯å–æ¶ˆé¸äººé¢æ¿ ====== */
function showTargetWithCancel(title, onPick, onCancel, opt={}){
  const allowSelf=!!opt.allowSelf;
  let html=`<div class="text-lg font-semibold mb-2">${title}</div><div class="grid grid-cols-3 gap-2">`;
  (state.players||[]).forEach((p,i)=>{
    const en=p.alive && (allowSelf || i!==me.playerId);
    html+=`<button ${en?'':'disabled'} data-i="${i}" class="px-3 py-2 rounded-lg border ${en?'border-[#2a2f35] hover:bg-[#192028]':'border-[#22272d] opacity-40 cursor-not-allowed'}">${pname(i)} ${p.protected?'ğŸ›¡':''} ${p.dodging?'ğŸŒ€':''} ${!p.alive?'âœ–':''}</button>`;
  });
  html+=`</div>
    <div class="flex justify-end gap-2 mt-3">
      <button id="btnCancel" class="px-3 py-1.5 rounded-lg border border-[#2a2f35]">å–æ¶ˆ</button>
    </div>`;
  showModal(html);
  let locked = false;
  el.modal.querySelectorAll('button[data-i]').forEach(b=> b.onclick = ()=>{
    if (locked) return; locked = true; b.disabled = true; onPick(Number(b.dataset.i));
  });
  el.modal.querySelector('#btnCancel').onclick = ()=>{ onCancel && onCancel(); hideModal(); };
}

function showDigits(title, onPick, opt={}){
  const ban=new Set(opt.ban||[]);
  let html=`<div class="text-lg font-semibold mb-2">${title}</div><div class="grid grid-cols-10 gap-1">`;
  for(let n=0;n<10;n++){
    const dis=ban.has(n);
    html+=`<button ${dis?'disabled':''} data-d="${n}" class="px-2 py-2 rounded-lg border ${dis?'border-[#22272d] opacity-40 cursor-not-allowed':'border-[#2a2f35] hover:bg-[#192028]'}">${n}</button>`;
  }
  html+=`</div>`;
  showModal(html);
  let locked = false;
  el.modal.querySelectorAll('button[data-d]').forEach(b=> b.onclick = ()=>{
    if (locked) return; locked = true; b.disabled = true; onPick(Number(b.dataset.d));
  });
}

function showConfirm(title, onOk){
  let html =
    `<div class="text-lg font-semibold mb-2">${title}</div>` +
    `<div class="flex justify-end gap-2 mt-3">` +
      `<button id="okBtn" class="px-3 py-1.5 rounded-lg border border-amber-400 bg-amber-300 text-black">ç¢ºå®š</button>` +
    `</div>`;
  showModal(html);

  const okBtn = el.modal.querySelector('#okBtn');
  if (okBtn) {
    okBtn.onclick = () => {
      onOk();
      hideModal();
    };
  }
}

function showYesNo(title, yesText, noText, onYes, onNo){
  let html =
    `<div class="text-lg font-semibold mb-2">${title}</div>`+
    `<div class="flex justify-end gap-2">`+
      `<button id="noBtn" class="px-3 py-1.5 rounded-lg border border-[#2a2f35]">${noText}</button>`+
      `<button id="yesBtn" class="px-3 py-1.5 rounded-lg border border-amber-400 bg-amber-300 text-black">${yesText}</button>`+
    `</div>`;
  showModal(html);

  const yesBtn = el.modal.querySelector('#yesBtn');
  const noBtn  = el.modal.querySelector('#noBtn');

  if (yesBtn) yesBtn.onclick = ()=>{ if (onYes) onYes(); };
  if (noBtn)  noBtn.onclick  = ()=>{ if (onNo) onNo(); };
}

function showOrder(title, cards, onCommit){
  let html=`<div class="text-lg font-semibold mb-2">${title}</div><div class="space-y-2" id="list">`;
  cards.forEach((c,i)=>{
    html+=`<div class="flex items-center gap-2"><div class="px-2 py-1 rounded border border-[#2a2f35] grow">${c.label}</div>`
      +`<button class="px-2 py-1 rounded-lg border border-[#2a2f35]" data-up="${i}">ä¸Šç§»</button>`
      +`<button class="px-2 py-1 rounded-lg border border-[#2a2f35]" data-down="${i}">ä¸‹ç§»</button></div>`;
  });
  html+=`</div><div class="flex justify-end gap-2 mt-3"><button class="px-3 py-1.5 rounded-lg border border-[#2a2f35]" onclick="document.getElementById('modal').classList.add('hidden')">å–æ¶ˆ</button>`
    +`<button id="okOrder" class="px-3 py-1.5 rounded-lg border border-amber-400 bg-amber-300 text-black">ç¢ºå®šæ’åº</button></div>`;
  showModal(html);
  const list=cards.slice();
  el.modal.querySelectorAll('[data-up]').forEach(btn=> btn.onclick=()=>{
    const i=Number(btn.dataset.up); if(i===0) return; [list[i-1],list[i]]=[list[i],list[i-1]]; showOrder(title, list, onCommit);
  });
  el.modal.querySelectorAll('[data-down]').forEach(btn=> btn.onclick=()=>{
    const i=Number(btn.dataset.down); if(i===list.length-1) return; [list[i+1],list[i]]=[list[i],list[i+1]]; showOrder(title, list, onCommit);
  });
  el.modal.querySelector('#okOrder').onclick=()=>{ onCommit(list); hideModal(); };
}

function showMulti(title, cards, onCommit){
  let html=`<div class="text-lg font-semibold mb-2">${title}</div><div class="space-y-2">`;
  cards.forEach((c,i)=>{
    html+=`<label class="flex items-center gap-2 p-2 rounded-lg border border-[#2a2f35]"><input type="checkbox" data-i="${i}"/> <span class="px-2 py-1 rounded border border-[#2a2f35] grow">${c.label}</span></label>`;
  });
  html+=`</div><div class="flex justify-end gap-2 mt-3"><button class="px-3 py-1.5 rounded-lg border border-[#2a2f35]" onclick="document.getElementById('modal').classList.add('hidden')">å–æ¶ˆ</button>`
    +`<button id="okM" class="px-3 py-1.5 rounded-lg border border-amber-400 bg-amber-300 text-black">è¦†è“‹æ‰€é¸</button></div>`;
  showModal(html);
  el.modal.querySelector('#okM').onclick=()=>{
    const picked=new Set();
    el.modal.querySelectorAll('input[type="checkbox"][data-i]').forEach(ch=>{
      if(ch.checked) picked.add(Number(ch.dataset.i));
    });
    onCommit(picked); hideModal();
  };
}

// ç¶å®š
el.deckBtn.onclick   = ()=> sendAction('DRAW');
el.playHand.onclick  = ()=> sendAction('PLAY_CARD',{which:'hand'});
el.playDrawn.onclick = ()=> sendAction('PLAY_CARD',{which:'drawn'});
el.nextRound.onclick = ()=> sendAction('NEXT_ROUND');
</script>
</body>
</html>
